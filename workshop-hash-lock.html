<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-149147406-2"></script><script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-149147406-2');</script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script><script src="tooltips.js"></script><script src="reach-pre.js"></script><link rel="stylesheet" href="tooltips.css"><link rel="stylesheet" href="reach.css"><link rel="stylesheet" href="minted.css"><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>4.1&nbsp;Workshop: Hash Lock</title><link rel="stylesheet" type="text/css" href="scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-racket.css" title="default"/><script type="text/javascript" src="scribble-common.js"></script><script type="text/javascript" src="manual-racket.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--></head><body id="scribble-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9658;</a></td><td></td><td><a href="index.html" class="tocviewlink" data-pltdoc="x">Reach:<span class="mywbr"> &nbsp;</span> The Safest and Easiest DApp Programming Language</a></td></tr></table></div><div class="tocviewsublisttop" style="display: none;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="overview.html" class="tocviewlink" data-pltdoc="x">Overview</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="tut.html" class="tocviewlink" data-pltdoc="x">Tutorial</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="guide.html" class="tocviewlink" data-pltdoc="x">Guide</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="workshop.html" class="tocviewselflink" data-pltdoc="x">Workshop</a></td></tr><tr><td align="right">5&nbsp;</td><td><a href="ref.html" class="tocviewlink" data-pltdoc="x">Reference</a></td></tr><tr><td align="right"></td><td><a href="doc-index.html" class="tocviewlink" data-pltdoc="x">Index</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_1&quot;);">&#9660;</a></td><td>4&nbsp;</td><td><a href="workshop.html" class="tocviewlink" data-pltdoc="x">Workshop</a></td></tr></table><div class="tocviewsublist" style="display: block;" id="tocview_1"><table cellspacing="0" cellpadding="0"><tr><td align="right">4.1&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Hash Lock</a></td></tr><tr><td align="right">4.2&nbsp;</td><td><a href="workshop-trust-fund.html" class="tocviewlink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Trust Fund</a></td></tr><tr><td align="right">4.3&nbsp;</td><td><a href="workshop-rps-fair.html" class="tocviewlink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Fair Rock-<wbr></wbr>Paper-<wbr></wbr>Scissors</a></td></tr><tr><td align="right">4.4&nbsp;</td><td><a href="workshop-rps-batched.html" class="tocviewlink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Batched Rock-<wbr></wbr>Paper-<wbr></wbr>Scissors</a></td></tr><tr><td align="right">4.5&nbsp;</td><td><a href="workshop-rps-firstmsg.html" class="tocviewlink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> First Message Rock-<wbr></wbr>Paper-<wbr></wbr>Scissors</a></td></tr><tr><td align="right">4.6&nbsp;</td><td><a href="workshop-secured-loan.html" class="tocviewlink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Secured Loan</a></td></tr><tr><td align="right">4.7&nbsp;</td><td><a href="workshop-rental.html" class="tocviewlink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Rental Agreement</a></td></tr><tr><td align="right">4.8&nbsp;</td><td><a href="workshop-abstract-simul.html" class="tocviewlink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Simultaneous Games</a></td></tr><tr><td align="right">4.9&nbsp;</td><td><a href="workshop-guardian-account.html" class="tocviewlink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Guardian Account</a></td></tr><tr><td align="right">4.10&nbsp;</td><td><a href="workshop-nim.html" class="tocviewlink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Nim</a></td></tr><tr><td align="right">4.11&nbsp;</td><td><a href="workshop-ttt.html" class="tocviewlink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Tic-<wbr></wbr>Tac-<wbr></wbr>Toe</a></td></tr><tr><td align="right">4.12&nbsp;</td><td><a href="workshop-utility.html" class="tocviewlink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Periodic Payment</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_2&quot;);">&#9658;</a></td><td>4.1&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Hash Lock</a></td></tr></table><div class="tocviewsublistbottom" style="display: none;" id="tocview_2"><table cellspacing="0" cellpadding="0"><tr><td align="right">4.1.1&nbsp;</td><td><a href="#%28part._.Problem_.Analysis%29" class="tocviewlink" data-pltdoc="x">Problem Analysis</a></td></tr><tr><td align="right">4.1.2&nbsp;</td><td><a href="#%28part._.Data_.Definition%29" class="tocviewlink" data-pltdoc="x">Data Definition</a></td></tr><tr><td align="right">4.1.3&nbsp;</td><td><a href="#%28part._.Communication_.Construction%29" class="tocviewlink" data-pltdoc="x">Communication Construction</a></td></tr><tr><td align="right">4.1.4&nbsp;</td><td><a href="#%28part._.Assertion_.Insertion%29" class="tocviewlink" data-pltdoc="x">Assertion Insertion</a></td></tr><tr><td align="right">4.1.5&nbsp;</td><td><a href="#%28part._.Interaction_.Introduction%29" class="tocviewlink" data-pltdoc="x">Interaction Introduction</a></td></tr><tr><td align="right">4.1.6&nbsp;</td><td><a href="#%28part._.Deployment_.Decisions%29" class="tocviewlink" data-pltdoc="x">Deployment Decisions</a></td></tr><tr><td align="right">4.1.7&nbsp;</td><td><a href="#%28part._.Discussion%29" class="tocviewlink" data-pltdoc="x">Discussion</a></td></tr></table></div></div></div><div class="tocsub"><div class="tocsubtitle">On this page:</div><table class="tocsublist" cellspacing="0"><tr><td><span class="tocsublinknumber">4.1.1<tt>&nbsp;</tt></span><a href="#%28part._.Problem_.Analysis%29" class="tocsubseclink" data-pltdoc="x">Problem Analysis</a></td></tr><tr><td><span class="tocsublinknumber">4.1.2<tt>&nbsp;</tt></span><a href="#%28part._.Data_.Definition%29" class="tocsubseclink" data-pltdoc="x">Data Definition</a></td></tr><tr><td><span class="tocsublinknumber">4.1.3<tt>&nbsp;</tt></span><a href="#%28part._.Communication_.Construction%29" class="tocsubseclink" data-pltdoc="x">Communication Construction</a></td></tr><tr><td><span class="tocsublinknumber">4.1.4<tt>&nbsp;</tt></span><a href="#%28part._.Assertion_.Insertion%29" class="tocsubseclink" data-pltdoc="x">Assertion Insertion</a></td></tr><tr><td><span class="tocsublinknumber">4.1.5<tt>&nbsp;</tt></span><a href="#%28part._.Interaction_.Introduction%29" class="tocsubseclink" data-pltdoc="x">Interaction Introduction</a></td></tr><tr><td><span class="tocsublinknumber">4.1.6<tt>&nbsp;</tt></span><a href="#%28part._.Deployment_.Decisions%29" class="tocsubseclink" data-pltdoc="x">Deployment Decisions</a></td></tr><tr><td><span class="tocsublinknumber">4.1.7<tt>&nbsp;</tt></span><a href="#%28part._.Discussion%29" class="tocsubseclink" data-pltdoc="x">Discussion</a></td></tr></table></div></div><div class="maincolumn"><div class="main"><div class="versionbox"><span class="version">0.1.2</span></div><div class="navsettop"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="workshop.html" title="backward to &quot;4 Workshop&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="workshop.html" title="up to &quot;4 Workshop&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="workshop-trust-fund.html" title="forward to &quot;4.2 Workshop: Trust Fund&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div><h4>4.1<tt>&nbsp;</tt><a name="(part._workshop-hash-lock)"></a>Workshop: Hash Lock</h4><p>In this workshop, we&rsquo;ll design an application that allows a payer to lock funds with a secret password, independent from their <a href="ref-model.html#%28tech._consensus._network%29" class="techoutside" data-pltdoc="x"><span class="techinside">consensus network</span></a> identity, which can be drawn by anyone possessing the secret password.
This is a useful way for a payer to show that they have funds and have committed to disbursing them, without deciding beforehand who they are paying.</p><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>This workshop is independent of all others.</p></blockquote></blockquote></blockquote><p><div class="SIntrapara">We assume that you&rsquo;ll go through this workshop in a directory named <span class="stt">~/reach/workshop-hash-lock</span>:
</div><div class="SIntrapara"><span class="hspace">&nbsp;&nbsp;</span><span style="font-weight: bold"><span class="stt">$</span></span><span class="stt"> </span><span class="stt">mkdir -p ~/reach/workshop-hash-lock</span></div></p><p><div class="SIntrapara">And that you have a copy of Reach <a href="install.html" data-pltdoc="x">installed</a> in <span class="stt">~/reach</span> so you can write
</div><div class="SIntrapara"><span class="hspace">&nbsp;&nbsp;</span><span style="font-weight: bold"><span class="stt">$</span></span><span class="stt"> </span><span class="stt">../reach version</span></div></p><p>And it will run Reach.</p><p><div class="SIntrapara">You should start off by initializing your Reach program:
</div><div class="SIntrapara"><span class="hspace">&nbsp;&nbsp;</span><span style="font-weight: bold"><span class="stt">$</span></span><span class="stt"> </span><span class="stt">../reach init</span></div></p><h5>4.1.1<tt>&nbsp;</tt><a name="(part._.Problem_.Analysis)"></a>Problem Analysis</h5><p>The first step in any program design is to perform problem analysis and determine what information is relevant to the problem.
When writting decentralized applications in Reach, this information analysis includes an analysis of the set of <a href="ref-model.html#%28tech._participant%29" class="techoutside" data-pltdoc="x"><span class="techinside">participants</span></a> involved in a computation.</p><p><div class="SIntrapara">In this case, let&rsquo;s ask the questions:
</div><div class="SIntrapara"><ul><li><p>Who is involved in this application?</p></li><li><p>What information do they know at the start of the program?</p></li><li><p>What information are they going to discover and use in the program?</p></li><li><p>What funds change ownership during the application and how?</p></li></ul></div></p><p>You should write your answers in your Reach program (<span class="stt">index.rsh</span>) using a comment.
<code class="highlight"><span class="cm">/* Remember comments are written like this. */</span></code></p><blockquote class="SCentered"><p><br/><br/><br/><span style="font-weight: bold">Stop!</span><br/>Write down the problem analysis of this program as a comment.<br/><br/><br/><br/></p></blockquote><p>Let&rsquo;s see how your answers compare to our answers:</p><ul><li><p>This program involves two parties: the payer sending the funds and the receiver of those funds.
By tradition, we&rsquo;ll call the first &rsquo;Alice&rsquo; and the second &rsquo;Bob&rsquo;.
You might like to use other names, like &rsquo;Sender&rsquo; and &rsquo;Receiver&rsquo;.</p></li><li><p>Alice starts off knowing the amount she wants to send and the secret password.</p></li><li><p>Bob starts off like Jon Snow and knows nothing.</p></li><li><p>Alice doesn&rsquo;t learn anything during the execution of the program, but Bob learns the password.</p></li><li><p>Alice transfers funds at the beginning of the program and Bob receives those funds at the end, after he learns the password.</p></li></ul><p>It&rsquo;s okay if your answers are different than ours.
Problem analysis is a "loose" process that is more like creative artistry than it is like rote calculation.
But, that doesn&rsquo;t mean it is superfluous and unnecessary or unneeded.</p><p>Problem analysis is a crucial step that helps us understand what our application is supposed to be doing.
Remember, programming in general, and Reach in particular, does not solve problems for you; instead, programs encode automatic solutions to problems you&rsquo;ve already solved.
Compared to normal languages, Reach does do a bit automatically for you: it automatically discovers problems you may not have realized your program had.
You still have to solve them yourself though!
But, at least you know about them because of Reach.</p><h5>4.1.2<tt>&nbsp;</tt><a name="(part._.Data_.Definition)"></a>Data Definition</h5><p>Humans and their social systems deal with information, but computers can only interact with data, which is merely a representation of information using particular structures, like numbers, arrays, and so on.
After problem analysis, we know what information our program will deal with, but next we need to decide how to translate that information into concrete data.</p><p><div class="SIntrapara">So, for this program, we should decide:
</div><div class="SIntrapara"><ul><li><p>What data type will represent the amount Alice transfers?</p></li><li><p>What data type will represent Alice&rsquo;s password?</p></li></ul></div></p><p>After deciding those things, you should think about how the program will be provided this values.
In other words:</p><ul><li><p>What <a href="ref-programs-module.html#%28tech._participant._interact._interface%29" class="techoutside" data-pltdoc="x"><span class="techinside">participant interact interface</span></a> will each participant use?</p></li></ul><p>You should look back at your problem analysis to do this step.
Whenever a participant starts of knowing something, then it is a field in the <code class="highlight"><a href="ref-programs-local.html#%28reach._%28%28interact%29%29%29" class="k" data-pltdoc="x">interact</a></code> object.
If they learn something, then it will be an argument to a function.
If they provide something later, then it will be the result of a function.</p><p>You should write your answers in your Reach file (<span class="stt">index.rsh</span>) as the <a href="ref-programs-module.html#%28tech._participant._interact._interface%29" class="techoutside" data-pltdoc="x"><span class="techinside">participant interact interface</span></a> for each of the participants.</p><blockquote class="SCentered"><p><br/><br/><br/><span style="font-weight: bold">Stop!</span><br/>Write down the data definitions for this program as definitions.<br/><br/><br/><br/></p></blockquote><p><div class="SIntrapara">Let&rsquo;s compare notes again.
</div><div class="SIntrapara"><ul><li><p>We&rsquo;re going to represent the amount Alice transfers as an unsigned integer (<code class="highlight"><a href="ref-programs-compute.html#%28reach._%28%28.U.Int256%29%29%29" class="nb" data-pltdoc="x">UInt256</a></code>) named <code class="highlight"><font class="badlink"><span class="nx">amt</span></font></code>.</p></li><li><p>We will represent the password as another unsigned integer (<code class="highlight"><a href="ref-programs-compute.html#%28reach._%28%28.U.Int256%29%29%29" class="nb" data-pltdoc="x">UInt256</a></code>) named <code class="highlight"><font class="badlink"><span class="nx">pass</span></font></code>.</p></li><li><p>These two values are the only fields of Alice&rsquo;s interface, but Bob will have a function named <code class="highlight"><font class="badlink"><span class="nx">getPass</span></font></code> that will return the password that he knows.</p></li></ul></div></p><p>We wrote this in our program as:</p><p><div class="highlight"><pre><span></span><span class="p">[[</span><span class="s1">&#39;Alice&#39;</span><span class="p">,</span> <span class="p">{</span> <font class="badlink"><span class="nx">amt</span></font> <font class="badlink"><span class="o">:</span></font> <a href="ref-programs-compute.html#%28reach._%28%28.U.Int256%29%29%29" class="nb" data-pltdoc="x">UInt256</a><span class="p">,</span>
             <font class="badlink"><span class="nx">pass</span></font><font class="badlink"><span class="o">:</span></font> <a href="ref-programs-compute.html#%28reach._%28%28.U.Int256%29%29%29" class="nb" data-pltdoc="x">UInt256</a> <span class="p">}],</span>
 <span class="p">[</span><span class="s1">&#39;Bob&#39;</span><span class="p">,</span> <span class="p">{</span> <font class="badlink"><span class="nx">getPass</span></font><font class="badlink"><span class="o">:</span></font> <a href="ref-programs-compute.html#%28reach._%28%28.Fun%29%29%29" class="nb" data-pltdoc="x">Fun</a><span class="p">([],</span> <a href="ref-programs-compute.html#%28reach._%28%28.U.Int256%29%29%29" class="nb" data-pltdoc="x">UInt256</a><span class="p">)</span> <span class="p">}]</span> <span class="p">],</span>
</pre></div></p><p>It would be very surprising if you choose the exact same names as us in your code, but did you choose the same types?
We expect that many of you might have chosen to represent the password by a string of bytes using the Reach type, <code class="highlight"><a href="ref-programs-compute.html#%28reach._%28%28.Bytes%29%29%29" class="nb" data-pltdoc="x">Bytes</a></code>.
There&rsquo;s nothing necessarily wrong with this option, but we do not choose it because it is unnecessarily "wide".
For example, the empty string <code class="highlight"><span class="s1">&#39;&#39;</span></code> is an example of a <code class="highlight"><a href="ref-programs-compute.html#%28reach._%28%28.Bytes%29%29%29" class="nb" data-pltdoc="x">Bytes</a></code> value, as is the text of this entire document and the combined works of Jane Austen.
The <code class="highlight"><a href="ref-programs-compute.html#%28reach._%28%28.Bytes%29%29%29" class="nb" data-pltdoc="x">Bytes</a></code> type contains many options, but we are likely to be satisfied with a mere 256-bits, or 32 characters, as represented by the <code class="highlight"><a href="ref-programs-compute.html#%28reach._%28%28.U.Int256%29%29%29" class="nb" data-pltdoc="x">UInt256</a></code> type.
Have you ever had a password that was 32 characters long?</p><p>At this point, you can modify your JavaScript file (<span class="stt">index.mjs</span>) to contain defintions of these values, although you may want to use a placeholder like <code class="highlight"><span class="mf">42</span></code> or something for the actual value.
When you&rsquo;re writing a Reach program, especially in the early phases, you should have these two files open side-by-side and update them in tandem as you&rsquo;re deciding the <a href="ref-programs-module.html#%28tech._participant._interact._interface%29" class="techoutside" data-pltdoc="x"><span class="techinside">participant interact interface</span></a>.</p><h5>4.1.3<tt>&nbsp;</tt><a name="(part._.Communication_.Construction)"></a>Communication Construction</h5><p>A fundamental aspect of a decentralized application is the pattern of communication and transfer among the participants, including the consensus network.
For example, who initiates the application?
Who responds next?
Is there a repeated segment of the program that occurs over and over again?
We should explicitly write down this structure as comments in our program.
For example, for the <a href="tut.html" data-pltdoc="x">tutorial</a> version of <span class="emph">Rock, Paper, Scissors!</span>, we might write:
<div class="highlight"><pre><span></span><span class="c1">// Alice publishes the wager and pays it</span>
<span class="c1">// Bob accepts the wager and pays it</span>
<span class="c1">// While there&#39;s a draw</span>
<span class="c1">//  Alice publishes her hand secretly</span>
<span class="c1">//  Bob publishes his hand publicly</span>
<span class="c1">//  Alice reveals her hand</span>
<span class="c1">//  The consensus ensures it&#39;s the same hand as before</span>
<span class="c1">// The consensus pays out the wager</span>
</pre></div></p><p>You should do this now, in your Reach program (<span class="stt">index.rsh</span>).</p><blockquote class="SCentered"><p><br/><br/><br/><span style="font-weight: bold">Stop!</span><br/>Write down the communication pattern for this program as comments.<br/><br/><br/><br/></p></blockquote><p>This is a simple application, so we should all share the same communication pattern.
Here&rsquo;s what we wrote:
<div class="highlight"><pre><span></span><span class="c1">// Alice pays the amount</span>
<span class="c1">// Bob publishes the password</span>
<span class="c1">// The consensus ensures it&#39;s the right password and pays Bob</span>
</pre></div></p><p>However, looking at this pattern reveals a subtlety in this application:
how can the consensus ensure that Bob publishes the correct password?
The only way is for Alice to publish something first that can be checked by the consensus.
For example, we could use the pattern:
<div class="highlight"><pre><span></span><span class="c1">// Alice publishes the password and pays the amount</span>
<span class="c1">// Bob publishes the password</span>
<span class="c1">// The consensus ensures it&#39;s the right password and pays Bob</span>
</pre></div></p><p>However, this is definitely wrong, because Alice doesn&rsquo;t want to share her password with the world across the network, she only wants to share it with Bob, potentially at some later moment.
So, she should publish the password, but instead, publish a <a href="ref-model.html#%28tech._digest%29" class="techoutside" data-pltdoc="x"><span class="techinside">digest</span></a> of the password, that can be checked against the actual password later.
In other words, we should use a pattern like:
<div class="highlight"><pre><span></span><span class="c1">// Alice publishes a digest of the password and pays the amount</span>
<span class="c1">// Bob publishes the password</span>
<span class="c1">// The consensus ensures it&#39;s the right password and pays Bob</span>
</pre></div></p><p>It is cheaper to go through this iteration process in the human-centered design phase than in the code-centered programming phase, even when you&rsquo;re using a high-level language like Reach for programming.</p><p>Next, we need to convert this pattern into actual program code using <code class="highlight"><a href="ref-programs-step.html#%28reach._%28%28publish%29%29%29" class="k" data-pltdoc="x">publish</a></code>, <code class="highlight"><a href="ref-programs-step.html#%28reach._%28%28pay%29%29%29" class="k" data-pltdoc="x">pay</a></code>, and <code class="highlight"><a href="ref-programs-consensus.html#%28reach._%28%28commit%29%29%29" class="k" data-pltdoc="x">commit</a></code>.</p><blockquote class="SCentered"><p><br/><br/><br/><span style="font-weight: bold">Stop!</span><br/>Write down the communication pattern for this program as code.<br/><br/><br/><br/></p></blockquote><p>The body of your application should look something like:
<div class="highlight"><pre><span></span><span class="c1">// Alice publishes a digest of the password and pays the amount</span>
<font class="badlink"><span class="nx">Alice</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28publish%29%29%29" class="k" data-pltdoc="x">publish</a><span class="p">(</span><font class="badlink"><span class="nx">passDigest</span></font><span class="p">,</span> <font class="badlink"><span class="nx">amt</span></font><span class="p">)</span>
     <span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28pay%29%29%29" class="k" data-pltdoc="x">pay</a><span class="p">(</span><font class="badlink"><span class="nx">amt</span></font><span class="p">);</span>
<a href="ref-programs-consensus.html#%28reach._%28%28commit%29%29%29" class="k" data-pltdoc="x">commit</a><span class="p">();</span>

<span class="c1">// Bob publishes the password</span>
<font class="badlink"><span class="nx">Bob</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28publish%29%29%29" class="k" data-pltdoc="x">publish</a><span class="p">(</span><font class="badlink"><span class="nx">pass</span></font><span class="p">);</span>

<span class="c1">// The consensus ensures it&#39;s the right password and pays Bob</span>
<a href="ref-programs-consensus.html#%28reach._%28%28transfer%29%29%29" class="k" data-pltdoc="x">transfer</a><span class="p">(</span><font class="badlink"><span class="nx">amt</span></font><span class="p">).</span><font class="badlink"><span class="nx">to</span></font><span class="p">(</span><font class="badlink"><span class="nx">Bob</span></font><span class="p">);</span>
<a href="ref-programs-consensus.html#%28reach._%28%28commit%29%29%29" class="k" data-pltdoc="x">commit</a><span class="p">();</span>
</pre></div></p><p>We can now move on to the next part of designing a decentralized application: verification.</p><h5>4.1.4<tt>&nbsp;</tt><a name="(part._.Assertion_.Insertion)"></a>Assertion Insertion</h5><p>When we are programming, we hold a complex theory of the behavior of the program inside of our minds that helps us know what should happen next in the program based on what has happened before and what is true at every point in the program.
As programs become more complex, this theory becomes more and more difficult to grasp, so we might make mistakes.
Furthermore, when another programmer reads our code (such as a version of ourselves from the future trying to modify the program), it can be very difficult to understand this theory for ourselves.
<a href="ref-model.html#%28tech._assert%29" class="techoutside" data-pltdoc="x"><span class="techinside">Assert</span></a>ions are ways of encoding this theory directly into the text of the program in a way that will be checked by Reach and available to all future readers and editors of the code.</p><p>Look at your application, what are assumptions that you have about the values in the program?</p><blockquote class="SCentered"><p><br/><br/><br/><span style="font-weight: bold">Stop!</span><br/>Write down the properties you know are true about the various values in the program.<br/><br/><br/><br/></p></blockquote><p><div class="SIntrapara">There are three main assumptions we came up with for this program:
</div><div class="SIntrapara"><ul><li><p>Before Bob publishes the password, it is unknowable by him and everyone else except Alice.</p></li><li><p>Bob assumes that the password digest published by Alice matches the digest of the password he&rsquo;s publishing.</p></li><li><p>The consensus requires that Alice&rsquo;s digest and the digest of Bob&rsquo;s password match.</p></li></ul></div></p><p>We expect that the third of these is the least controversial and the most obvious property, but the others are important too.
The first property essentially guarantees that the errorneous version of the application we contemplated, where Alice directly sent her password over the network is disallowed.
The second property encodes Bob&rsquo;s assumption of good will and integrity when he submits his value: an honest version of the Bob participant would not willingly send a password that wasn&rsquo;t the correct one.
Furthermore, it is possible for any participant to check, without going through consensus, if they know what the password is.</p><p>Now that we know what the properties are, we need to encode them into our program via calls to Reach functions like <code class="highlight"><a href="ref-programs-step.html#%28reach._%28%28unknowable%29%29%29" class="k" data-pltdoc="x">unknowable</a></code>, <code class="highlight"><a href="ref-programs-local.html#%28reach._%28%28assume%29%29%29" class="k" data-pltdoc="x">assume</a></code>, and <code class="highlight"><a href="ref-programs-consensus.html#%28reach._%28%28require%29%29%29" class="k" data-pltdoc="x">require</a></code>.
Let&rsquo;s do that now.</p><blockquote class="SCentered"><p><br/><br/><br/><span style="font-weight: bold">Stop!</span><br/>Insert assertions into the program corresponding to facts that should be true.<br/><br/><br/><br/></p></blockquote><p>Here&rsquo;s what we did:</p><p><div class="highlight"><pre><span></span><span class="c1">// First</span>
<a href="ref-programs-step.html#%28reach._%28%28unknowable%29%29%29" class="k" data-pltdoc="x">unknowable</a><span class="p">(</span><font class="badlink"><span class="nx">Bob</span></font><span class="p">,</span> <font class="badlink"><span class="nx">Alice</span></font><span class="p">(</span><a href="ref-programs-local.html#%28reach._%28%28interact%29%29%29" class="k" data-pltdoc="x">interact</a><span class="p">.</span><font class="badlink"><span class="nx">pass</span></font><span class="p">));</span>

<font class="badlink"><span class="nx">Bob</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28only%29%29%29" class="k" data-pltdoc="x">only</a><span class="p">(()</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a> <span class="p">{</span>
 <span class="c1">// Second</span>
 <a href="ref-programs-local.html#%28reach._%28%28assume%29%29%29" class="k" data-pltdoc="x">assume</a><span class="p">(</span> <font class="badlink"><span class="nx">passDigest</span></font> <a href="ref-programs-compute.html#%28reach._%28%28~3d~3d%29%29%29" class="o" data-pltdoc="x">==</a> <a href="ref-programs-compute.html#%28reach._%28%28digest%29%29%29" class="nb" data-pltdoc="x">digest</a><span class="p">(</span><font class="badlink"><span class="nx">pass</span></font><span class="p">)</span> <span class="p">);</span> <span class="p">});</span>
<font class="badlink"><span class="nx">Bob</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28publish%29%29%29" class="k" data-pltdoc="x">publish</a><span class="p">(</span><font class="badlink"><span class="nx">pass</span></font><span class="p">);</span>

<span class="c1">// Third</span>
<a href="ref-programs-consensus.html#%28reach._%28%28require%29%29%29" class="k" data-pltdoc="x">require</a><span class="p">(</span> <font class="badlink"><span class="nx">passDigest</span></font> <a href="ref-programs-compute.html#%28reach._%28%28~3d~3d%29%29%29" class="o" data-pltdoc="x">==</a> <a href="ref-programs-compute.html#%28reach._%28%28digest%29%29%29" class="nb" data-pltdoc="x">digest</a><span class="p">(</span><font class="badlink"><span class="nx">pass</span></font><span class="p">)</span> <span class="p">);</span>
<a href="ref-programs-consensus.html#%28reach._%28%28transfer%29%29%29" class="k" data-pltdoc="x">transfer</a><span class="p">(</span><font class="badlink"><span class="nx">amt</span></font><span class="p">).</span><font class="badlink"><span class="nx">to</span></font><span class="p">(</span><font class="badlink"><span class="nx">Bob</span></font><span class="p">);</span>
<a href="ref-programs-consensus.html#%28reach._%28%28commit%29%29%29" class="k" data-pltdoc="x">commit</a><span class="p">();</span>
</pre></div></p><ul><li><p>First, we assert that Bob can&rsquo;t know Alice&rsquo;s password, <span class="emph">based on what the Reach program does</span>.</p></li><li><p>Next, we assert that Bob believes his password is correct (and that an honest Bob will check it.)</p></li><li><p>Finally, we assert that the consensus can only continue if this is the case.</p></li></ul><p>At this point, we are almost ready to complete our program and make it so that we can run it.
You&rsquo;ve probably noticed that in our samples, the variables <code class="highlight"><font class="badlink"><span class="nx">pass</span></font></code>, <code class="highlight"><font class="badlink"><span class="nx">amt</span></font></code>, and <code class="highlight"><font class="badlink"><span class="nx">passDigest</span></font></code> are undefined.
We&rsquo;ll handle that next.</p><h5>4.1.5<tt>&nbsp;</tt><a name="(part._.Interaction_.Introduction)"></a>Interaction Introduction</h5><p>A key concept of Reach programs is that they are concerned solely with the communication and consensus portions of a decentralized applications.
<a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">Frontends</span></a> are responsible for all other aspects of the program.
Thus, eventually a Reach programs needs to insert calls into their code to send data to and from the <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a> via the <a href="ref-programs-module.html#%28tech._participant._interact._interface%29" class="techoutside" data-pltdoc="x"><span class="techinside">participant interact interface</span></a>s that they defined during the <span class="emph">Data Definition</span> step.</p><p>In our program, that means defining <code class="highlight"><font class="badlink"><span class="nx">amt</span></font></code> and <code class="highlight"><font class="badlink"><span class="nx">passDigest</span></font></code> by Alice and <code class="highlight"><font class="badlink"><span class="nx">pass</span></font></code> by Bob.
Do that now.</p><blockquote class="SCentered"><p><br/><br/><br/><span style="font-weight: bold">Stop!</span><br/>Insert <code class="highlight"><a href="ref-programs-local.html#%28reach._%28%28interact%29%29%29" class="k" data-pltdoc="x">interact</a></code> calls to the <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a> into the program.<br/><br/><br/><br/></p></blockquote><p>Here&rsquo;s what we did:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/workshop-hash-lock/index.rsh"><span class="stt">workshop-hash-lock/index.rsh</span></a><button class="btn" data-clipboard-text="'reach 0.1';

export const main = Reach.App(
  { deployMode: 'firstMsg' },
  [['Alice', { amt : UInt256,
               pass: UInt256 }],
   ['Bob', { getPass: Fun([], UInt256) }] ],
  (Alice, Bob) =&gt; {
    Alice.only(() =&gt; {
      const [ amt, passDigest ] =
            declassify([ interact.amt,
                         digest(interact.pass) ]); });
    Alice.publish(passDigest, amt)
      .pay(amt);
    commit();

    unknowable(Bob, Alice(interact.pass));
    Bob.only(() =&gt; {
      const pass = declassify(interact.getPass());
      assume( passDigest == digest(pass) ); });
    Bob.publish(pass);
    require( passDigest == digest(pass) );
    transfer(amt).to(Bob);
    commit();

    exit(); } );"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span> <span class="mi">1</span>    <span class="s1">&#39;reach 0.1&#39;</span><span class="p">;</span>
 <span class="mi">2</span>    
 <span class="mi">3</span>    <a href="ref-programs-module.html#%28reach._%28%28export%29%29%29" class="kd" data-pltdoc="x">export</a> <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">main</span></font> <font class="badlink"><span class="o">=</span></font> <a href="ref-programs-module.html#%28reach._%28%28.Reach%29%29%29" class="nb" data-pltdoc="x">Reach</a><span class="p">.</span><a href="ref-programs-module.html#%28reach._%28%28.App%29%29%29" class="nb" data-pltdoc="x">App</a><span class="p">(</span>
 <span class="mi">4</span>      <span class="p">{</span> <a href="ref-programs-module.html#%28reach._%28%28deploy.Mode%29%29%29" class="nb" data-pltdoc="x">deployMode</a><font class="badlink"><span class="o">:</span></font> <span class="s1">&#39;firstMsg&#39;</span> <span class="p">},</span>
 <span class="mi">5</span>      <span class="p">[[</span><span class="s1">&#39;Alice&#39;</span><span class="p">,</span> <span class="p">{</span> <font class="badlink"><span class="nx">amt</span></font> <font class="badlink"><span class="o">:</span></font> <a href="ref-programs-compute.html#%28reach._%28%28.U.Int256%29%29%29" class="nb" data-pltdoc="x">UInt256</a><span class="p">,</span>
 <span class="mi">6</span>                   <font class="badlink"><span class="nx">pass</span></font><font class="badlink"><span class="o">:</span></font> <a href="ref-programs-compute.html#%28reach._%28%28.U.Int256%29%29%29" class="nb" data-pltdoc="x">UInt256</a> <span class="p">}],</span>
 <span class="mi">7</span>       <span class="p">[</span><span class="s1">&#39;Bob&#39;</span><span class="p">,</span> <span class="p">{</span> <font class="badlink"><span class="nx">getPass</span></font><font class="badlink"><span class="o">:</span></font> <a href="ref-programs-compute.html#%28reach._%28%28.Fun%29%29%29" class="nb" data-pltdoc="x">Fun</a><span class="p">([],</span> <a href="ref-programs-compute.html#%28reach._%28%28.U.Int256%29%29%29" class="nb" data-pltdoc="x">UInt256</a><span class="p">)</span> <span class="p">}]</span> <span class="p">],</span>
 <span class="mi">8</span>      <span class="p">(</span><font class="badlink"><span class="nx">Alice</span></font><span class="p">,</span> <font class="badlink"><span class="nx">Bob</span></font><span class="p">)</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a> <span class="p">{</span>
 <span class="mi">9</span>        <font class="badlink"><span class="nx">Alice</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28only%29%29%29" class="k" data-pltdoc="x">only</a><span class="p">(()</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a> <span class="p">{</span>
<span class="mi">10</span>          <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <span class="p">[</span> <font class="badlink"><span class="nx">amt</span></font><span class="p">,</span> <font class="badlink"><span class="nx">passDigest</span></font> <span class="p">]</span> <font class="badlink"><span class="o">=</span></font>
<span class="mi">11</span>                <a href="ref-programs-local.html#%28reach._%28%28declassify%29%29%29" class="k" data-pltdoc="x">declassify</a><span class="p">([</span> <a href="ref-programs-local.html#%28reach._%28%28interact%29%29%29" class="k" data-pltdoc="x">interact</a><span class="p">.</span><font class="badlink"><span class="nx">amt</span></font><span class="p">,</span>
<span class="mi">12</span>                             <a href="ref-programs-compute.html#%28reach._%28%28digest%29%29%29" class="nb" data-pltdoc="x">digest</a><span class="p">(</span><a href="ref-programs-local.html#%28reach._%28%28interact%29%29%29" class="k" data-pltdoc="x">interact</a><span class="p">.</span><font class="badlink"><span class="nx">pass</span></font><span class="p">)</span> <span class="p">]);</span> <span class="p">});</span>
<span class="mi">13</span>        <font class="badlink"><span class="nx">Alice</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28publish%29%29%29" class="k" data-pltdoc="x">publish</a><span class="p">(</span><font class="badlink"><span class="nx">passDigest</span></font><span class="p">,</span> <font class="badlink"><span class="nx">amt</span></font><span class="p">)</span>
<span class="mi">14</span>          <span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28pay%29%29%29" class="k" data-pltdoc="x">pay</a><span class="p">(</span><font class="badlink"><span class="nx">amt</span></font><span class="p">);</span>
<span class="mi">15</span>        <a href="ref-programs-consensus.html#%28reach._%28%28commit%29%29%29" class="k" data-pltdoc="x">commit</a><span class="p">();</span>
<span class="mi">16</span>    
<span class="mi">17</span>        <a href="ref-programs-step.html#%28reach._%28%28unknowable%29%29%29" class="k" data-pltdoc="x">unknowable</a><span class="p">(</span><font class="badlink"><span class="nx">Bob</span></font><span class="p">,</span> <font class="badlink"><span class="nx">Alice</span></font><span class="p">(</span><a href="ref-programs-local.html#%28reach._%28%28interact%29%29%29" class="k" data-pltdoc="x">interact</a><span class="p">.</span><font class="badlink"><span class="nx">pass</span></font><span class="p">));</span>
<span class="mi">18</span>        <font class="badlink"><span class="nx">Bob</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28only%29%29%29" class="k" data-pltdoc="x">only</a><span class="p">(()</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a> <span class="p">{</span>
<span class="mi">19</span>          <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">pass</span></font> <font class="badlink"><span class="o">=</span></font> <a href="ref-programs-local.html#%28reach._%28%28declassify%29%29%29" class="k" data-pltdoc="x">declassify</a><span class="p">(</span><a href="ref-programs-local.html#%28reach._%28%28interact%29%29%29" class="k" data-pltdoc="x">interact</a><span class="p">.</span><font class="badlink"><span class="nx">getPass</span></font><span class="p">());</span>
<span class="mi">20</span>          <a href="ref-programs-local.html#%28reach._%28%28assume%29%29%29" class="k" data-pltdoc="x">assume</a><span class="p">(</span> <font class="badlink"><span class="nx">passDigest</span></font> <a href="ref-programs-compute.html#%28reach._%28%28~3d~3d%29%29%29" class="o" data-pltdoc="x">==</a> <a href="ref-programs-compute.html#%28reach._%28%28digest%29%29%29" class="nb" data-pltdoc="x">digest</a><span class="p">(</span><font class="badlink"><span class="nx">pass</span></font><span class="p">)</span> <span class="p">);</span> <span class="p">});</span>
<span class="mi">21</span>        <font class="badlink"><span class="nx">Bob</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28publish%29%29%29" class="k" data-pltdoc="x">publish</a><span class="p">(</span><font class="badlink"><span class="nx">pass</span></font><span class="p">);</span>
<span class="mi">22</span>        <a href="ref-programs-consensus.html#%28reach._%28%28require%29%29%29" class="k" data-pltdoc="x">require</a><span class="p">(</span> <font class="badlink"><span class="nx">passDigest</span></font> <a href="ref-programs-compute.html#%28reach._%28%28~3d~3d%29%29%29" class="o" data-pltdoc="x">==</a> <a href="ref-programs-compute.html#%28reach._%28%28digest%29%29%29" class="nb" data-pltdoc="x">digest</a><span class="p">(</span><font class="badlink"><span class="nx">pass</span></font><span class="p">)</span> <span class="p">);</span>
<span class="mi">23</span>        <a href="ref-programs-consensus.html#%28reach._%28%28transfer%29%29%29" class="k" data-pltdoc="x">transfer</a><span class="p">(</span><font class="badlink"><span class="nx">amt</span></font><span class="p">).</span><font class="badlink"><span class="nx">to</span></font><span class="p">(</span><font class="badlink"><span class="nx">Bob</span></font><span class="p">);</span>
<span class="mi">24</span>        <a href="ref-programs-consensus.html#%28reach._%28%28commit%29%29%29" class="k" data-pltdoc="x">commit</a><span class="p">();</span>
<span class="mi">25</span>    
<span class="mi">26</span>        <a href="ref-programs-step.html#%28reach._%28%28exit%29%29%29" class="k" data-pltdoc="x">exit</a><span class="p">();</span> <span class="p">}</span> <span class="p">);</span>
</pre></div></div></p><ul><li><p>Lines 10-12 have Alice declassify some of her values.</p></li><li><p>Line 19 has Bob provide his password.</p></li></ul><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>Did you notice that we didn&rsquo;t mention what line 4 is for?
We&rsquo;ll discuss that in the next section; don&rsquo;t worry!</p></blockquote></blockquote></blockquote><p>At this point, when we</p><p><span class="hspace">&nbsp;&nbsp;</span><span style="font-weight: bold"><span class="stt">$</span></span><span class="stt"> </span><span class="stt">../reach compile</span></p><p>We&rsquo;ll get a happy message that all our theorems are true.
Great job!
But we still need to run our program!</p><h5>4.1.6<tt>&nbsp;</tt><a name="(part._.Deployment_.Decisions)"></a>Deployment Decisions</h5><p>At this point, we need to decide how we&rsquo;re going to deploy this program and really use it in the world.
We need to decide how to deploy the contract, as well as what kind of user interaction modality we&rsquo;ll implement inside of our <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a>.</p><blockquote class="SCentered"><p><br/><br/><br/><span style="font-weight: bold">Stop!</span><br/>Decide how you will deploy and use this application.<br/><br/><br/><br/></p></blockquote><p>In this case, it is a very simple program, so we&rsquo;ll use a simple and efficient contract <a href="guide-deploymode.html" data-pltdoc="x">deployment mode</a>: <code class="highlight"><span class="s1">&#39;firstMsg&#39;</span></code>.
This means that the <a href="ref-model.html#%28tech._contract%29" class="techoutside" data-pltdoc="x"><span class="techinside">contract</span></a> won&rsquo;t exist on the <a href="ref-model.html#%28tech._consensus._network%29" class="techoutside" data-pltdoc="x"><span class="techinside">consensus network</span></a> until Alice sends her first message.
This is a good choice for most contracts, if it is allowed.
(As <a href="guide-deploymode.html" data-pltdoc="x">the guide discusses</a>, some applications cannot be deployed like this.}</p><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>Unfortunately, on many <a href="ref-model.html#%28tech._consensus._network%29" class="techoutside" data-pltdoc="x"><span class="techinside">consensus networks</span></a>, like Ethereum and Algorand, this application is dangerous to run.
The problem is that a malicious miner, like Eve, can intercept Bob&rsquo;s message that provides him the funds, refuse to forward it through to the consensus network, take the password from it, and submit it for her own account.
There is not a good general solution to this problem, meaning a theorem that we could insert into our program to make sure this attack isn&rsquo;t possible, because the whole point of this application is that Bob&rsquo;s identity is not known at the time that Alice sends the first message.
Ideally, such networks would support a kind of cryptographic operation where Bob could prove that he knows the password without revealing it.
There are some ideas on how to provide this sort of thing through zero-knowledge proofs and homomorphic encryption, but there is no widely accepted and available solution.</p><p>In short: Don&rsquo;t run this program.
If you want to do something <span class="emph">like this</span>, then continue to the <a href="workshop-trust-fund.html" data-pltdoc="x">next workshop </a> on trust funds.
If you want to do exactly this, then stay tuned for a more complex zero-knowledge version.</p></blockquote></blockquote></blockquote><p>Next, we&rsquo;ll settle for a simple testing program for now, to show that the application, and let the rest of our full stack team deal with actually building the interface.
Here&rsquo;s the JavaScript <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a> we wrote:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/workshop-hash-lock/index.mjs"><span class="stt">workshop-hash-lock/index.mjs</span></a><button class="btn" data-clipboard-text="import * as stdlib from '@reach-sh/stdlib/ETH.mjs';
import * as backend from './build/index.main.mjs';

(async () =&gt; {
  const startingBalance = stdlib.toWeiBigNumber('100', 'ether');

  const accAlice = await stdlib.newTestAccount(startingBalance);
  const accBob = await stdlib.newTestAccount(startingBalance);

  const getBalance = async (who) =&gt;
        stdlib.fromWei ( await stdlib.balanceOf(who) );
  const beforeAlice = await getBalance(accAlice);
  const beforeBob = await getBalance(accBob);

  const ctcAlice = await accAlice.deploy(backend);
  const ctcBob = await accBob.attach(backend, ctcAlice);

  const thePass = stdlib.randomUInt256();

  await Promise.all([
    backend.Alice(
      stdlib, ctcAlice,
      { amt: stdlib.toWeiBigNumber('25', 'ether'),
        pass: thePass } ),
    backend.Bob(
      stdlib, ctcBob,
      { getPass: () =&gt; {
        console.log(`Bob asked to give the preimage.`);
        console.log(`Returning: ${thePass}`);
        return thePass; } } )
  ]);

  const afterAlice = await getBalance(accAlice);
  const afterBob = await getBalance(accBob);

  console.log(`Alice went from ${beforeAlice} to ${afterAlice}.`);
  console.log(`Bob went from ${beforeBob} to ${afterBob}.`);

})();"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span> <span class="mi">1</span>    <a href="ref-programs-module.html#%28reach._%28%28import%29%29%29" class="kd" data-pltdoc="x">import</a> <a href="ref-programs-compute.html#%28reach._%28%28%2A%29%29%29" class="o" data-pltdoc="x">*</a> <font class="badlink"><span class="kd">as</span></font> <font class="badlink"><span class="nx">stdlib</span></font> <a href="ref-programs-module.html#%28reach._%28%28from%29%29%29" class="kd" data-pltdoc="x">from</a> <span class="s1">&#39;@reach-sh/stdlib/ETH.mjs&#39;</span><span class="p">;</span>
 <span class="mi">2</span>    <a href="ref-programs-module.html#%28reach._%28%28import%29%29%29" class="kd" data-pltdoc="x">import</a> <a href="ref-programs-compute.html#%28reach._%28%28%2A%29%29%29" class="o" data-pltdoc="x">*</a> <font class="badlink"><span class="kd">as</span></font> <font class="badlink"><span class="nx">backend</span></font> <a href="ref-programs-module.html#%28reach._%28%28from%29%29%29" class="kd" data-pltdoc="x">from</a> <span class="s1">&#39;./build/index.main.mjs&#39;</span><span class="p">;</span>
 <span class="mi">3</span>    
 <span class="mi">4</span>    <span class="p">(</span><font class="badlink"><span class="nx">async</span></font> <span class="p">()</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a> <span class="p">{</span>
 <span class="mi">5</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">startingBalance</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">stdlib</span></font><span class="p">.</span><font class="badlink"><span class="nx">toWeiBigNumber</span></font><span class="p">(</span><span class="s1">&#39;100&#39;</span><span class="p">,</span> <span class="s1">&#39;ether&#39;</span><span class="p">);</span>
 <span class="mi">6</span>    
 <span class="mi">7</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">accAlice</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">await</span></font> <font class="badlink"><span class="nx">stdlib</span></font><span class="p">.</span><font class="badlink"><span class="nx">newTestAccount</span></font><span class="p">(</span><font class="badlink"><span class="nx">startingBalance</span></font><span class="p">);</span>
 <span class="mi">8</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">accBob</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">await</span></font> <font class="badlink"><span class="nx">stdlib</span></font><span class="p">.</span><font class="badlink"><span class="nx">newTestAccount</span></font><span class="p">(</span><font class="badlink"><span class="nx">startingBalance</span></font><span class="p">);</span>
 <span class="mi">9</span>    
<span class="mi">10</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">getBalance</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">async</span></font> <span class="p">(</span><font class="badlink"><span class="nx">who</span></font><span class="p">)</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a>
<span class="mi">11</span>            <font class="badlink"><span class="nx">stdlib</span></font><span class="p">.</span><font class="badlink"><span class="nx">fromWei</span></font> <span class="p">(</span> <font class="badlink"><span class="nx">await</span></font> <font class="badlink"><span class="nx">stdlib</span></font><span class="p">.</span><font class="badlink"><span class="nx">balanceOf</span></font><span class="p">(</span><font class="badlink"><span class="nx">who</span></font><span class="p">)</span> <span class="p">);</span>
<span class="mi">12</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">beforeAlice</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">await</span></font> <font class="badlink"><span class="nx">getBalance</span></font><span class="p">(</span><font class="badlink"><span class="nx">accAlice</span></font><span class="p">);</span>
<span class="mi">13</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">beforeBob</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">await</span></font> <font class="badlink"><span class="nx">getBalance</span></font><span class="p">(</span><font class="badlink"><span class="nx">accBob</span></font><span class="p">);</span>
<span class="mi">14</span>    
<span class="mi">15</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">ctcAlice</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">await</span></font> <font class="badlink"><span class="nx">accAlice</span></font><span class="p">.</span><font class="badlink"><span class="nx">deploy</span></font><span class="p">(</span><font class="badlink"><span class="nx">backend</span></font><span class="p">);</span>
<span class="mi">16</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">ctcBob</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">await</span></font> <font class="badlink"><span class="nx">accBob</span></font><span class="p">.</span><font class="badlink"><span class="nx">attach</span></font><span class="p">(</span><font class="badlink"><span class="nx">backend</span></font><span class="p">,</span> <font class="badlink"><span class="nx">ctcAlice</span></font><span class="p">);</span>
<span class="mi">17</span>    
<span class="mi">18</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">thePass</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">stdlib</span></font><span class="p">.</span><font class="badlink"><span class="nx">randomUInt256</span></font><span class="p">();</span>
<span class="mi">19</span>    
<span class="mi">20</span>      <font class="badlink"><span class="nx">await</span></font> <font class="badlink"><span class="nb">Promise</span></font><span class="p">.</span><font class="badlink"><span class="nx">all</span></font><span class="p">([</span>
<span class="mi">21</span>        <font class="badlink"><span class="nx">backend</span></font><span class="p">.</span><font class="badlink"><span class="nx">Alice</span></font><span class="p">(</span>
<span class="mi">22</span>          <font class="badlink"><span class="nx">stdlib</span></font><span class="p">,</span> <font class="badlink"><span class="nx">ctcAlice</span></font><span class="p">,</span>
<span class="mi">23</span>          <span class="p">{</span> <font class="badlink"><span class="nx">amt</span></font><font class="badlink"><span class="o">:</span></font> <font class="badlink"><span class="nx">stdlib</span></font><span class="p">.</span><font class="badlink"><span class="nx">toWeiBigNumber</span></font><span class="p">(</span><span class="s1">&#39;25&#39;</span><span class="p">,</span> <span class="s1">&#39;ether&#39;</span><span class="p">),</span>
<span class="mi">24</span>            <font class="badlink"><span class="nx">pass</span></font><font class="badlink"><span class="o">:</span></font> <font class="badlink"><span class="nx">thePass</span></font> <span class="p">}</span> <span class="p">),</span>
<span class="mi">25</span>        <font class="badlink"><span class="nx">backend</span></font><span class="p">.</span><font class="badlink"><span class="nx">Bob</span></font><span class="p">(</span>
<span class="mi">26</span>          <font class="badlink"><span class="nx">stdlib</span></font><span class="p">,</span> <font class="badlink"><span class="nx">ctcBob</span></font><span class="p">,</span>
<span class="mi">27</span>          <span class="p">{</span> <font class="badlink"><span class="nx">getPass</span></font><font class="badlink"><span class="o">:</span></font> <span class="p">()</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a> <span class="p">{</span>
<span class="mi">28</span>            <font class="badlink"><span class="nx">console</span></font><span class="p">.</span><font class="badlink"><span class="nx">log</span></font><span class="p">(</span><span class="sb">`Bob asked to give the preimage.`</span><span class="p">);</span>
<span class="mi">29</span>            <font class="badlink"><span class="nx">console</span></font><span class="p">.</span><font class="badlink"><span class="nx">log</span></font><span class="p">(</span><span class="sb">`Returning: </span><span class="si">${</span><font class="badlink"><span class="nx">thePass</span></font><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="mi">30</span>            <a href="ref-programs-compute.html#%28reach._%28%28return%29%29%29" class="k" data-pltdoc="x">return</a> <font class="badlink"><span class="nx">thePass</span></font><span class="p">;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
<span class="mi">31</span>      <span class="p">]);</span>
<span class="mi">32</span>    
<span class="mi">33</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">afterAlice</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">await</span></font> <font class="badlink"><span class="nx">getBalance</span></font><span class="p">(</span><font class="badlink"><span class="nx">accAlice</span></font><span class="p">);</span>
<span class="mi">34</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">afterBob</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">await</span></font> <font class="badlink"><span class="nx">getBalance</span></font><span class="p">(</span><font class="badlink"><span class="nx">accBob</span></font><span class="p">);</span>
<span class="mi">35</span>    
<span class="mi">36</span>      <font class="badlink"><span class="nx">console</span></font><span class="p">.</span><font class="badlink"><span class="nx">log</span></font><span class="p">(</span><span class="sb">`Alice went from </span><span class="si">${</span><font class="badlink"><span class="nx">beforeAlice</span></font><span class="si">}</span><span class="sb"> to </span><span class="si">${</span><font class="badlink"><span class="nx">afterAlice</span></font><span class="si">}</span><span class="sb">.`</span><span class="p">);</span>
<span class="mi">37</span>      <font class="badlink"><span class="nx">console</span></font><span class="p">.</span><font class="badlink"><span class="nx">log</span></font><span class="p">(</span><span class="sb">`Bob went from </span><span class="si">${</span><font class="badlink"><span class="nx">beforeBob</span></font><span class="si">}</span><span class="sb"> to </span><span class="si">${</span><font class="badlink"><span class="nx">afterBob</span></font><span class="si">}</span><span class="sb">.`</span><span class="p">);</span>
<span class="mi">38</span>    
<span class="mi">39</span>    <span class="p">})();</span>
</pre></div></div></p><p>In this case, Bob learns the password outside of the Reach program by directly sharing memory with Alice.
In a real deployment, she might give Bob the password through some other channel, like an encrypted email message, or a calligraphic scroll delivered by raven or intoned from Himalayan cliffs.</p><p>With this testing frontend in place, we can run</p><p><span class="hspace">&nbsp;&nbsp;</span><span style="font-weight: bold"><span class="stt">$</span></span><span class="stt"> </span><span class="stt">../reach run</span></p><p>and see an example execution.</p><h5>4.1.7<tt>&nbsp;</tt><a name="(part._.Discussion)"></a>Discussion</h5><p>You did it!</p><p>You implemented a Reach program totally on your own, with only a little bit of prodding.</p><p>Unlike <a href="tut.html" data-pltdoc="x">the tutorial</a>, this workshop uses a "top-down" perspective on Reach application design, where you derive the program from the requirements and slowly fill out the shell, while knowing that each step was correct before moving on.
In contrast, in <a href="tut.html" data-pltdoc="x">the tutorial</a>, we demonstrated a "bottom-up" style where you start implementing the easy parts and realize the problems and their fixes as you go.
There&rsquo;s no right way to program and in our own Reach development, we use a combination of the two tactics.
Try both and keep them both in mind during your own development.</p><p>If you found this workshop rewarding, please let us know on <a href="https://discord.gg/AZsgcXu">the Discord community</a>!
If you want to know what to do next, a natural extension of the concepts in this workshop is a <a href="workshop-trust-fund.html" data-pltdoc="x">trust fund</a>.
Why don&rsquo;t you check it out?</p><div class="navsetbottom"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="workshop.html" title="backward to &quot;4 Workshop&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="workshop.html" title="up to &quot;4 Workshop&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="workshop-trust-fund.html" title="forward to &quot;4.2 Workshop: Trust Fund&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div><script src="reach-post.js"></script></body></html>