<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-149147406-2"></script><script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-149147406-2');</script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script><script src="tooltips.js"></script><script src="reach-pre.js"></script><link rel="stylesheet" href="tooltips.css"><link rel="stylesheet" href="reach.css"><link rel="stylesheet" href="minted.css"><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>3.4&nbsp;Finding and using loop invariants</title><link rel="stylesheet" type="text/css" href="scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-racket.css" title="default"/><script type="text/javascript" src="scribble-common.js"></script><script type="text/javascript" src="manual-racket.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--></head><body id="scribble-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9658;</a></td><td></td><td><a href="index.html" class="tocviewlink" data-pltdoc="x">Reach:<span class="mywbr"> &nbsp;</span> The Safest and Easiest DApp Programming Language</a></td></tr></table></div><div class="tocviewsublisttop" style="display: none;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="overview.html" class="tocviewlink" data-pltdoc="x">Overview</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="tut.html" class="tocviewlink" data-pltdoc="x">Tutorial</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="guide.html" class="tocviewselflink" data-pltdoc="x">Guide</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="workshop.html" class="tocviewlink" data-pltdoc="x">Workshop</a></td></tr><tr><td align="right">5&nbsp;</td><td><a href="ref.html" class="tocviewlink" data-pltdoc="x">Reference</a></td></tr><tr><td align="right"></td><td><a href="doc-index.html" class="tocviewlink" data-pltdoc="x">Index</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_1&quot;);">&#9660;</a></td><td>3&nbsp;</td><td><a href="guide.html" class="tocviewlink" data-pltdoc="x">Guide</a></td></tr></table><div class="tocviewsublistbottom" style="display: block;" id="tocview_1"><table cellspacing="0" cellpadding="0"><tr><td align="right">3.1&nbsp;</td><td><a href="guide-windows.html" class="tocviewlink" data-pltdoc="x">Using Reach on Windows</a></td></tr><tr><td align="right">3.2&nbsp;</td><td><a href="guide-versions.html" class="tocviewlink" data-pltdoc="x">How does Reach use version numbers?</a></td></tr><tr><td align="right">3.3&nbsp;</td><td><a href="guide-assert.html" class="tocviewlink" data-pltdoc="x">How and what to verify</a></td></tr><tr><td align="right">3.4&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Finding and using loop invariants</a></td></tr><tr><td align="right">3.5&nbsp;</td><td><a href="guide-deploymode.html" class="tocviewlink" data-pltdoc="x">Choosing a deployment mode</a></td></tr><tr><td align="right">3.6&nbsp;</td><td><a href="guide-timeout.html" class="tocviewlink" data-pltdoc="x">Non-<wbr></wbr>participation:<span class="mywbr"> &nbsp;</span> What it is and how to protect against it</a></td></tr><tr><td align="right">3.7&nbsp;</td><td><a href="guide-determ.html" class="tocviewlink" data-pltdoc="x">Determinism, simultaneity, and choice in decentralized applications</a></td></tr><tr><td align="right">3.8&nbsp;</td><td><a href="guide-race.html" class="tocviewlink" data-pltdoc="x">Racing non-<wbr></wbr>determinism in decentralized applications</a></td></tr><tr><td align="right">3.9&nbsp;</td><td><a href="guide-abstract.html" class="tocviewlink" data-pltdoc="x">Building decentralized abstractions</a></td></tr><tr><td align="right">3.10&nbsp;</td><td><a href="guide-browser-testing.html" class="tocviewlink" data-pltdoc="x">Testing Reach programs in the browser</a></td></tr><tr><td align="right">3.11&nbsp;</td><td><a href="guide-limits.html" class="tocviewlink" data-pltdoc="x">What are Reach&rsquo;s limitations and its future roadmap</a></td></tr><tr><td align="right">3.12&nbsp;</td><td><a href="guide-reach.html" class="tocviewlink" data-pltdoc="x">How does Reach work?</a></td></tr><tr><td align="right">3.13&nbsp;</td><td><a href="guide-editor-support.html" class="tocviewlink" data-pltdoc="x">IDE/<span class="mywbr"> &nbsp;</span>Text Editor Support</a></td></tr></table></div></div></div></div><div class="maincolumn"><div class="main"><div class="versionbox"><span class="version">0.1.2</span></div><div class="navsettop"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="guide-assert.html" title="backward to &quot;3.3 How and what to verify&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="guide.html" title="up to &quot;3 Guide&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="guide-deploymode.html" title="forward to &quot;3.5 Choosing a deployment mode&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div><h4>3.4<tt>&nbsp;</tt><a name="(part._guide-loop-invs)"></a>Finding and using loop invariants</h4><p>Reach requires that <code class="highlight"><a href="ref-programs-consensus.html#%28reach._%28%28while%29%29%29" class="k" data-pltdoc="x">while</a></code> loops are annotated with <a href="https://en.wikipedia.org/wiki/Loop_invariant">loop invariants</a>.
A loop invariant is a property <code class="highlight"><font class="badlink"><span class="nx">INV</span></font></code> which is true before the loop starts and is true after the loop ends.</p><p>Consider the following program fragment,</p><p><div class="highlight"><pre><span></span><span class="p">...</span> <font class="badlink"><span class="nx">before</span></font> <span class="p">...</span>
<a href="ref-programs-consensus.html#%28reach._%28%28var%29%29%29" class="kd" data-pltdoc="x">var</a> <font class="badlink"><span class="nx">V</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">INIT</span></font><span class="p">;</span>
<a href="ref-programs-consensus.html#%28reach._%28%28invariant%29%29%29" class="k" data-pltdoc="x">invariant</a><span class="p">(</span> <font class="badlink"><span class="nx">INV</span></font> <span class="p">);</span>
<a href="ref-programs-consensus.html#%28reach._%28%28while%29%29%29" class="k" data-pltdoc="x">while</a> <span class="p">(</span> <font class="badlink"><span class="nx">COND</span></font> <span class="p">)</span> <span class="p">{</span>
 <span class="p">...</span> <font class="badlink"><span class="nx">body</span></font> <span class="p">...</span>
 <font class="badlink"><span class="nx">V</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">NEXT</span></font><span class="p">;</span>
 <a href="ref-programs-consensus.html#%28reach._%28%28continue%29%29%29" class="k" data-pltdoc="x">continue</a><span class="p">;</span> <span class="p">}</span>
<span class="p">...</span> <font class="badlink"><span class="nx">after</span></font> <span class="p">...</span>
<a href="ref-programs-compute.html#%28reach._%28%28assert%29%29%29" class="k" data-pltdoc="x">assert</a><span class="p">(</span><font class="badlink"><span class="nx">P</span></font><span class="p">);</span> 
</pre></div></p><p>We can summarize the properties that must be true about this code as follows:</p><ul><li><p><code class="highlight"><font class="badlink"><span class="nx">before</span></font></code> and <code class="highlight"><font class="badlink"><span class="nx">V</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">INIT</span></font></code> implies <code class="highlight"><font class="badlink"><span class="nx">INV</span></font></code> &#8212;<wbr></wbr> The earlier part of the program must establish <code class="highlight"><font class="badlink"><span class="nx">INV</span></font></code>.</p></li><li><p>If <code class="highlight"><font class="badlink"><span class="nx">COND</span></font></code> and <code class="highlight"><font class="badlink"><span class="nx">INV</span></font></code>, then <code class="highlight"><font class="badlink"><span class="nx">body</span></font></code> and <code class="highlight"><font class="badlink"><span class="nx">V</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">NEXT</span></font></code> implies <code class="highlight"><font class="badlink"><span class="nx">INV</span></font></code> &#8212;<wbr></wbr> The loop body can make use of the truth of the condition and the invariant to re-establish the invariant after <code class="highlight"><font class="badlink"><span class="nx">V</span></font></code> is mutated to <code class="highlight"><font class="badlink"><span class="nx">NEXT</span></font></code>.</p></li><li><p><code class="highlight"><a href="ref-programs-compute.html#%28reach._%28%28%21%29%29%29" class="o" data-pltdoc="x">!</a> <font class="badlink"><span class="nx">COND</span></font></code> and <code class="highlight"><font class="badlink"><span class="nx">INV</span></font></code> and <code class="highlight"><font class="badlink"><span class="nx">after</span></font></code> implies <code class="highlight"><font class="badlink"><span class="nx">P</span></font></code> &#8212;<wbr></wbr> The later part of the program can make use of the negation of the condition and the invariant to establish any future assertions.</p></li></ul><p>Loop invariants only need to mention values that can vary because of the execution of the loop.
In Reach, all bindings are immutable, except for those bound by <code class="highlight"><a href="ref-programs-consensus.html#%28reach._%28%28while%29%29%29" class="k" data-pltdoc="x">while</a></code>, so they never need to be mentioned.
However, Reach has two kinds of mutable bindings: loop variables and the contract balance (which is imperatively modified by <code class="highlight"><a href="ref-programs-step.html#%28reach._%28%28pay%29%29%29" class="k" data-pltdoc="x">pay</a></code> and <code class="highlight"><a href="ref-programs-consensus.html#%28reach._%28%28transfer%29%29%29" class="k" data-pltdoc="x">transfer</a></code>).
As such, both of these are typically mentioned in loop invariants.</p><p>Loop variables are mentioned if they occur in subsequent assertions, or if they are used to perform potentially unsafe actions, like an array dereference.
But, since every Reach program terminates with the <a href="ref-model.html#%28tech._token._linearity._property%29" class="techoutside" data-pltdoc="x"><span class="techinside">token linearity property</span></a>, loop invariants always reference the contract balance.</p><p>When designing a loop invariant, first write down an equation for the contract balance before the loop.
If the loop contains transfer to the contract, then you must be able to track the amount and number of these.
In the best case, you should be able to express the balance as an equation over the existing loop variables.
In the worst case, you will have to add more loop variables to track some quantity, like the number of rounds of a game, that the balance is derived from.</p><p>After you&rsquo;ve tracked the balance, you will need to add additional clauses that track whatever properties you rely on in the tail of the loop.</p><p>The most complex circumstances is when you have nested loops.
In this situation, the inner loop&rsquo;s invariant will have to include clauses related to the outer loop&rsquo;s invariant.</p><div class="navsetbottom"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="guide-assert.html" title="backward to &quot;3.3 How and what to verify&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="guide.html" title="up to &quot;3 Guide&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="guide-deploymode.html" title="forward to &quot;3.5 Choosing a deployment mode&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div><script src="reach-post.js"></script></body></html>