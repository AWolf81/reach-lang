<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-149147406-2"></script><script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-149147406-2');</script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script><script src="tooltips.js"></script><script src="reach-pre.js"></script><link rel="stylesheet" href="tooltips.css"><link rel="stylesheet" href="reach.css"><link rel="stylesheet" href="minted.css"><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>3.8&nbsp;Racing non-determinism in decentralized applications</title><link rel="stylesheet" type="text/css" href="scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-racket.css" title="default"/><script type="text/javascript" src="scribble-common.js"></script><script type="text/javascript" src="manual-racket.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--></head><body id="scribble-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9658;</a></td><td></td><td><a href="index.html" class="tocviewlink" data-pltdoc="x">Reach:<span class="mywbr"> &nbsp;</span> The Safest and Easiest DApp Programming Language</a></td></tr></table></div><div class="tocviewsublisttop" style="display: none;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="overview.html" class="tocviewlink" data-pltdoc="x">Overview</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="tut.html" class="tocviewlink" data-pltdoc="x">Tutorial</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="guide.html" class="tocviewselflink" data-pltdoc="x">Guide</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="workshop.html" class="tocviewlink" data-pltdoc="x">Workshop</a></td></tr><tr><td align="right">5&nbsp;</td><td><a href="ref.html" class="tocviewlink" data-pltdoc="x">Reference</a></td></tr><tr><td align="right"></td><td><a href="doc-index.html" class="tocviewlink" data-pltdoc="x">Index</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_1&quot;);">&#9660;</a></td><td>3&nbsp;</td><td><a href="guide.html" class="tocviewlink" data-pltdoc="x">Guide</a></td></tr></table><div class="tocviewsublistbottom" style="display: block;" id="tocview_1"><table cellspacing="0" cellpadding="0"><tr><td align="right">3.1&nbsp;</td><td><a href="guide-windows.html" class="tocviewlink" data-pltdoc="x">Using Reach on Windows</a></td></tr><tr><td align="right">3.2&nbsp;</td><td><a href="guide-versions.html" class="tocviewlink" data-pltdoc="x">How does Reach use version numbers?</a></td></tr><tr><td align="right">3.3&nbsp;</td><td><a href="guide-assert.html" class="tocviewlink" data-pltdoc="x">How and what to verify</a></td></tr><tr><td align="right">3.4&nbsp;</td><td><a href="guide-loop-invs.html" class="tocviewlink" data-pltdoc="x">Finding and using loop invariants</a></td></tr><tr><td align="right">3.5&nbsp;</td><td><a href="guide-deploymode.html" class="tocviewlink" data-pltdoc="x">Choosing a deployment mode</a></td></tr><tr><td align="right">3.6&nbsp;</td><td><a href="guide-timeout.html" class="tocviewlink" data-pltdoc="x">Non-<wbr></wbr>participation:<span class="mywbr"> &nbsp;</span> What it is and how to protect against it</a></td></tr><tr><td align="right">3.7&nbsp;</td><td><a href="guide-determ.html" class="tocviewlink" data-pltdoc="x">Determinism, simultaneity, and choice in decentralized applications</a></td></tr><tr><td align="right">3.8&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Racing non-<wbr></wbr>determinism in decentralized applications</a></td></tr><tr><td align="right">3.9&nbsp;</td><td><a href="guide-abstract.html" class="tocviewlink" data-pltdoc="x">Building decentralized abstractions</a></td></tr><tr><td align="right">3.10&nbsp;</td><td><a href="guide-limits.html" class="tocviewlink" data-pltdoc="x">What are Reach&rsquo;s limitations and its future roadmap</a></td></tr><tr><td align="right">3.11&nbsp;</td><td><a href="guide-reach.html" class="tocviewlink" data-pltdoc="x">How does Reach work?</a></td></tr></table></div></div></div></div><div class="maincolumn"><div class="main"><div class="versionbox"><span class="version">0.1.2</span></div><div class="navsettop"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="guide-determ.html" title="backward to &quot;3.7 Determinism, simultaneity, and choice in decentralized applications&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="guide.html" title="up to &quot;3 Guide&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="guide-abstract.html" title="forward to &quot;3.9 Building decentralized abstractions&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div><h4>3.8<tt>&nbsp;</tt><a name="(part._guide-race)"></a>Racing non-determinism in decentralized applications</h4><p>As discussed <a href="guide-determ.html" data-pltdoc="x">earlier in the guide</a>, Reach computations have a deterministic structure, but non-deterministic values.
This means that a program will always executes steps A, B, and then C, but the values manipulated by those steps may be different on every execution.</p><p>The most common form of value non-determinism is through the <code class="highlight"><a href="ref-programs-local.html#%28reach._%28%28interact%29%29%29" class="k" data-pltdoc="x">interact</a></code> expression and <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a>-provided values.
A Reach program merely specifies that a <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a> must provide an unsigned integer that it will name <code class="highlight"><font class="badlink"><span class="nx">bid</span></font></code>, but not what value is actually provided.</p><p>However, a more subtle form of value non-determinism occurs with the <code class="highlight"><a href="ref-programs-step.html#%28reach._%28%28race%29%29%29" class="k" data-pltdoc="x">race</a></code> expression.
This expression allows multiple <a href="ref-model.html#%28tech._participant%29" class="techoutside" data-pltdoc="x"><span class="techinside">participants</span></a> to all attempt to provide the same value for a <a href="ref-model.html#%28tech._publication%29" class="techoutside" data-pltdoc="x"><span class="techinside">publication</span></a>.
For example, consider a turn-based game, like <a href="workshop-nim.html" data-pltdoc="x">Nim</a>, where there is no <span class="emph">a priori</span> way to determine who goes first.
We could write a Reach program like:</p><p><div class="highlight"><pre><span></span><span class="c1">// Alice publishes the wager</span>

<span class="c1">// Bob accepts the wager</span>

<font class="badlink"><span class="nx">Alice</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28only%29%29%29" class="k" data-pltdoc="x">only</a><span class="p">(()</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a> <span class="p">{</span>
 <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">aliceGoesFirst</span></font> <font class="badlink"><span class="o">=</span></font> <a href="ref-programs-compute.html#%28reach._%28%28true%29%29%29" class="kc" data-pltdoc="x">true</a><span class="p">;</span> <span class="p">});</span>
<font class="badlink"><span class="nx">Bob</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28only%29%29%29" class="k" data-pltdoc="x">only</a><span class="p">(()</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a> <span class="p">{</span>
 <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">aliceGoesFirst</span></font> <font class="badlink"><span class="o">=</span></font> <a href="ref-programs-compute.html#%28reach._%28%28false%29%29%29" class="kc" data-pltdoc="x">false</a><span class="p">;</span> <span class="p">});</span>
<a href="ref-programs-step.html#%28reach._%28%28race%29%29%29" class="k" data-pltdoc="x">race</a><span class="p">(</span><font class="badlink"><span class="nx">Alice</span></font><span class="p">,</span> <font class="badlink"><span class="nx">Bob</span></font><span class="p">).</span><a href="ref-programs-step.html#%28reach._%28%28publish%29%29%29" class="k" data-pltdoc="x">publish</a><span class="p">(</span><font class="badlink"><span class="nx">aliceGoesFirst</span></font><span class="p">);</span>

<span class="c1">// They play the game, taking turns</span>
</pre></div></p><p>where a <code class="highlight"><a href="ref-programs-step.html#%28reach._%28%28race%29%29%29" class="k" data-pltdoc="x">race</a></code> determines the first player.</p><p>This use-case demonstrates a major problem with <code class="highlight"><a href="ref-programs-step.html#%28reach._%28%28race%29%29%29" class="k" data-pltdoc="x">race</a></code>s though.
In the case of Nim, there is an advantage to whoever goes first: they can win if they choose the correct moves!
Since Bob sent the previous publication, he will know about the opportunity to determine who goes first before Alice, so he can send both publication in back-to-back and be guaranteed to win.</p><p>One strategy to avoid this would be to ensure that Alice and Bob both <code class="highlight"><a href="ref-programs-step.html#%28reach._%28%28wait%29%29%29" class="nx" data-pltdoc="x">wait</a></code> a pre-determined amount of time, after which they would each have a fair chance to race:</p><p><div class="highlight"><pre><span></span><span class="c1">// Alice publishes the wager</span>

<span class="c1">// Bob accepts the wager</span>

<font class="badlink"><span class="nx">Alice</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28only%29%29%29" class="k" data-pltdoc="x">only</a><span class="p">(()</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a> <span class="p">{</span>
 <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">aliceGoesFirst</span></font> <font class="badlink"><span class="o">=</span></font> <a href="ref-programs-compute.html#%28reach._%28%28true%29%29%29" class="kc" data-pltdoc="x">true</a><span class="p">;</span> <span class="p">});</span>
<font class="badlink"><span class="nx">Bob</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28only%29%29%29" class="k" data-pltdoc="x">only</a><span class="p">(()</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a> <span class="p">{</span>
 <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">aliceGoesFirst</span></font> <font class="badlink"><span class="o">=</span></font> <a href="ref-programs-compute.html#%28reach._%28%28false%29%29%29" class="kc" data-pltdoc="x">false</a><span class="p">;</span> <span class="p">});</span>

<a href="ref-programs-step.html#%28reach._%28%28wait%29%29%29" class="nx" data-pltdoc="x">wait</a><span class="p">(</span><font class="badlink"><span class="nx">duration</span></font><span class="p">);</span>

<a href="ref-programs-step.html#%28reach._%28%28race%29%29%29" class="k" data-pltdoc="x">race</a><span class="p">(</span><font class="badlink"><span class="nx">Alice</span></font><span class="p">,</span> <font class="badlink"><span class="nx">Bob</span></font><span class="p">).</span><a href="ref-programs-step.html#%28reach._%28%28publish%29%29%29" class="k" data-pltdoc="x">publish</a><span class="p">(</span><font class="badlink"><span class="nx">aliceGoesFirst</span></font><span class="p">);</span>

<span class="c1">// They play the game, taking turns</span>
</pre></div></p><p>However, even this strategy is dangerous, because it just creates an arms race between Alice and Bob to acquire more computational and network resources to guarantee that they are the first one, because whoever is first is the actual winner of the game, whatever happens next.
A classic example of a situation like this was the <a href="https://medium.com/coinmonks/how-the-winner-got-fomo3d-prize-a-detailed-explanation-b30a69b7813f">Fomo3D winner</a>, who used their capital to acquire millions in ETH in 2018.</p><p>A better strategy in this application would be to have each particular provide randomness using a commitment pattern (see <code class="highlight"><a href="ref-programs-local.html#%28reach._%28%28make.Commitment%29%29%29" class="nb" data-pltdoc="x">makeCommitment</a></code> and <code class="highlight"><a href="ref-programs-consensus.html#%28reach._%28%28check.Commitment%29%29%29" class="nb" data-pltdoc="x">checkCommitment</a></code>) then reveal that randomness to determine the winner.
Or, to play a different game that is actually skill-based.</p><p>This example demonstrates the crucial problem with the <a href="ref-model.html#%28tech._participant%29" class="techoutside" data-pltdoc="x"><span class="techinside">participant</span></a> non-determinism enabled by <code class="highlight"><a href="ref-programs-step.html#%28reach._%28%28race%29%29%29" class="k" data-pltdoc="x">race</a></code>: it will always produce an arms race for resources if winning the race results in winning funds.
It is only safe and acceptable if who the winner is has no bearing on the ultimate outcome of the computation.</p><p>We can express this condition formally by saying that if <code class="highlight"><font class="badlink"><span class="nx">A</span></font></code> and <code class="highlight"><font class="badlink"><span class="nx">B</span></font></code> compete to provide value <code class="highlight"><font class="badlink"><span class="nx">a</span></font></code> and <code class="highlight"><font class="badlink"><span class="nx">b</span></font></code> respectively, then the computation should provide an opportunity for the first loser to provide their value later, such that it doesn&rsquo;t matter what order they are provided.
Mathematically, we could say that the program should not be a one-parameter function &lsquo;f&lsquo;, where the computation is either &lsquo;f(a)&lsquo; or &lsquo;f(b)&lsquo;.
Instead, it should be a two-parameter function &lsquo;g&lsquo;, such that &lsquo;g(a, b) = g(b, a)&lsquo; (i.e. a <a href="https://en.wikipedia.org/wiki/Commutative_property">commutative</a> function).</p><div class="navsetbottom"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="guide-determ.html" title="backward to &quot;3.7 Determinism, simultaneity, and choice in decentralized applications&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="guide.html" title="up to &quot;3 Guide&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="guide-abstract.html" title="forward to &quot;3.9 Building decentralized abstractions&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div><script src="reach-post.js"></script></body></html>