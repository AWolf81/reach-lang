<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-149147406-2"></script><script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-149147406-2');</script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script><script src="tooltips.js"></script><script src="reach-pre.js"></script><link rel="stylesheet" href="tooltips.css"><link rel="stylesheet" href="reach.css"><link rel="stylesheet" href="minted.css"><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>4.2&nbsp;Workshop: Relay Account</title><link rel="stylesheet" type="text/css" href="scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-racket.css" title="default"/><script type="text/javascript" src="scribble-common.js"></script><script type="text/javascript" src="manual-racket.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--></head><body id="scribble-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9658;</a></td><td></td><td><a href="index.html" class="tocviewlink" data-pltdoc="x">Reach:<span class="mywbr"> &nbsp;</span> The Safest and Easiest DApp Programming Language</a></td></tr></table></div><div class="tocviewsublisttop" style="display: none;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="overview.html" class="tocviewlink" data-pltdoc="x">Overview</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="tut.html" class="tocviewlink" data-pltdoc="x">Tutorial</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="guide.html" class="tocviewlink" data-pltdoc="x">Guide</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="workshop.html" class="tocviewselflink" data-pltdoc="x">Workshop</a></td></tr><tr><td align="right">5&nbsp;</td><td><a href="ref.html" class="tocviewlink" data-pltdoc="x">Reference</a></td></tr><tr><td align="right"></td><td><a href="doc-index.html" class="tocviewlink" data-pltdoc="x">Index</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_1&quot;);">&#9660;</a></td><td>4&nbsp;</td><td><a href="workshop.html" class="tocviewlink" data-pltdoc="x">Workshop</a></td></tr></table><div class="tocviewsublist" style="display: block;" id="tocview_1"><table cellspacing="0" cellpadding="0"><tr><td align="right">4.1&nbsp;</td><td><a href="workshop-hash-lock.html" class="tocviewlink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Hash Lock</a></td></tr><tr><td align="right">4.2&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Relay Account</a></td></tr><tr><td align="right">4.3&nbsp;</td><td><a href="workshop-trust-fund.html" class="tocviewlink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Trust Fund</a></td></tr><tr><td align="right">4.4&nbsp;</td><td><a href="workshop-rps-fair.html" class="tocviewlink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Fair Rock-<wbr></wbr>Paper-<wbr></wbr>Scissors</a></td></tr><tr><td align="right">4.5&nbsp;</td><td><a href="workshop-rps-eff.html" class="tocviewlink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Efficient Rock-<wbr></wbr>Paper-<wbr></wbr>Scissors</a></td></tr><tr><td align="right">4.6&nbsp;</td><td><a href="workshop-rental.html" class="tocviewlink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Rental Agreement</a></td></tr><tr><td align="right">4.7&nbsp;</td><td><a href="workshop-abstract-simul.html" class="tocviewlink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Simultaneous Games</a></td></tr><tr><td align="right">4.8&nbsp;</td><td><a href="workshop-guardian-account.html" class="tocviewlink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Guardian Account</a></td></tr><tr><td align="right">4.9&nbsp;</td><td><a href="workshop-utility.html" class="tocviewlink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Periodic Payment</a></td></tr><tr><td align="right">4.10&nbsp;</td><td><a href="workshop-nim.html" class="tocviewlink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Nim</a></td></tr><tr><td align="right">4.11&nbsp;</td><td><a href="workshop-ttt.html" class="tocviewlink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Tic-<wbr></wbr>Tac-<wbr></wbr>Toe</a></td></tr><tr><td align="right">4.12&nbsp;</td><td><a href="workshop-secured-loan.html" class="tocviewlink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Secured Loan</a></td></tr><tr><td align="right">4.13&nbsp;</td><td><a href="workshop-oracle.html" class="tocviewlink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Oracle</a></td></tr><tr><td align="right">4.14&nbsp;</td><td><a href="workshop-auction-te.html" class="tocviewlink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Timed English Auction</a></td></tr><tr><td align="right">4.15&nbsp;</td><td><a href="workshop-crowdfund.html" class="tocviewlink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Crowd-<wbr></wbr>funding</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_2&quot;);">&#9658;</a></td><td>4.2&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Workshop:<span class="mywbr"> &nbsp;</span> Relay Account</a></td></tr></table><div class="tocviewsublistbottom" style="display: none;" id="tocview_2"><table cellspacing="0" cellpadding="0"><tr><td align="right">4.2.1&nbsp;</td><td><a href="#%28part._workshop-relay-pr%29" class="tocviewlink" data-pltdoc="x">Problem Analysis</a></td></tr><tr><td align="right">4.2.2&nbsp;</td><td><a href="#%28part._workshop-relay-dd%29" class="tocviewlink" data-pltdoc="x">Data Definition</a></td></tr><tr><td align="right">4.2.3&nbsp;</td><td><a href="#%28part._workshop-relay-cc%29" class="tocviewlink" data-pltdoc="x">Communication Construction</a></td></tr><tr><td align="right">4.2.4&nbsp;</td><td><a href="#%28part._workshop-relay-ai%29" class="tocviewlink" data-pltdoc="x">Assertion Insertion</a></td></tr><tr><td align="right">4.2.5&nbsp;</td><td><a href="#%28part._workshop-relay-ii%29" class="tocviewlink" data-pltdoc="x">Interaction Introduction</a></td></tr><tr><td align="right">4.2.6&nbsp;</td><td><a href="#%28part._workshop-relay-de%29" class="tocviewlink" data-pltdoc="x">Deployment Decisions</a></td></tr><tr><td align="right">4.2.7&nbsp;</td><td><a href="#%28part._workshop-relay-dns%29" class="tocviewlink" data-pltdoc="x">Discussion and Next Steps</a></td></tr></table></div></div></div><div class="tocsub"><div class="tocsubtitle">On this page:</div><table class="tocsublist" cellspacing="0"><tr><td><span class="tocsublinknumber">4.2.1<tt>&nbsp;</tt></span><a href="#%28part._workshop-relay-pr%29" class="tocsubseclink" data-pltdoc="x">Problem Analysis</a></td></tr><tr><td><span class="tocsublinknumber">4.2.2<tt>&nbsp;</tt></span><a href="#%28part._workshop-relay-dd%29" class="tocsubseclink" data-pltdoc="x">Data Definition</a></td></tr><tr><td><span class="tocsublinknumber">4.2.3<tt>&nbsp;</tt></span><a href="#%28part._workshop-relay-cc%29" class="tocsubseclink" data-pltdoc="x">Communication Construction</a></td></tr><tr><td><span class="tocsublinknumber">4.2.4<tt>&nbsp;</tt></span><a href="#%28part._workshop-relay-ai%29" class="tocsubseclink" data-pltdoc="x">Assertion Insertion</a></td></tr><tr><td><span class="tocsublinknumber">4.2.5<tt>&nbsp;</tt></span><a href="#%28part._workshop-relay-ii%29" class="tocsubseclink" data-pltdoc="x">Interaction Introduction</a></td></tr><tr><td><span class="tocsublinknumber">4.2.6<tt>&nbsp;</tt></span><a href="#%28part._workshop-relay-de%29" class="tocsubseclink" data-pltdoc="x">Deployment Decisions</a></td></tr><tr><td><span class="tocsublinknumber">4.2.7<tt>&nbsp;</tt></span><a href="#%28part._workshop-relay-dns%29" class="tocsubseclink" data-pltdoc="x">Discussion and Next Steps</a></td></tr></table></div></div><div class="maincolumn"><div class="main"><div class="versionbox"><span class="version">0.1.2</span></div><div class="navsettop"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="workshop-hash-lock.html" title="backward to &quot;4.1 Workshop: Hash Lock&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="workshop.html" title="up to &quot;4 Workshop&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="workshop-trust-fund.html" title="forward to &quot;4.3 Workshop: Trust Fund&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div><h4>4.2<tt>&nbsp;</tt><a name="(part._workshop-relay)"></a>Workshop: Relay Account</h4><p>In this workshop, we&rsquo;ll revisit the problem of allowing a payer to transfer funds to another party before knowing their identity.
However, unlike in <a href="workshop-hash-lock.html" data-pltdoc="x">Workshop: Hash Lock</a>, we will use a technique that is safe against malicious miners.
One deployment of a decentralized application like this is as a "gift card" where a funder provides a fixed amount of currency to another without knowing their identity.</p><p><div class="SIntrapara"><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>This workshop assumes that you have recently completed <a href="workshop-hash-lock.html" data-pltdoc="x">Workshop: Hash Lock</a>.</p></blockquote></blockquote></blockquote></div><div class="SIntrapara">We assume that you&rsquo;ll go through this workshop in a directory named <span class="stt">~/reach/workshop-relay</span>:
</div><div class="SIntrapara"><span class="hspace">&nbsp;&nbsp;</span><span style="font-weight: bold"><span class="stt">$</span></span><span class="stt"> </span><span class="stt">mkdir -p ~/reach/</span><span class="stt">workshop-relay</span></div></p><p><div class="SIntrapara">And that you have a copy of Reach <a href="install.html" data-pltdoc="x">installed</a> in <span class="stt">~/reach</span> so you can write
</div><div class="SIntrapara"><span class="hspace">&nbsp;&nbsp;</span><span style="font-weight: bold"><span class="stt">$</span></span><span class="stt"> </span><span class="stt">../reach version</span></div></p><p>And it will run Reach.</p><p><div class="SIntrapara">You should start off by initializing your Reach program:
</div><div class="SIntrapara"><span class="hspace">&nbsp;&nbsp;</span><span style="font-weight: bold"><span class="stt">$</span></span><span class="stt"> </span><span class="stt">../reach init</span></div></p><h5>4.2.1<tt>&nbsp;</tt><a name="(part._workshop-relay-pr)"></a>Problem Analysis</h5><p>For this workshop, we&rsquo;ll provide some constraints on your solution and problem analysis, since we&rsquo;d like you to explore writing a Reach program with a specific design.</p><p><div class="SIntrapara">The overall purpose of this application is so that:
</div><div class="SIntrapara"><ul><li><p>Alice can decide an amount of funds to provide.</p></li><li><p>Alice later decide who will have access to this by sharing a secret with them.
We call this person, Bob.</p></li><li><p>Bob can transfer the funds to wherever he&rsquo;d like.</p></li></ul></div></p><p>In <a href="workshop-hash-lock.html" data-pltdoc="x">Workshop: Hash Lock</a>, we designed the application so that the "secret" was a special number that the <a href="ref-model.html#%28tech._contract%29" class="techoutside" data-pltdoc="x"><span class="techinside">contract</span></a> compared against a known <a href="ref-model.html#%28tech._digest%29" class="techoutside" data-pltdoc="x"><span class="techinside">digest</span></a> to release the funds.
This approach was flawed, because when Bob used the secret to gain access, it was possible for anyone else to see the transaction and attempt to play it themselves.</p><p>In today&rsquo;s workshop, we&rsquo;ll use a crucial insight about decentralized applications: account ownership is fluid and account credentials are a form of secret knowledge that every <a href="ref-model.html#%28tech._consensus._network%29" class="techoutside" data-pltdoc="x"><span class="techinside">consensus network</span></a> builds in to their foundation.
With that in mind, let&rsquo;s use the following design:</p><blockquote class="SCentered"><p>Alice will represent her secret as an account that is authorized to withdraw the funds.</p></blockquote><p>This is called a <a name="(tech._relay._account)"></a><span style="font-style: italic">relay account</span>, because it exists temporarily to faciliate the relaying of funds from Alice to Bob.</p><p><div class="SIntrapara">With this in mind, let&rsquo;s answer the questions:
</div><div class="SIntrapara"><ul><li><p>Who are the principals of the application?</p></li><li><p>What are the participants of the program?</p></li><li><p>What information do they know at the start of the program?</p></li><li><p>What information are they going to discover and use in the program?</p></li><li><p>What funds change ownership during the application and how?</p></li></ul></div></p><blockquote class="SCentered"><p><br/><br/><br/><span style="font-weight: bold">Stop!</span><br/>Write down the problem analysis of this program as a comment.<br/><br/><br/><br/></p></blockquote><p>Let&rsquo;s see how your answers compare to our answers:</p><ul><li><p>This application involves two principals: Alice, who sends funds, and Bob, who receives funds.</p></li><li><p>The program has two participants: Alice, who initiates the application, and the Relay, which transfers the funds to Bob.</p></li><li><p>Alice starts knowing the amount she wants to transfer.</p></li><li><p>Alice creates the Relay account, while the Relay account learns the address of Bob, who will receive the funds.</p></li><li><p>The funds start with Alice and then move to Bob under the instruction of the Relay.</p></li></ul><p>The most surprising thing about this application is that Bob is not one of the participants in the application!
Of course, the Relay will actually run under the auspices of Bob, after Alice shares the account credentials with him, but there is a distinction in the program between Bob&rsquo;s identity and the Relay&rsquo;s.</p><h5>4.2.2<tt>&nbsp;</tt><a name="(part._workshop-relay-dd)"></a>Data Definition</h5><p>The next step of designing our program is representing this information in our program and deciding the <a href="ref-programs-module.html#%28tech._participant._interact._interface%29" class="techoutside" data-pltdoc="x"><span class="techinside">participant interact interface</span></a> for each participant.
Which pieces of information go with which participants?
Which are functions and which are values?
Finally, how should the Relay account information and Bob&rsquo;s identity be represented?
(Hint: Reach has a type named <code class="highlight"><a href="ref-programs-compute.html#%28reach._%28%28.Address%29%29%29" class="nb" data-pltdoc="x">Address</a></code> that represents an account <a href="ref-model.html#%28tech._addres%29" class="techoutside" data-pltdoc="x"><span class="techinside">address</span></a>!)</p><blockquote class="SCentered"><p><br/><br/><br/><span style="font-weight: bold">Stop!</span><br/>Write down the data definitions for this program as definitions.<br/><br/><br/><br/></p></blockquote><p>Let&rsquo;s compare notes again.
Here&rsquo;s what we wrote in our program:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/workshop-relay/index.rsh#L5-L7"><span class="stt">workshop-relay/index.rsh</span></a><button class="btn" data-clipboard-text="  [['Alice', { amt : UInt256,
               getRelay: Fun([], Address) }],
   ['Relay', { getBob: Fun([], Address) }] ],"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
 <span class="mi">5</span>    <span class="p">[[</span><span class="s1">&#39;Alice&#39;</span><span class="p">,</span> <span class="p">{</span> <font class="badlink"><span class="nx">amt</span></font> <font class="badlink"><span class="o">:</span></font> <a href="ref-programs-compute.html#%28reach._%28%28.U.Int256%29%29%29" class="nb" data-pltdoc="x">UInt256</a><span class="p">,</span>
 <span class="mi">6</span>                 <font class="badlink"><span class="nx">getRelay</span></font><font class="badlink"><span class="o">:</span></font> <a href="ref-programs-compute.html#%28reach._%28%28.Fun%29%29%29" class="nb" data-pltdoc="x">Fun</a><span class="p">([],</span> <a href="ref-programs-compute.html#%28reach._%28%28.Address%29%29%29" class="nb" data-pltdoc="x">Address</a><span class="p">)</span> <span class="p">}],</span>
 <span class="mi">7</span>     <span class="p">[</span><span class="s1">&#39;Relay&#39;</span><span class="p">,</span> <span class="p">{</span> <font class="badlink"><span class="nx">getBob</span></font><font class="badlink"><span class="o">:</span></font> <a href="ref-programs-compute.html#%28reach._%28%28.Fun%29%29%29" class="nb" data-pltdoc="x">Fun</a><span class="p">([],</span> <a href="ref-programs-compute.html#%28reach._%28%28.Address%29%29%29" class="nb" data-pltdoc="x">Address</a><span class="p">)</span> <span class="p">}]</span> <span class="p">],</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div></div></p><p>We chose to represent the amount as a <code class="highlight"><a href="ref-programs-compute.html#%28reach._%28%28.U.Int256%29%29%29" class="nb" data-pltdoc="x">UInt256</a></code> field, which should be unsurprising.
We then have two functions that take no arguments and return an <code class="highlight"><a href="ref-programs-compute.html#%28reach._%28%28.Address%29%29%29" class="nb" data-pltdoc="x">Address</a></code> which respectively return the Relay identity and the Bob identity.
The idea here is that Alice will create the Relay account in the midst of the program and Bob will provide his own identity when he&rsquo;s acting as Relay.</p><h5>4.2.3<tt>&nbsp;</tt><a name="(part._workshop-relay-cc)"></a>Communication Construction</h5><p>Now, we can write down the structure of communication and action in our application.
Try this on your own based on your experience with <a href="workshop-hash-lock.html" data-pltdoc="x">Workshop: Hash Lock</a>.</p><blockquote class="SCentered"><p><br/><br/><br/><span style="font-weight: bold">Stop!</span><br/>Write down the communication pattern for this program as comments.<br/><br/><br/><br/></p></blockquote><p>Here&rsquo;s what we wrote:
<div class="highlight"><pre><span></span><span class="c1">// 1. Alice pays the amount and says who the Relay is.</span>
<span class="c1">// 2. The consensus remembers who the Relay is.</span>
<span class="c1">// 3. The Relay publishes who Bob is.</span>
<span class="c1">// 4. The consensus pays Bob.</span>
</pre></div></p><p>We assume that most of you found it natural to think of steps one, three, and four, but found step two to be a strange addition.
Perhaps you felt that step two is implied by step one, where Alice says who the Relay is.
But, it all depends upon what the meaning of the word "is" is.
Since that is unclear to some, we&rsquo;ll make it explicit by stating that the consensus will remember the Relay&rsquo;s identity.</p><p>The next step is to convert this pattern into actual program code using <code class="highlight"><a href="ref-programs-step.html#%28reach._%28%28publish%29%29%29" class="k" data-pltdoc="x">publish</a></code>, <code class="highlight"><a href="ref-programs-step.html#%28reach._%28%28pay%29%29%29" class="k" data-pltdoc="x">pay</a></code>, and <code class="highlight"><a href="ref-programs-consensus.html#%28reach._%28%28commit%29%29%29" class="k" data-pltdoc="x">commit</a></code>.
However, we expect that you&rsquo;ll need a bit of help with step two.
Reach has a special operation, available only in <a href="ref-model.html#%28tech._consensus._step%29" class="techoutside" data-pltdoc="x"><span class="techinside">consensus steps</span></a>, for asserting the identity of a participant: <code class="highlight"><a href="ref-programs-consensus.html#%28reach._%28%28.Participant%29%29%29" class="nb" data-pltdoc="x">Participant</a><span class="p">.</span><a href="ref-programs-compute.html#%28reach._%28%28set%29%29%29" class="nx" data-pltdoc="x">set</a></code>.
You can write <code class="highlight"><font class="badlink"><span class="nx">Relay</span></font><span class="p">.</span><a href="ref-programs-compute.html#%28reach._%28%28set%29%29%29" class="nx" data-pltdoc="x">set</a><span class="p">(</span><font class="badlink"><span class="nx">someAddr</span></font><span class="p">)</span></code> to assert that the address of the Relay is <code class="highlight"><font class="badlink"><span class="nx">someAddr</span></font></code>.
With that in mind...</p><blockquote class="SCentered"><p><br/><br/><br/><span style="font-weight: bold">Stop!</span><br/>Write down the communication pattern for this program as code.<br/><br/><br/><br/></p></blockquote><p>The body of your application should look something like:
<div class="highlight"><pre><span></span><span class="c1">// 1. Alice pays the amount and says who the Relay is.</span>
<font class="badlink"><span class="nx">Alice</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28publish%29%29%29" class="k" data-pltdoc="x">publish</a><span class="p">(</span><font class="badlink"><span class="nx">amt</span></font><span class="p">,</span> <font class="badlink"><span class="nx">relay</span></font><span class="p">)</span>
  <span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28pay%29%29%29" class="k" data-pltdoc="x">pay</a><span class="p">(</span><font class="badlink"><span class="nx">amt</span></font><span class="p">);</span>

<span class="c1">// 2. The consensus remembers who the Relay is.</span>
<font class="badlink"><span class="nx">Relay</span></font><span class="p">.</span><a href="ref-programs-compute.html#%28reach._%28%28set%29%29%29" class="nx" data-pltdoc="x">set</a><span class="p">(</span><font class="badlink"><span class="nx">relay</span></font><span class="p">);</span>
<a href="ref-programs-consensus.html#%28reach._%28%28commit%29%29%29" class="k" data-pltdoc="x">commit</a><span class="p">();</span>

<span class="c1">// 3. The Relay publishes who Bob is.</span>
<font class="badlink"><span class="nx">Relay</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28publish%29%29%29" class="k" data-pltdoc="x">publish</a><span class="p">(</span><font class="badlink"><span class="nx">bob</span></font><span class="p">);</span>

<span class="c1">// 4. The consensus pays Bob.</span>
<a href="ref-programs-consensus.html#%28reach._%28%28transfer%29%29%29" class="k" data-pltdoc="x">transfer</a><span class="p">(</span><font class="badlink"><span class="nx">amt</span></font><span class="p">).</span><font class="badlink"><span class="nx">to</span></font><span class="p">(</span><font class="badlink"><span class="nx">bob</span></font><span class="p">);</span>
<a href="ref-programs-consensus.html#%28reach._%28%28commit%29%29%29" class="k" data-pltdoc="x">commit</a><span class="p">();</span>
</pre></div></p><p>We expect that for most of you, the coding of step four is also a bit strange, because we&rsquo;ve never seen an example where the destination of a transfer is not a <a href="ref-model.html#%28tech._participant%29" class="techoutside" data-pltdoc="x"><span class="techinside">participant</span></a>.
You may have thought that the <code class="highlight"><font class="badlink"><span class="nx">to</span></font></code> position in a <code class="highlight"><a href="ref-programs-consensus.html#%28reach._%28%28transfer%29%29%29" class="k" data-pltdoc="x">transfer</a></code> must be a participant, but actually it can be any address.
Participants, however, can be used as addresses if they are bound.</p><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>You might like to re-write this program to have a third participant, Bob, who takes no actions, and try to write <code class="highlight"><a href="ref-programs-consensus.html#%28reach._%28%28transfer%29%29%29" class="k" data-pltdoc="x">transfer</a><span class="p">(</span><font class="badlink"><span class="nx">amt</span></font><span class="p">).</span><font class="badlink"><span class="nx">to</span></font><span class="p">(</span><font class="badlink"><span class="nx">Bob</span></font><span class="p">)</span></code>.
You&rsquo;ll find that Reach rejects this program because Bob is not bound.
You can correct this by adding <code class="highlight"><font class="badlink"><span class="nx">Bob</span></font><span class="p">.</span><a href="ref-programs-compute.html#%28reach._%28%28set%29%29%29" class="nx" data-pltdoc="x">set</a><span class="p">(</span><font class="badlink"><span class="nx">bob</span></font><span class="p">)</span></code> after the Relay publishes Bob&rsquo;s address.
There&rsquo;s nothing better about this version of the program, but it is unneccessary to have a participant like Bob that performs no part in the computation.</p></blockquote></blockquote></blockquote><h5>4.2.4<tt>&nbsp;</tt><a name="(part._workshop-relay-ai)"></a>Assertion Insertion</h5><p>As usual, we should consider what assertions we can add to our program.
In some ways this is what we just did with the <code class="highlight"><font class="badlink"><span class="nx">Relay</span></font><span class="p">.</span><a href="ref-programs-compute.html#%28reach._%28%28set%29%29%29" class="nx" data-pltdoc="x">set</a><span class="p">(</span><font class="badlink"><span class="nx">relay</span></font><span class="p">)</span></code> line above, but that is unlike a normal assertion in that it is added primarily to direct the runtime activities on the consensus <a href="ref-model.html#%28tech._contract%29" class="techoutside" data-pltdoc="x"><span class="techinside">contract</span></a>, rather than as a statement about the logical properties of our program variables.</p><p>Sometimes it can be difficult to decide which things are <span class="emph">part of</span> the application, like this, and which things are <span class="emph">properties of</span> the application, like the assertions we&rsquo;ve seen before.
This is a general problem in verification where the logical properties of the <span class="emph">desired</span> program are often mixed up with the logical properties of the <span class="emph">actual</span> program.
If you&rsquo;re interested in this topic, you might like to spend time reading about <a href="https://en.wikipedia.org/wiki/Formal_specification">formal specification on Wikipedia</a>.</p><p>Now, if we were devious, we might send you on SNARK hunt after some more assertions to add to our program.
But, we&rsquo;re not mean any more, so we&rsquo;ll just tell you that there&rsquo;s nothing else to assert about this program.</p><h5>4.2.5<tt>&nbsp;</tt><a name="(part._workshop-relay-ii)"></a>Interaction Introduction</h5><p>Next, we need to insert the appropriate calls to <code class="highlight"><a href="ref-programs-local.html#%28reach._%28%28interact%29%29%29" class="k" data-pltdoc="x">interact</a></code>.
In this case, our program is very simple and we expect you&rsquo;ll do a great job without further discussion.</p><blockquote class="SCentered"><p><br/><br/><br/><span style="font-weight: bold">Stop!</span><br/>Insert <code class="highlight"><a href="ref-programs-local.html#%28reach._%28%28interact%29%29%29" class="k" data-pltdoc="x">interact</a></code> calls to the <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a> into the program.<br/><br/><br/><br/></p></blockquote><p>Let&rsquo;s look at our whole program now:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/workshop-relay/index.rsh"><span class="stt">workshop-relay/index.rsh</span></a><button class="btn" data-clipboard-text="'reach 0.1';

export const main = Reach.App(
  { deployMode: 'firstMsg' },
  [['Alice', { amt : UInt256,
               getRelay: Fun([], Address) }],
   ['Relay', { getBob: Fun([], Address) }] ],
  (Alice, Relay) =&gt; {
    Alice.only(() =&gt; {
      const [ amt, relay ] =
            declassify([ interact.amt,
                         interact.getRelay()]); });
    Alice.publish(amt, relay)
      .pay(amt);
    Relay.set(relay);
    commit();

    Relay.only(() =&gt; {
      const bob = declassify(interact.getBob()); });
    Relay.publish(bob);
    transfer(amt).to(bob);
    commit();

    exit(); } );"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span> <span class="mi">1</span>    <span class="s1">&#39;reach 0.1&#39;</span><span class="p">;</span>
 <span class="mi">2</span>    
 <span class="mi">3</span>    <a href="ref-programs-module.html#%28reach._%28%28export%29%29%29" class="kd" data-pltdoc="x">export</a> <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">main</span></font> <font class="badlink"><span class="o">=</span></font> <a href="ref-programs-module.html#%28reach._%28%28.Reach%29%29%29" class="nb" data-pltdoc="x">Reach</a><span class="p">.</span><a href="ref-programs-module.html#%28reach._%28%28.App%29%29%29" class="nb" data-pltdoc="x">App</a><span class="p">(</span>
 <span class="mi">4</span>      <span class="p">{</span> <a href="ref-programs-module.html#%28reach._%28%28deploy.Mode%29%29%29" class="nb" data-pltdoc="x">deployMode</a><font class="badlink"><span class="o">:</span></font> <span class="s1">&#39;firstMsg&#39;</span> <span class="p">},</span>
 <span class="mi">5</span>      <span class="p">[[</span><span class="s1">&#39;Alice&#39;</span><span class="p">,</span> <span class="p">{</span> <font class="badlink"><span class="nx">amt</span></font> <font class="badlink"><span class="o">:</span></font> <a href="ref-programs-compute.html#%28reach._%28%28.U.Int256%29%29%29" class="nb" data-pltdoc="x">UInt256</a><span class="p">,</span>
 <span class="mi">6</span>                   <font class="badlink"><span class="nx">getRelay</span></font><font class="badlink"><span class="o">:</span></font> <a href="ref-programs-compute.html#%28reach._%28%28.Fun%29%29%29" class="nb" data-pltdoc="x">Fun</a><span class="p">([],</span> <a href="ref-programs-compute.html#%28reach._%28%28.Address%29%29%29" class="nb" data-pltdoc="x">Address</a><span class="p">)</span> <span class="p">}],</span>
 <span class="mi">7</span>       <span class="p">[</span><span class="s1">&#39;Relay&#39;</span><span class="p">,</span> <span class="p">{</span> <font class="badlink"><span class="nx">getBob</span></font><font class="badlink"><span class="o">:</span></font> <a href="ref-programs-compute.html#%28reach._%28%28.Fun%29%29%29" class="nb" data-pltdoc="x">Fun</a><span class="p">([],</span> <a href="ref-programs-compute.html#%28reach._%28%28.Address%29%29%29" class="nb" data-pltdoc="x">Address</a><span class="p">)</span> <span class="p">}]</span> <span class="p">],</span>
 <span class="mi">8</span>      <span class="p">(</span><font class="badlink"><span class="nx">Alice</span></font><span class="p">,</span> <font class="badlink"><span class="nx">Relay</span></font><span class="p">)</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a> <span class="p">{</span>
 <span class="mi">9</span>        <font class="badlink"><span class="nx">Alice</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28only%29%29%29" class="k" data-pltdoc="x">only</a><span class="p">(()</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a> <span class="p">{</span>
<span class="mi">10</span>          <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <span class="p">[</span> <font class="badlink"><span class="nx">amt</span></font><span class="p">,</span> <font class="badlink"><span class="nx">relay</span></font> <span class="p">]</span> <font class="badlink"><span class="o">=</span></font>
<span class="mi">11</span>                <a href="ref-programs-local.html#%28reach._%28%28declassify%29%29%29" class="k" data-pltdoc="x">declassify</a><span class="p">([</span> <a href="ref-programs-local.html#%28reach._%28%28interact%29%29%29" class="k" data-pltdoc="x">interact</a><span class="p">.</span><font class="badlink"><span class="nx">amt</span></font><span class="p">,</span>
<span class="mi">12</span>                             <a href="ref-programs-local.html#%28reach._%28%28interact%29%29%29" class="k" data-pltdoc="x">interact</a><span class="p">.</span><font class="badlink"><span class="nx">getRelay</span></font><span class="p">()]);</span> <span class="p">});</span>
<span class="mi">13</span>        <font class="badlink"><span class="nx">Alice</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28publish%29%29%29" class="k" data-pltdoc="x">publish</a><span class="p">(</span><font class="badlink"><span class="nx">amt</span></font><span class="p">,</span> <font class="badlink"><span class="nx">relay</span></font><span class="p">)</span>
<span class="mi">14</span>          <span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28pay%29%29%29" class="k" data-pltdoc="x">pay</a><span class="p">(</span><font class="badlink"><span class="nx">amt</span></font><span class="p">);</span>
<span class="mi">15</span>        <font class="badlink"><span class="nx">Relay</span></font><span class="p">.</span><a href="ref-programs-compute.html#%28reach._%28%28set%29%29%29" class="nx" data-pltdoc="x">set</a><span class="p">(</span><font class="badlink"><span class="nx">relay</span></font><span class="p">);</span>
<span class="mi">16</span>        <a href="ref-programs-consensus.html#%28reach._%28%28commit%29%29%29" class="k" data-pltdoc="x">commit</a><span class="p">();</span>
<span class="mi">17</span>    
<span class="mi">18</span>        <font class="badlink"><span class="nx">Relay</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28only%29%29%29" class="k" data-pltdoc="x">only</a><span class="p">(()</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a> <span class="p">{</span>
<span class="mi">19</span>          <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">bob</span></font> <font class="badlink"><span class="o">=</span></font> <a href="ref-programs-local.html#%28reach._%28%28declassify%29%29%29" class="k" data-pltdoc="x">declassify</a><span class="p">(</span><a href="ref-programs-local.html#%28reach._%28%28interact%29%29%29" class="k" data-pltdoc="x">interact</a><span class="p">.</span><font class="badlink"><span class="nx">getBob</span></font><span class="p">());</span> <span class="p">});</span>
<span class="mi">20</span>        <font class="badlink"><span class="nx">Relay</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28publish%29%29%29" class="k" data-pltdoc="x">publish</a><span class="p">(</span><font class="badlink"><span class="nx">bob</span></font><span class="p">);</span>
<span class="mi">21</span>        <a href="ref-programs-consensus.html#%28reach._%28%28transfer%29%29%29" class="k" data-pltdoc="x">transfer</a><span class="p">(</span><font class="badlink"><span class="nx">amt</span></font><span class="p">).</span><font class="badlink"><span class="nx">to</span></font><span class="p">(</span><font class="badlink"><span class="nx">bob</span></font><span class="p">);</span>
<span class="mi">22</span>        <a href="ref-programs-consensus.html#%28reach._%28%28commit%29%29%29" class="k" data-pltdoc="x">commit</a><span class="p">();</span>
<span class="mi">23</span>    
<span class="mi">24</span>        <a href="ref-programs-step.html#%28reach._%28%28exit%29%29%29" class="k" data-pltdoc="x">exit</a><span class="p">();</span> <span class="p">}</span> <span class="p">);</span>
</pre></div></div></p><h5>4.2.6<tt>&nbsp;</tt><a name="(part._workshop-relay-de)"></a>Deployment Decisions</h5><p>This program is a bit odd to test, because it relies on Alice creating a temporary account and then sharing its information with Bob.
We don&rsquo;t know of any beautiful way to derive this program from first principles, and instead must appeal to your JavaScript programming skills.
If you&rsquo;d like a hint, remember that you can call <code class="highlight"><a href="ref-backend-js.html#%28javascript._%28%28stdlib%29%29%29" class="nx" data-pltdoc="x">stdlib</a><span class="p">.</span><a href="ref-backend-js.html#%28javascript._%28%28new.Test.Account%29%29%29" class="nx" data-pltdoc="x">newTestAccount</a></code> any number of times and that a <a href="ref-model.html#%28tech._backend%29" class="techoutside" data-pltdoc="x"><span class="techinside">backend</span></a>&rsquo;s participant functions don&rsquo;t need to be called at the same time.</p><p>If you&rsquo;re brave, then try it yourself; otherwise, scroll down to see our solution.</p><blockquote class="SCentered"><p><br/><br/><br/><span style="font-weight: bold">Stop!</span><br/>Decide how you will deploy and use this application.<br/><br/><br/><br/></p></blockquote><p>Here&rsquo;s the JavaScript <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a> we wrote:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/workshop-relay/index.mjs"><span class="stt">workshop-relay/index.mjs</span></a><button class="btn" data-clipboard-text="import * as stdlib from '@reach-sh/stdlib/ETH.mjs';
import * as backend from './build/index.main.mjs';

(async () =&gt; {
  const startingBalance = stdlib.parseCurrency({ETH: 100});

  const accAlice = await stdlib.newTestAccount(startingBalance);
  const accBob = await stdlib.newTestAccount(startingBalance);

  const getBalance = async (who) =&gt;
        stdlib.formatCurrency(await stdlib.balanceOf(who), 4);
  const beforeAlice = await getBalance(accAlice);
  const beforeBob = await getBalance(accBob);

  const ctcAlice = await accAlice.deploy(backend);

  let accRelayProvide = null;
  const accRelayP = new Promise((resolve, reject) =&gt; {
    accRelayProvide = resolve;
  });

  await Promise.all([
    backend.Alice(stdlib, ctcAlice, {
      amt: stdlib.parseCurrency({ETH: 25}),
      getRelay: async () =&gt; {
        console.log(`Alice creates a Relay account.`);
        const accRelay = await stdlib.newTestAccount(stdlib.parseCurrency({ETH: 0}));
        console.log(`Alice shares it with Bob outside of the network.`);
        accRelayProvide(accRelay);
        return accRelay.networkAccount.address;
      },
    }),
    (async () =&gt; {
      console.log(`Bob waits for Alice to give him the information about the Relay account.`);
      const accRelay = await accRelayP;
      console.log(`Bob deposits some funds into the Relay to use it.`);
      await stdlib.transfer(accBob, accRelay, stdlib.parseCurrency({ETH: 1}));
      console.log(`Bob attaches to the contract as the Relay.`);
      const ctcRelay = await accRelay.attach(backend, ctcAlice);
      console.log(`Bob joins the application as the Relay.`);
      return backend.Relay(stdlib, ctcRelay, {
        getBob: async () =&gt; {
          console.log(`Bob, acting as the Relay, gives his information.`);
          return accBob.networkAccount.address;
        },
      });
    })(),
  ]);

  const afterAlice = await getBalance(accAlice);
  const afterBob = await getBalance(accBob);

  console.log(`Alice went from ${beforeAlice} to ${afterAlice}.`);
  console.log(`Bob went from ${beforeBob} to ${afterBob}.`);

})();"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span> <span class="mi">1</span>    <a href="ref-programs-module.html#%28reach._%28%28import%29%29%29" class="kd" data-pltdoc="x">import</a> <a href="ref-programs-compute.html#%28reach._%28%28%2A%29%29%29" class="o" data-pltdoc="x">*</a> <font class="badlink"><span class="kd">as</span></font> <font class="badlink"><span class="nx">stdlib</span></font> <a href="ref-programs-module.html#%28reach._%28%28from%29%29%29" class="kd" data-pltdoc="x">from</a> <span class="s1">&#39;@reach-sh/stdlib/ETH.mjs&#39;</span><span class="p">;</span>
 <span class="mi">2</span>    <a href="ref-programs-module.html#%28reach._%28%28import%29%29%29" class="kd" data-pltdoc="x">import</a> <a href="ref-programs-compute.html#%28reach._%28%28%2A%29%29%29" class="o" data-pltdoc="x">*</a> <font class="badlink"><span class="kd">as</span></font> <font class="badlink"><span class="nx">backend</span></font> <a href="ref-programs-module.html#%28reach._%28%28from%29%29%29" class="kd" data-pltdoc="x">from</a> <span class="s1">&#39;./build/index.main.mjs&#39;</span><span class="p">;</span>
 <span class="mi">3</span>    
 <span class="mi">4</span>    <span class="p">(</span><font class="badlink"><span class="nx">async</span></font> <span class="p">()</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a> <span class="p">{</span>
 <span class="mi">5</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">startingBalance</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">stdlib</span></font><span class="p">.</span><font class="badlink"><span class="nx">parseCurrency</span></font><span class="p">({</span><font class="badlink"><span class="nx">ETH</span></font><font class="badlink"><span class="o">:</span></font> <span class="mi">100</span><span class="p">});</span>
 <span class="mi">6</span>    
 <span class="mi">7</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">accAlice</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">await</span></font> <font class="badlink"><span class="nx">stdlib</span></font><span class="p">.</span><font class="badlink"><span class="nx">newTestAccount</span></font><span class="p">(</span><font class="badlink"><span class="nx">startingBalance</span></font><span class="p">);</span>
 <span class="mi">8</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">accBob</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">await</span></font> <font class="badlink"><span class="nx">stdlib</span></font><span class="p">.</span><font class="badlink"><span class="nx">newTestAccount</span></font><span class="p">(</span><font class="badlink"><span class="nx">startingBalance</span></font><span class="p">);</span>
 <span class="mi">9</span>    
<span class="mi">10</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">getBalance</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">async</span></font> <span class="p">(</span><font class="badlink"><span class="nx">who</span></font><span class="p">)</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a>
<span class="mi">11</span>            <font class="badlink"><span class="nx">stdlib</span></font><span class="p">.</span><font class="badlink"><span class="nx">formatCurrency</span></font><span class="p">(</span><font class="badlink"><span class="nx">await</span></font> <font class="badlink"><span class="nx">stdlib</span></font><span class="p">.</span><font class="badlink"><span class="nx">balanceOf</span></font><span class="p">(</span><font class="badlink"><span class="nx">who</span></font><span class="p">),</span> <span class="mi">4</span><span class="p">);</span>
<span class="mi">12</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">beforeAlice</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">await</span></font> <font class="badlink"><span class="nx">getBalance</span></font><span class="p">(</span><font class="badlink"><span class="nx">accAlice</span></font><span class="p">);</span>
<span class="mi">13</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">beforeBob</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">await</span></font> <font class="badlink"><span class="nx">getBalance</span></font><span class="p">(</span><font class="badlink"><span class="nx">accBob</span></font><span class="p">);</span>
<span class="mi">14</span>    
<span class="mi">15</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">ctcAlice</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">await</span></font> <font class="badlink"><span class="nx">accAlice</span></font><span class="p">.</span><font class="badlink"><span class="nx">deploy</span></font><span class="p">(</span><font class="badlink"><span class="nx">backend</span></font><span class="p">);</span>
<span class="mi">16</span>    
<span class="mi">17</span>      <font class="badlink"><span class="kd">let</span></font> <font class="badlink"><span class="nx">accRelayProvide</span></font> <font class="badlink"><span class="o">=</span></font> <a href="ref-programs-compute.html#%28reach._%28%28null%29%29%29" class="kc" data-pltdoc="x">null</a><span class="p">;</span>
<span class="mi">18</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">accRelayP</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="k">new</span></font> <font class="badlink"><span class="nb">Promise</span></font><span class="p">((</span><font class="badlink"><span class="nx">resolve</span></font><span class="p">,</span> <font class="badlink"><span class="nx">reject</span></font><span class="p">)</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a> <span class="p">{</span>
<span class="mi">19</span>        <font class="badlink"><span class="nx">accRelayProvide</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">resolve</span></font><span class="p">;</span>
<span class="mi">20</span>      <span class="p">});</span>
<span class="mi">21</span>    
<span class="mi">22</span>      <font class="badlink"><span class="nx">await</span></font> <font class="badlink"><span class="nb">Promise</span></font><span class="p">.</span><font class="badlink"><span class="nx">all</span></font><span class="p">([</span>
<span class="mi">23</span>        <font class="badlink"><span class="nx">backend</span></font><span class="p">.</span><font class="badlink"><span class="nx">Alice</span></font><span class="p">(</span><font class="badlink"><span class="nx">stdlib</span></font><span class="p">,</span> <font class="badlink"><span class="nx">ctcAlice</span></font><span class="p">,</span> <span class="p">{</span>
<span class="mi">24</span>          <font class="badlink"><span class="nx">amt</span></font><font class="badlink"><span class="o">:</span></font> <font class="badlink"><span class="nx">stdlib</span></font><span class="p">.</span><font class="badlink"><span class="nx">parseCurrency</span></font><span class="p">({</span><font class="badlink"><span class="nx">ETH</span></font><font class="badlink"><span class="o">:</span></font> <span class="mi">25</span><span class="p">}),</span>
<span class="mi">25</span>          <font class="badlink"><span class="nx">getRelay</span></font><font class="badlink"><span class="o">:</span></font> <font class="badlink"><span class="nx">async</span></font> <span class="p">()</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a> <span class="p">{</span>
<span class="mi">26</span>            <font class="badlink"><span class="nx">console</span></font><span class="p">.</span><font class="badlink"><span class="nx">log</span></font><span class="p">(</span><span class="sb">`Alice creates a Relay account.`</span><span class="p">);</span>
<span class="mi">27</span>            <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">accRelay</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">await</span></font> <font class="badlink"><span class="nx">stdlib</span></font><span class="p">.</span><font class="badlink"><span class="nx">newTestAccount</span></font><span class="p">(</span><font class="badlink"><span class="nx">stdlib</span></font><span class="p">.</span><font class="badlink"><span class="nx">parseCurrency</span></font><span class="p">({</span><font class="badlink"><span class="nx">ETH</span></font><font class="badlink"><span class="o">:</span></font> <span class="mi">0</span><span class="p">}));</span>
<span class="mi">28</span>            <font class="badlink"><span class="nx">console</span></font><span class="p">.</span><font class="badlink"><span class="nx">log</span></font><span class="p">(</span><span class="sb">`Alice shares it with Bob outside of the network.`</span><span class="p">);</span>
<span class="mi">29</span>            <font class="badlink"><span class="nx">accRelayProvide</span></font><span class="p">(</span><font class="badlink"><span class="nx">accRelay</span></font><span class="p">);</span>
<span class="mi">30</span>            <a href="ref-programs-compute.html#%28reach._%28%28return%29%29%29" class="k" data-pltdoc="x">return</a> <font class="badlink"><span class="nx">accRelay</span></font><span class="p">.</span><font class="badlink"><span class="nx">networkAccount</span></font><span class="p">.</span><font class="badlink"><span class="nx">address</span></font><span class="p">;</span>
<span class="mi">31</span>          <span class="p">},</span>
<span class="mi">32</span>        <span class="p">}),</span>
<span class="mi">33</span>        <span class="p">(</span><font class="badlink"><span class="nx">async</span></font> <span class="p">()</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a> <span class="p">{</span>
<span class="mi">34</span>          <font class="badlink"><span class="nx">console</span></font><span class="p">.</span><font class="badlink"><span class="nx">log</span></font><span class="p">(</span><span class="sb">`Bob waits for Alice to give him the information about the Relay account.`</span><span class="p">);</span>
<span class="mi">35</span>          <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">accRelay</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">await</span></font> <font class="badlink"><span class="nx">accRelayP</span></font><span class="p">;</span>
<span class="mi">36</span>          <font class="badlink"><span class="nx">console</span></font><span class="p">.</span><font class="badlink"><span class="nx">log</span></font><span class="p">(</span><span class="sb">`Bob deposits some funds into the Relay to use it.`</span><span class="p">);</span>
<span class="mi">37</span>          <font class="badlink"><span class="nx">await</span></font> <font class="badlink"><span class="nx">stdlib</span></font><span class="p">.</span><a href="ref-programs-consensus.html#%28reach._%28%28transfer%29%29%29" class="k" data-pltdoc="x">transfer</a><span class="p">(</span><font class="badlink"><span class="nx">accBob</span></font><span class="p">,</span> <font class="badlink"><span class="nx">accRelay</span></font><span class="p">,</span> <font class="badlink"><span class="nx">stdlib</span></font><span class="p">.</span><font class="badlink"><span class="nx">parseCurrency</span></font><span class="p">({</span><font class="badlink"><span class="nx">ETH</span></font><font class="badlink"><span class="o">:</span></font> <span class="mi">1</span><span class="p">}));</span>
<span class="mi">38</span>          <font class="badlink"><span class="nx">console</span></font><span class="p">.</span><font class="badlink"><span class="nx">log</span></font><span class="p">(</span><span class="sb">`Bob attaches to the contract as the Relay.`</span><span class="p">);</span>
<span class="mi">39</span>          <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">ctcRelay</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">await</span></font> <font class="badlink"><span class="nx">accRelay</span></font><span class="p">.</span><font class="badlink"><span class="nx">attach</span></font><span class="p">(</span><font class="badlink"><span class="nx">backend</span></font><span class="p">,</span> <font class="badlink"><span class="nx">ctcAlice</span></font><span class="p">);</span>
<span class="mi">40</span>          <font class="badlink"><span class="nx">console</span></font><span class="p">.</span><font class="badlink"><span class="nx">log</span></font><span class="p">(</span><span class="sb">`Bob joins the application as the Relay.`</span><span class="p">);</span>
<span class="mi">41</span>          <a href="ref-programs-compute.html#%28reach._%28%28return%29%29%29" class="k" data-pltdoc="x">return</a> <font class="badlink"><span class="nx">backend</span></font><span class="p">.</span><font class="badlink"><span class="nx">Relay</span></font><span class="p">(</span><font class="badlink"><span class="nx">stdlib</span></font><span class="p">,</span> <font class="badlink"><span class="nx">ctcRelay</span></font><span class="p">,</span> <span class="p">{</span>
<span class="mi">42</span>            <font class="badlink"><span class="nx">getBob</span></font><font class="badlink"><span class="o">:</span></font> <font class="badlink"><span class="nx">async</span></font> <span class="p">()</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a> <span class="p">{</span>
<span class="mi">43</span>              <font class="badlink"><span class="nx">console</span></font><span class="p">.</span><font class="badlink"><span class="nx">log</span></font><span class="p">(</span><span class="sb">`Bob, acting as the Relay, gives his information.`</span><span class="p">);</span>
<span class="mi">44</span>              <a href="ref-programs-compute.html#%28reach._%28%28return%29%29%29" class="k" data-pltdoc="x">return</a> <font class="badlink"><span class="nx">accBob</span></font><span class="p">.</span><font class="badlink"><span class="nx">networkAccount</span></font><span class="p">.</span><font class="badlink"><span class="nx">address</span></font><span class="p">;</span>
<span class="mi">45</span>            <span class="p">},</span>
<span class="mi">46</span>          <span class="p">});</span>
<span class="mi">47</span>        <span class="p">})(),</span>
<span class="mi">48</span>      <span class="p">]);</span>
<span class="mi">49</span>    
<span class="mi">50</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">afterAlice</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">await</span></font> <font class="badlink"><span class="nx">getBalance</span></font><span class="p">(</span><font class="badlink"><span class="nx">accAlice</span></font><span class="p">);</span>
<span class="mi">51</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">afterBob</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">await</span></font> <font class="badlink"><span class="nx">getBalance</span></font><span class="p">(</span><font class="badlink"><span class="nx">accBob</span></font><span class="p">);</span>
<span class="mi">52</span>    
<span class="mi">53</span>      <font class="badlink"><span class="nx">console</span></font><span class="p">.</span><font class="badlink"><span class="nx">log</span></font><span class="p">(</span><span class="sb">`Alice went from </span><span class="si">${</span><font class="badlink"><span class="nx">beforeAlice</span></font><span class="si">}</span><span class="sb"> to </span><span class="si">${</span><font class="badlink"><span class="nx">afterAlice</span></font><span class="si">}</span><span class="sb">.`</span><span class="p">);</span>
<span class="mi">54</span>      <font class="badlink"><span class="nx">console</span></font><span class="p">.</span><font class="badlink"><span class="nx">log</span></font><span class="p">(</span><span class="sb">`Bob went from </span><span class="si">${</span><font class="badlink"><span class="nx">beforeBob</span></font><span class="si">}</span><span class="sb"> to </span><span class="si">${</span><font class="badlink"><span class="nx">afterBob</span></font><span class="si">}</span><span class="sb">.`</span><span class="p">);</span>
<span class="mi">55</span>    
<span class="mi">56</span>    <span class="p">})();</span>
</pre></div></div></p><p><div class="SIntrapara">We do a few sneaky things in this program:
</div><div class="SIntrapara"><ul><li><p>Lines 18 through 20 create a JavaScript <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise</a> that will be filled in later by Alice.</p></li><li><p>Alice&rsquo;s <code class="highlight"><font class="badlink"><span class="nx">getRelay</span></font></code> function (lines 25 through 31) creates the new account and communicates it "outside of the network" through the aforementioned Promise.</p></li><li><p>Bob&rsquo;s thread (lines 33 through 47) waits for the Promise to resolve and then connects to the application with this new account.</p></li><li><p>The Relay&rsquo;s <code class="highlight"><font class="badlink"><span class="nx">getBob</span></font></code> function (lines 42 through 45) returns his own address to receive the funds.</p></li></ul></div></p><p>If this program is scary for you, don&rsquo;t worry!
It uses some fairly esoteric JavaScript features to make a completely automated test of this program.
If instead you wrote it so that it ran interactively and had Bob paste in the information about the new Relay account, it might be easier for you to code with those two aspects totally separated.</p><p>Let&rsquo;s see what it looks like when we run this program:</p><p><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">$ ../reach run</span></p></td></tr><tr><td><p><span class="stt">Alice creates a Relay account.</span></p></td></tr><tr><td><p><span class="stt">Bob waits for Alice to give him the information about the Relay account.</span></p></td></tr><tr><td><p><span class="stt">Alice shares it with Bob off chain.</span></p></td></tr><tr><td><p><span class="stt">Bob deposits some funds into the Relay to use it</span></p></td></tr><tr><td><p><span class="stt">Bob attaches to the contract as the Relay.</span></p></td></tr><tr><td><p><span class="stt">Bob joins the application as the Relay.</span></p></td></tr><tr><td><p><span class="stt">Bob, acting as the Relay, gives his information.</span></p></td></tr><tr><td><p><span class="stt">Alice went from 100.0 to 74.999999999999804065.</span></p></td></tr><tr><td><p><span class="stt">Bob went from 100.0 to 123.999999999999979.</span></p></td></tr></table></p><h5>4.2.7<tt>&nbsp;</tt><a name="(part._workshop-relay-dns)"></a>Discussion and Next Steps</h5><p>Great job!
You could use this application today and start minting gift cards of tokens for your friends on their birthdays!
Wouldn&rsquo;t that be fun?</p><p>If you found this workshop rewarding, please let us know on <a href="https://discord.gg/AZsgcXu">the Discord community</a>!</p><p>If you&rsquo;d like to make this application a little more interesting, maybe you&rsquo;d like to have a secret password just like <a href="workshop-hash-lock.html" data-pltdoc="x">the hash lock</a> as well, so Alice can separate the revealing of information to Bob.</p><p>If you want to know what to do next to advance your study of decentralized application design, a natural extension of the concepts in this workshop is a <a href="workshop-trust-fund.html" data-pltdoc="x">trust fund</a>.
Why don&rsquo;t you check it out?</p><div class="navsetbottom"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="workshop-hash-lock.html" title="backward to &quot;4.1 Workshop: Hash Lock&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="workshop.html" title="up to &quot;4 Workshop&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="workshop-trust-fund.html" title="forward to &quot;4.3 Workshop: Trust Fund&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div><script src="reach-post.js"></script></body></html>