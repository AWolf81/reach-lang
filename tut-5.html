<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-149147406-1"></script><script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-149147406-1');</script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script><script src="tooltips.js"></script><script src="reach-pre.js"></script><link rel="stylesheet" href="tooltips.css"><link rel="stylesheet" href="reach.css"><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>2.6&nbsp;Timeouts and Participation</title><link rel="stylesheet" type="text/css" href="scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-racket.css" title="default"/><link rel="stylesheet" type="text/css" href="minted-solarizedlight-style.css" title="default"/><link rel="stylesheet" type="text/css" href="minted.css" title="default"/><script type="text/javascript" src="scribble-common.js"></script><script type="text/javascript" src="manual-racket.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--></head><body id="scribble-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9658;</a></td><td></td><td><a href="index.html" class="tocviewlink" data-pltdoc="x">Reach:<span class="mywbr"> &nbsp;</span> The Safest and Easiest DApp Programming Language</a></td></tr></table></div><div class="tocviewsublisttop" style="display: none;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="overview.html" class="tocviewlink" data-pltdoc="x">Overview</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="tut.html" class="tocviewselflink" data-pltdoc="x">Tutorial</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="guide.html" class="tocviewlink" data-pltdoc="x">Guide</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="workshop.html" class="tocviewlink" data-pltdoc="x">Workshop</a></td></tr><tr><td align="right">5&nbsp;</td><td><a href="ref.html" class="tocviewlink" data-pltdoc="x">Reference</a></td></tr><tr><td align="right"></td><td><a href="doc-index.html" class="tocviewlink" data-pltdoc="x">Index</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_1&quot;);">&#9660;</a></td><td>2&nbsp;</td><td><a href="tut.html" class="tocviewlink" data-pltdoc="x">Tutorial</a></td></tr></table><div class="tocviewsublistbottom" style="display: block;" id="tocview_1"><table cellspacing="0" cellpadding="0"><tr><td align="right">2.1&nbsp;</td><td><a href="tut-0.html" class="tocviewlink" data-pltdoc="x">Install and Initialize</a></td></tr><tr><td align="right">2.2&nbsp;</td><td><a href="tut-1.html" class="tocviewlink" data-pltdoc="x">Scaffolding and Setup</a></td></tr><tr><td align="right">2.3&nbsp;</td><td><a href="tut-2.html" class="tocviewlink" data-pltdoc="x">Rock, Paper, and Scissors</a></td></tr><tr><td align="right">2.4&nbsp;</td><td><a href="tut-3.html" class="tocviewlink" data-pltdoc="x">Bets and Wagers</a></td></tr><tr><td align="right">2.5&nbsp;</td><td><a href="tut-4.html" class="tocviewlink" data-pltdoc="x">Trust and Commitments</a></td></tr><tr><td align="right">2.6&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Timeouts and Participation</a></td></tr><tr><td align="right">2.7&nbsp;</td><td><a href="tut-6.html" class="tocviewlink" data-pltdoc="x">Play and Play Again</a></td></tr><tr><td align="right">2.8&nbsp;</td><td><a href="tut-7.html" class="tocviewlink" data-pltdoc="x">Interaction and Independence</a></td></tr><tr><td align="right">2.9&nbsp;</td><td><a href="tut-8.html" class="tocviewlink" data-pltdoc="x">Onward and Further</a></td></tr></table></div></div></div></div><div class="maincolumn"><div class="main"><div class="navsettop"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="tut-4.html" title="backward to &quot;2.5 Trust and Commitments&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="tut.html" title="up to &quot;2 Tutorial&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="tut-6.html" title="forward to &quot;2.7 Play and Play Again&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div><h4>2.6<tt>&nbsp;</tt><a name="(part._tut-5)"></a>Timeouts and Participation</h4><p>In the last section, we removed a security vulnerability from <span class="emph">Rock, Paper, Scissors</span> that was a clear attack on the viability of the application.
In this section, we&rsquo;ll focus on a more subtle issue that is important and unique to decentralized applications: <a href="guide-timeout.html" data-pltdoc="x">non-participation</a>.</p><p>Non-participation refers to the act of one party ceasing to continue playing their role in an application.</p><p>In traditional client-server programs, like a Web server, this would be the case of a client stopping sending requests to the server, or the server stopping sending responses to the client.
In these sorts of traditional programs, non-participation is an exceptional circumstances that normally leads to an error message for clients and, at most, a log entry for servers.
Sometimes traditional programs will need to recycle resources, like network ports, on non-participation, but they would have also needed to do that if the transaction ended by normal means.
In other words, for traditional client-server programs, it is not necessary for designers to meticulously consider the consequences of non-participation.</p><p>In contrast, decentralized applications must be carefully designed with an eye towards their behavior in the face of non-participation.
For example, consider what happens in our <span class="emph">Rock, Paper, Scissors</span> game if after Alice has paid her wager, Bob never accepts and the application doesn&rsquo;t continue.
In this case, Alice&rsquo;s <a href="ref-model.html#%28tech._network._token%29" class="techoutside" data-pltdoc="x"><span class="techinside">network tokens</span></a> would be locked inside of the <a href="ref-model.html#%28tech._contract%29" class="techoutside" data-pltdoc="x"><span class="techinside">contract</span></a> and lost to her.
Similarly, if after Bob accepted and paid his wager, Alice stopped participating and never submitted her hand, then both their funds would be locked away forever.
In each of these cases, both parties would be greatly hurt and their fear of that outcome would introduce an additional cost to transacting, which would lower the value they got from participating in the application.
Of course, in a situation like <span class="emph">Rock, Paper, Scissors</span> this is unlikely to be an important matter, but recall that <span class="emph">Rock, Paper, Scissors</span> is a microcosm of decentralized application design.</p><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>Technically, in the first case, when Bob fails to start the application, Alice is not locked away from her funds: since Bob&rsquo;s identity is not fixed until after his first message, she could start another instance of the game as the Bob role and then she&rsquo;d win all of the funds, less any transaction costs of the <a href="ref-model.html#%28tech._consensus._network%29" class="techoutside" data-pltdoc="x"><span class="techinside">consensus network</span></a>.
In the second case, however, there would be no recourse for either party.</p></blockquote></blockquote></blockquote><p>In the rest of this section, we&rsquo;ll discuss how Reach helps address non-participation.
For a longer discussion, refer to <a href="guide-timeout.html" data-pltdoc="x">the guide chapter on non-participation</a>.</p><p><span style="font-weight: bold">&#8212;<wbr></wbr></span></p><p>In Reach, non-participation is handled through a "timeout" mechanism whereby each <a href="ref-model.html#%28tech._consensus._transfer%29" class="techoutside" data-pltdoc="x"><span class="techinside">consensus transfer</span></a> can be paired with a <a href="ref-model.html#%28tech._step%29" class="techoutside" data-pltdoc="x"><span class="techinside">step</span></a> that occurs for all <a href="ref-model.html#%28tech._participant%29" class="techoutside" data-pltdoc="x"><span class="techinside">participants</span></a> if the <a href="ref-model.html#%28tech._originator%29" class="techoutside" data-pltdoc="x"><span class="techinside">originator</span></a> of the <a href="ref-model.html#%28tech._consensus._transfer%29" class="techoutside" data-pltdoc="x"><span class="techinside">consensus transfer</span></a> fails to make the required <a href="ref-model.html#%28tech._publication%29" class="techoutside" data-pltdoc="x"><span class="techinside">publication</span></a> before a particular <a href="ref-model.html#%28tech._time%29" class="techoutside" data-pltdoc="x"><span class="techinside">time</span></a>.
We&rsquo;ll integrate this mechanism into our version of <span class="emph">Rock, Paper, Scissors</span> and deliberately insert non-participation into our JavaScript testing program to watch the consequences play out.</p><p>First, we&rsquo;ll modify the <a href="ref-programs-module.html#%28tech._participant._interact._interface%29" class="techoutside" data-pltdoc="x"><span class="techinside">participant interact interface</span></a> to allow the <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a> to be informed that a timeout occurred.</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-5/index.rsh#L20-L24"><span class="stt">tut-5/index.rsh</span></a><button class="btn" data-clipboard-text="const Player =
      { ...hasRandom,
        getHand: Fun([], UInt256),
        seeOutcome: Fun([UInt256], Null),
        informTimeout: Fun([], Null) };"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">20</span>    <span class="kd">const</span> <span class="nx">Player</span> <span class="o">=</span>
<span class="mi">21</span>          <span class="p">{</span> <span class="p">...</span><span class="nb">hasRandom</span><span class="p">,</span>
<span class="mi">22</span>            <span class="nx">getHand</span><span class="o">:</span> <span class="nb">Fun</span><span class="p">([],</span> <span class="nb">UInt256</span><span class="p">),</span>
<span class="mi">23</span>            <span class="nx">seeOutcome</span><span class="o">:</span> <span class="nb">Fun</span><span class="p">([</span><span class="nb">UInt256</span><span class="p">],</span> <span class="nb">Null</span><span class="p">),</span>
<span class="mi">24</span>            <span class="nx">informTimeout</span><span class="o">:</span> <span class="nb">Fun</span><span class="p">([],</span> <span class="nb">Null</span><span class="p">)</span> <span class="p">};</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div>
</div></p><ul><li><p>Line 24 introduces a new method, <code class="highlight-inline"><span class="nx">informTimeout</span></code>, that receives no arguments and returns no information.
We&rsquo;ll call this function when a timeout occurs.</p></li></ul><p>We&rsquo;ll make a slight tweak to our JavaScript <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a> to be able to receive this message and display it on the console.</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-5/index.mjs#L18-L26"><span class="stt">tut-5/index.mjs</span></a><button class="btn" data-clipboard-text="  const Player = (Who) =&gt; ({
    ...stdlib.hasRandom,
    getHand: () =&gt; { const hand = Math.floor(Math.random()*3);
                     console.log(`${Who} played ${HAND[hand]}`);
                     return hand; },
    seeOutcome: (outcome) =&gt;
    console.log(`${Who} saw outcome ${OUTCOME[outcome]}`),
    informTimeout: () =&gt;
    console.log(`${Who} observed a timeout`) });"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">18</span>    <span class="kr">const</span> <span class="nx">Player</span> <span class="o">=</span> <span class="p">(</span><span class="nx">Who</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">({</span>
<span class="mi">19</span>      <span class="p">...</span><span class="nx">stdlib</span><span class="p">.</span><span class="nx">hasRandom</span><span class="p">,</span>
<span class="mi">20</span>      <span class="nx">getHand</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="kr">const</span> <span class="nx">hand</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">3</span><span class="p">);</span>
<span class="mi">21</span>                       <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">Who</span><span class="si">}</span><span class="sb"> played </span><span class="si">${</span><span class="nx">HAND</span><span class="p">[</span><span class="nx">hand</span><span class="p">]</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="mi">22</span>                       <span class="k">return</span> <span class="nx">hand</span><span class="p">;</span> <span class="p">},</span>
<span class="mi">23</span>      <span class="nx">seeOutcome</span><span class="o">:</span> <span class="p">(</span><span class="nx">outcome</span><span class="p">)</span> <span class="p">=&gt;</span>
<span class="mi">24</span>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">Who</span><span class="si">}</span><span class="sb"> saw outcome </span><span class="si">${</span><span class="nx">OUTCOME</span><span class="p">[</span><span class="nx">outcome</span><span class="p">]</span><span class="si">}</span><span class="sb">`</span><span class="p">),</span>
<span class="mi">25</span>      <span class="nx">informTimeout</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span>
<span class="mi">26</span>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">Who</span><span class="si">}</span><span class="sb"> observed a timeout`</span><span class="p">)</span> <span class="p">});</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div>
</div></p><p>Back in the Reach program, we&rsquo;ll define an identifier at the top of our program to use a standard deadline throughout the program.</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-5/index.rsh#L32-L33"><span class="stt">tut-5/index.rsh</span></a><button class="btn" data-clipboard-text="const DEADLINE = 10;
export const main ="><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">32</span>    <span class="kd">const</span> <span class="nx">DEADLINE</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="mi">33</span>    <span class="kd">export</span> <span class="kd">const</span> <span class="nx">main</span> <span class="o">=</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div>
</div></p><ul><li><p>Line 32 defines the deadline as ten <a href="ref-model.html#%28tech._time._delta%29" class="techoutside" data-pltdoc="x"><span class="techinside">time delta</span></a> units, which are an abstraction of the underlying notion of <a href="ref-model.html#%28tech._time%29" class="techoutside" data-pltdoc="x"><span class="techinside">time</span></a> in the <a href="ref-model.html#%28tech._consensus._network%29" class="techoutside" data-pltdoc="x"><span class="techinside">consensus network</span></a>.
In many networks, like Ethereum, this number is a number of blocks.</p></li></ul><p>Next, at the start of the Reach application, we&rsquo;ll define a helper function to inform each of the participants of the timeout by calling this new method.</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-5/index.rsh#L37-L42"><span class="stt">tut-5/index.rsh</span></a><button class="btn" data-clipboard-text="    (A, B) =&gt; {
      const informTimeout = () =&gt; {
        each([A, B], () =&gt; {
          interact.informTimeout(); }); };

      A.only(() =&gt; {"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">37</span>    <span class="p">(</span><span class="nx">A</span><span class="p">,</span> <span class="nx">B</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="mi">38</span>      <span class="kd">const</span> <span class="nx">informTimeout</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="mi">39</span>        <span class="k">each</span><span class="p">([</span><span class="nx">A</span><span class="p">,</span> <span class="nx">B</span><span class="p">],</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="mi">40</span>          <span class="k">interact</span><span class="p">.</span><span class="nx">informTimeout</span><span class="p">();</span> <span class="p">});</span> <span class="p">};</span>
<span class="mi">41</span>    
<span class="mi">42</span>      <span class="nx">A</span><span class="p">.</span><span class="k">only</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div>
</div></p><ul><li><p>Line 38 defines the function as an <a href="ref-programs-compute.html#%28tech._arrow._expression%29" class="techoutside" data-pltdoc="x"><span class="techinside">arrow expression</span></a>.</p></li><li><p>Line 39 has each of the participants perform a <a href="ref-model.html#%28tech._local._step%29" class="techoutside" data-pltdoc="x"><span class="techinside">local step</span></a>.</p></li><li><p>Line 40 has them call the new <code class="highlight-inline"><span class="nx">informTimeout</span></code> method.</p></li></ul><p>We won&rsquo;t change Alice&rsquo;s first message, because there is no consequence to her non-participant: if she doesn&rsquo;t start the game, then no one is any worse off.</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-5/index.rsh#L46-L47"><span class="stt">tut-5/index.rsh</span></a><button class="btn" data-clipboard-text="      A.publish(wager, commitA)
        .pay(wager);"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">46</span>    <span class="nx">A</span><span class="p">.</span><span class="k">publish</span><span class="p">(</span><span class="nx">wager</span><span class="p">,</span> <span class="nx">commitA</span><span class="p">)</span>
<span class="mi">47</span>      <span class="p">.</span><span class="k">pay</span><span class="p">(</span><span class="nx">wager</span><span class="p">);</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div>
</div></p><p>However, we will adjust Bob&rsquo;s first message, because if he fails to participate, then Alice&rsquo;s initial wager will be lost to her.</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-5/index.rsh#L54-L56"><span class="stt">tut-5/index.rsh</span></a><button class="btn" data-clipboard-text="      B.publish(handB)
        .pay(wager)
        .timeout(DEADLINE, () =&gt; closeTo(A, informTimeout));"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">54</span>    <span class="nx">B</span><span class="p">.</span><span class="k">publish</span><span class="p">(</span><span class="nx">handB</span><span class="p">)</span>
<span class="mi">55</span>      <span class="p">.</span><span class="k">pay</span><span class="p">(</span><span class="nx">wager</span><span class="p">)</span>
<span class="mi">56</span>      <span class="p">.</span><span class="k">timeout</span><span class="p">(</span><span class="nx">DEADLINE</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nb">closeTo</span><span class="p">(</span><span class="nx">A</span><span class="p">,</span> <span class="nx">informTimeout</span><span class="p">));</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div>
</div></p><ul><li><p>Line 56 adds a timeout handler to Bob&rsquo;s <a href="ref-model.html#%28tech._publication%29" class="techoutside" data-pltdoc="x"><span class="techinside">publication</span></a>.</p></li></ul><p>The timeout handler specifies that if Bob does not complete perform this action within a <a href="ref-model.html#%28tech._time._delta%29" class="techoutside" data-pltdoc="x"><span class="techinside">time delta</span></a> of <code class="highlight-inline"><span class="nx">DEADLINE</span></code>, then the application transitions to <a href="ref-model.html#%28tech._step%29" class="techoutside" data-pltdoc="x"><span class="techinside">step</span></a> given by the arrow expression.
In this case, the timeout code is a call to <code class="highlight-inline"><span class="nb">closeTo</span></code>, which is a Reach standard library function that has Alice send a message and transfer all of the funds in the <a href="ref-model.html#%28tech._contract%29" class="techoutside" data-pltdoc="x"><span class="techinside">contract</span></a> to herself, then call the given function afterwards.
This means that if Bob fails to publish his hand, then Alice will take her <a href="ref-model.html#%28tech._network._token%29" class="techoutside" data-pltdoc="x"><span class="techinside">network tokens</span></a> back.</p><p>We will add a similar timeout handler to Alice&rsquo;s second message.</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-5/index.rsh#L61-L62"><span class="stt">tut-5/index.rsh</span></a><button class="btn" data-clipboard-text="      A.publish(saltA, handA)
        .timeout(DEADLINE, () =&gt; closeTo(B, informTimeout));"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">61</span>    <span class="nx">A</span><span class="p">.</span><span class="k">publish</span><span class="p">(</span><span class="nx">saltA</span><span class="p">,</span> <span class="nx">handA</span><span class="p">)</span>
<span class="mi">62</span>      <span class="p">.</span><span class="k">timeout</span><span class="p">(</span><span class="nx">DEADLINE</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nb">closeTo</span><span class="p">(</span><span class="nx">B</span><span class="p">,</span> <span class="nx">informTimeout</span><span class="p">));</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div>
</div></p><p>But in this case, Bob will be able to claim all of the funds if Alice doesn&rsquo;t participate.
You might think that it would be "fair" for Alice&rsquo;s funds to be returned to Alice and Bob&rsquo;s to Bob.
However, if we implemented it that way, then Alice would be wise to always timeout if she were going to lose, which she knows will happen, because she knows her hand and Bob&rsquo;s hand.</p><p>These are the only changes we need to make to the Reach program to make it robust against non-participation: seven lines!</p><p><span style="font-weight: bold">&#8212;<wbr></wbr></span></p><p>Let&rsquo;s modify the JavaScript <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a> to deliberately cause a timeout sometimes when Bob is supposed to accept the wager.</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-5/index.mjs#L28-L44"><span class="stt">tut-5/index.mjs</span></a><button class="btn" data-clipboard-text="  await Promise.all([
    backend.Alice(
      stdlib, ctcAlice,
      { ...Player('Alice'),
        wager: toNetworkFormat('5')
      }),
    backend.Bob(
      stdlib, ctcBob,
      { ...Player('Bob'),
        acceptWager: async (amt) =&gt; { // &lt;-- async now
          if ( Math.random() &lt;= 0.5 ) {
            for ( let i = 0; i &lt; 10; i++ ) {
              console.log(`  Bob takes his sweet time...`);
              await stdlib.wait(1); }
          } else {
            console.log(`Bob accepts the wager of ${stdlib.fromWei(amt)}.`); } } } )
  ]);"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">28</span>    <span class="nx">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="mi">29</span>      <span class="nx">backend</span><span class="p">.</span><span class="nx">Alice</span><span class="p">(</span>
<span class="mi">30</span>        <span class="nx">stdlib</span><span class="p">,</span> <span class="nx">ctcAlice</span><span class="p">,</span>
<span class="mi">31</span>        <span class="p">{</span> <span class="p">...</span><span class="nx">Player</span><span class="p">(</span><span class="s1">&#39;Alice&#39;</span><span class="p">),</span>
<span class="mi">32</span>          <span class="nx">wager</span><span class="o">:</span> <span class="nx">toNetworkFormat</span><span class="p">(</span><span class="s1">&#39;5&#39;</span><span class="p">)</span>
<span class="mi">33</span>        <span class="p">}),</span>
<span class="mi">34</span>      <span class="nx">backend</span><span class="p">.</span><span class="nx">Bob</span><span class="p">(</span>
<span class="mi">35</span>        <span class="nx">stdlib</span><span class="p">,</span> <span class="nx">ctcBob</span><span class="p">,</span>
<span class="mi">36</span>        <span class="p">{</span> <span class="p">...</span><span class="nx">Player</span><span class="p">(</span><span class="s1">&#39;Bob&#39;</span><span class="p">),</span>
<span class="mi">37</span>          <span class="nx">acceptWager</span><span class="o">:</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">amt</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="c1">// &lt;-- async now</span>
<span class="mi">38</span>            <span class="k">if</span> <span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mf">0.5</span> <span class="p">)</span> <span class="p">{</span>
<span class="mi">39</span>              <span class="k">for</span> <span class="p">(</span> <span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
<span class="mi">40</span>                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`  Bob takes his sweet time...`</span><span class="p">);</span>
<span class="mi">41</span>                <span class="nx">await</span> <span class="nx">stdlib</span><span class="p">.</span><span class="nx">wait</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
<span class="mi">42</span>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">43</span>              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Bob accepts the wager of </span><span class="si">${</span><span class="nx">stdlib</span><span class="p">.</span><span class="nx">fromWei</span><span class="p">(</span><span class="nx">amt</span><span class="p">)</span><span class="si">}</span><span class="sb">.`</span><span class="p">);</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
<span class="mi">44</span>    <span class="p">]);</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div>
</div></p><ul><li><p>Line 37 through 44 redefines Bob&rsquo;s <code class="highlight-inline"><span class="nx">acceptWager</span></code> method as an asynchronous function where half of the time it will take at least ten blocks on the Ethereum network by waiting for ten units of time to pass.
We know that ten is the value of <code class="highlight-inline"><span class="nx">DEADLINE</span></code>, so this will cause a timeout.</p></li></ul><p><span style="font-weight: bold">&#8212;<wbr></wbr></span></p><p>Let&rsquo;s run the program and see what happens:</p><p><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">$ ./reach run</span></p></td></tr><tr><td><p><span class="stt">Alice played Rock</span></p></td></tr><tr><td><p><span class="stt">Bob accepts the wager of 5.0.</span></p></td></tr><tr><td><p><span class="stt">Bob played Paper</span></p></td></tr><tr><td><p><span class="stt">Bob saw outcome Bob wins</span></p></td></tr><tr><td><p><span class="stt">Alice saw outcome Bob wins</span></p></td></tr><tr><td><p><span class="stt">Alice went from 10.0 to 4.999999999999386833.</span></p></td></tr><tr><td><p><span class="stt">Bob went from 10.0 to 14.999999999999969143.</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">$ ./reach run</span></p></td></tr><tr><td><p><span class="stt">Alice played Scissors</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">Bob takes his sweet time...</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">Bob takes his sweet time...</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">Bob takes his sweet time...</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">Bob takes his sweet time...</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">Bob takes his sweet time...</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">Bob takes his sweet time...</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">Bob takes his sweet time...</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">Bob takes his sweet time...</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">Bob takes his sweet time...</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">Bob takes his sweet time...</span></p></td></tr><tr><td><p><span class="stt">Bob played Scissors</span></p></td></tr><tr><td><p><span class="stt">Bob observed a timeout</span></p></td></tr><tr><td><p><span class="stt">Alice observed a timeout</span></p></td></tr><tr><td><p><span class="stt">Alice went from 10.0 to 9.999999999999388565.</span></p></td></tr><tr><td><p><span class="stt">Bob went from 10.0 to 9.99999999999979.</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">$ ./reach run</span></p></td></tr><tr><td><p><span class="stt">Alice played Paper</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">Bob takes his sweet time...</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">Bob takes his sweet time...</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">Bob takes his sweet time...</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">Bob takes his sweet time...</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">Bob takes his sweet time...</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">Bob takes his sweet time...</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">Bob takes his sweet time...</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">Bob takes his sweet time...</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">Bob takes his sweet time...</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">Bob takes his sweet time...</span></p></td></tr><tr><td><p><span class="stt">Bob played Scissors</span></p></td></tr><tr><td><p><span class="stt">Bob observed a timeout</span></p></td></tr><tr><td><p><span class="stt">Alice observed a timeout</span></p></td></tr><tr><td><p><span class="stt">Alice went from 10.0 to 9.999999999999388565.</span></p></td></tr><tr><td><p><span class="stt">Bob went from 10.0 to 9.99999999999979.</span></p></td></tr></table></p><p>Of course, when you run, you may not get two of the three times ending in a timeout.</p><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>If your version isn&rsquo;t working, look at the complete versions of <a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-5/index.rsh"><span class="stt">tut-5/index.rsh</span></a> and <a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-5/index.mjs"><span class="stt">tut-5/index.mjs</span></a> to make sure you copied everything down correctly!</p></blockquote></blockquote></blockquote><p>Now our implementation of <span class="emph">Rock, Paper, Scissors</span> is robust against either participant dropping from the game.
In <a href="tut-6.html" data-pltdoc="x">the next step</a>, we&rsquo;ll extend the application to disallow draws and have Alice and Bob play again until there is a winner.</p><div class="navsetbottom"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="tut-4.html" title="backward to &quot;2.5 Trust and Commitments&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="tut.html" title="up to &quot;2 Tutorial&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="tut-6.html" title="forward to &quot;2.7 Play and Play Again&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div><script src="reach-post.js"></script></body></html>