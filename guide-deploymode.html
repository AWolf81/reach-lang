<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-149147406-1"></script><script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-149147406-1');</script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script><script src="tooltips.js"></script><script src="reach-pre.js"></script><link rel="stylesheet" href="tooltips.css"><link rel="stylesheet" href="reach.css"><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>3.5&nbsp;Choosing a deployment mode</title><link rel="stylesheet" type="text/css" href="scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="racket.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-racket.css" title="default"/><link rel="stylesheet" type="text/css" href="minted-solarizedlight-style.css" title="default"/><link rel="stylesheet" type="text/css" href="minted.css" title="default"/><script type="text/javascript" src="scribble-common.js"></script><script type="text/javascript" src="manual-racket.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--></head><body id="scribble-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9658;</a></td><td></td><td><a href="index.html" class="tocviewlink" data-pltdoc="x">Reach:<span class="mywbr"> &nbsp;</span> The Safest and Easiest DApp Programming Language</a></td></tr></table></div><div class="tocviewsublisttop" style="display: none;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="overview.html" class="tocviewlink" data-pltdoc="x">Overview</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="tut.html" class="tocviewlink" data-pltdoc="x">Tutorial</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="guide.html" class="tocviewselflink" data-pltdoc="x">Guide</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="workshop.html" class="tocviewlink" data-pltdoc="x">Workshop</a></td></tr><tr><td align="right">5&nbsp;</td><td><a href="ref.html" class="tocviewlink" data-pltdoc="x">Reference</a></td></tr><tr><td align="right"></td><td><a href="doc-index.html" class="tocviewlink" data-pltdoc="x">Index</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_1&quot;);">&#9660;</a></td><td>3&nbsp;</td><td><a href="guide.html" class="tocviewlink" data-pltdoc="x">Guide</a></td></tr></table><div class="tocviewsublistbottom" style="display: block;" id="tocview_1"><table cellspacing="0" cellpadding="0"><tr><td align="right">3.1&nbsp;</td><td><a href="guide-windows.html" class="tocviewlink" data-pltdoc="x">Using Reach on Windows</a></td></tr><tr><td align="right">3.2&nbsp;</td><td><a href="guide-versions.html" class="tocviewlink" data-pltdoc="x">How does Reach use version numbers?</a></td></tr><tr><td align="right">3.3&nbsp;</td><td><a href="guide-assert.html" class="tocviewlink" data-pltdoc="x">How and what to verify</a></td></tr><tr><td align="right">3.4&nbsp;</td><td><a href="guide-loop-invs.html" class="tocviewlink" data-pltdoc="x">Finding and using loop invariants</a></td></tr><tr><td align="right">3.5&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Choosing a deployment mode</a></td></tr><tr><td align="right">3.6&nbsp;</td><td><a href="guide-timeout.html" class="tocviewlink" data-pltdoc="x">Non-<wbr></wbr>participation:<span class="mywbr"> &nbsp;</span> What it is and how to protect against it</a></td></tr><tr><td align="right">3.7&nbsp;</td><td><a href="guide-determ.html" class="tocviewlink" data-pltdoc="x">Determinism, simultaneity, and choice in decentralized applications</a></td></tr><tr><td align="right">3.8&nbsp;</td><td><a href="guide-abstract.html" class="tocviewlink" data-pltdoc="x">Building decentralized abstractions</a></td></tr><tr><td align="right">3.9&nbsp;</td><td><a href="guide-limits.html" class="tocviewlink" data-pltdoc="x">What are Reach&rsquo;s limitations and its future roadmap</a></td></tr><tr><td align="right">3.10&nbsp;</td><td><a href="guide-reach.html" class="tocviewlink" data-pltdoc="x">How does Reach work?</a></td></tr></table></div></div></div></div><div class="maincolumn"><div class="main"><div class="versionbox"><span class="version">0.1.2</span></div><div class="navsettop"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="guide-loop-invs.html" title="backward to &quot;3.4 Finding and using loop invariants&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="guide.html" title="up to &quot;3 Guide&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="guide-timeout.html" title="forward to &quot;3.6 Non-participation: What it is and how to protect against it&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div><h4>3.5<tt>&nbsp;</tt><a name="(part._guide-deploymode)"></a>Choosing a deployment mode</h4><p><code class="highlight-inline"><span class="nb">Reach</span><span class="p">.</span><span class="nb">App</span></code> takes an option named <code class="highlight-inline"><span class="nx">deployMode</span></code> (as described <a href="ref-programs-module.html#%28part._ref-programs-reach..app%29" data-pltdoc="x">in the reference</a>) that determines how the <a href="ref-model.html#%28tech._contract%29" class="techoutside" data-pltdoc="x"><span class="techinside">contract</span></a> of a Reach application should be <a href="ref-model.html#%28tech._deploy%29" class="techoutside" data-pltdoc="x"><span class="techinside">deploy</span></a>ed.</p><p>The options are:</p><p><span style="font-weight: bold">Constructor (<code class="highlight-inline"><span class="s1">&#39;constructor&#39;</span></code>).</span>
In this mode, the contract is deployed independently of all of the <a href="ref-model.html#%28tech._participant%29" class="techoutside" data-pltdoc="x"><span class="techinside">participants</span></a> and available to the public to connect to.
This is the most flexible option, because it imposes no restrictions on the body of the application.
It has the downside of being slightly more expensive, because the construction of the contract must be paid for independently of the first use of the contract.
Furthermore, the creation of the contract is public, so it is possible for an agent <span class="RktInBG"><span class="hspace"></span><span class="RktIn">X</span><span class="hspace"></span></span> to create a contract <span class="RktInBG"><span class="hspace"></span><span class="RktIn">F</span><span class="hspace"></span></span> and intend to play the role of participant <span class="RktInBG"><span class="hspace"></span><span class="RktIn">A</span><span class="hspace"></span></span> in it, but the creation of the contract is observed by a third-party, <span class="RktInBG"><span class="hspace"></span><span class="RktIn">Z</span><span class="hspace"></span></span>, who interacts with <span class="RktInBG"><span class="hspace"></span><span class="RktIn">F</span><span class="hspace"></span></span> before <span class="RktInBG"><span class="hspace"></span><span class="RktIn">X</span><span class="hspace"></span></span> and acts as <span class="RktInBG"><span class="hspace"></span><span class="RktIn">A</span><span class="hspace"></span></span>.
This is particularly nefarious if <span class="RktInBG"><span class="hspace"></span><span class="RktIn">X</span><span class="hspace"></span></span> has already shared the information about the contract with their intended counter-party, <span class="RktInBG"><span class="hspace"></span><span class="RktIn">Y</span><span class="hspace"></span></span>.</p><p><span style="font-weight: bold">Delayed (<code class="highlight-inline"><span class="s1">&#39;firstMsg&#39;</span></code>).</span>
In this mode, the contract is deployed at the time of the first publication in the application.
This is slightly more efficient, because the contract creation is bundled with the first application.
This means that the contract does not exist until after the application starts running, which means that some features, like <code class="highlight-inline"><span class="nx">wait</span></code> and <code class="highlight-inline"><span class="p">.</span><span class="k">timeout</span></code>, as well as collective operations, are not available until after the first action.
Furthermore, it complicates the sharing of information about a contract by the deployer with a third-party, because the deployer must introduce an <code class="highlight-inline"><span class="k">interact</span></code> method to transfer control to the <code class="highlight-inline"><span class="nx">frontend</span></code> which will call (e.g.) <code class="highlight-inline"><span class="nx">await</span> <span class="nx">ctc</span><span class="p">.</span><span class="nx">getInfo</span><span class="p">()</span></code> and extract the information about the program.
If the <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a> attempts to call <code class="highlight-inline"><span class="nx">await</span> <span class="nx">ctc</span><span class="p">.</span><span class="nx">getInfo</span><span class="p">()</span></code> too early, it will <a href="https://en.wikipedia.org/wiki/Deadlock">deadlock</a>.</p><p>For example, consider the <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a> in the seventh version of the <span class="emph">Rock, Paper, Scissors!</span> tutorial:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-7/index.mjs#L23-L33"><span class="stt">tut-7/index.mjs</span></a><button class="btn" data-clipboard-text="  let ctc = null;
  if ( await ask(
    `Do you want to deploy the contract? (y/n)`, yesno) ) {
    ctc = await acc.deploy(backend);
    const info = await ctc.getInfo();
    console.log(`The contract is deployed as = ${JSON.stringify(info)}`); }
  else {
    const info = await ask(
      `Please paste the contract information:`,
      JSON.parse );
    ctc = await acc.attach(backend, info); }"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">23</span>    <span class="kd">let</span> <span class="nx">ctc</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="mi">24</span>    <span class="k">if</span> <span class="p">(</span> <span class="nx">await</span> <span class="nx">ask</span><span class="p">(</span>
<span class="mi">25</span>      <span class="sb">`Do you want to deploy the contract? (y/n)`</span><span class="p">,</span> <span class="nx">yesno</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
<span class="mi">26</span>      <span class="nx">ctc</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">acc</span><span class="p">.</span><span class="nx">deploy</span><span class="p">(</span><span class="nx">backend</span><span class="p">);</span>
<span class="mi">27</span>      <span class="kr">const</span> <span class="nx">info</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">ctc</span><span class="p">.</span><span class="nx">getInfo</span><span class="p">();</span>
<span class="mi">28</span>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`The contract is deployed as = </span><span class="si">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">info</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span> <span class="p">}</span>
<span class="mi">29</span>    <span class="k">else</span> <span class="p">{</span>
<span class="mi">30</span>      <span class="kr">const</span> <span class="nx">info</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">ask</span><span class="p">(</span>
<span class="mi">31</span>        <span class="sb">`Please paste the contract information:`</span><span class="p">,</span>
<span class="mi">32</span>        <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="p">);</span>
<span class="mi">33</span>      <span class="nx">ctc</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">acc</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">backend</span><span class="p">,</span> <span class="nx">info</span><span class="p">);</span> <span class="p">}</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div>
</div></p><ul><li><p>Line 26 instructs the backend that it is the deployer.</p></li><li><p>Line 27 immediately reads the contract information.</p></li></ul><p>If <a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-7/index.rsh"><span class="stt">tut-7/index.rsh</span></a> were defined to use <code class="highlight-inline"><span class="nx">deployMode</span></code> <code class="highlight-inline"><span class="s1">&#39;firstMsg&#39;</span></code>, then this call would <a href="https://en.wikipedia.org/wiki/Deadlock">deadlock</a>, because the contract information would not yet be available.
(Furthermore, the whole premise of this code, where on line 24, the user is asked if they will deploy, is unnecessary, because Alice would <span class="emph">always</span> deploy.
The code for the non-deploy case, line 33, would move to exclusively occur on Bob&rsquo;s branch.)
Instead, the Reach application would need to introduce a new <code class="highlight-inline"><span class="k">interact</span></code> method called by Alice <span class="emph">after</span> the first message to observe the contract information.</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-7/index.rsh#L42-L48"><span class="stt">tut-7/index.rsh</span></a><button class="btn" data-clipboard-text="      A.only(() =&gt; {
        const wager = declassify(interact.wager); });
      A.publish(wager)
        .pay(wager);
      commit();

      B.only(() =&gt; {"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">42</span>      <span class="nx">A</span><span class="p">.</span><span class="k">only</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="mi">43</span>        <span class="kd">const</span> <span class="nx">wager</span> <span class="o">=</span> <span class="k">declassify</span><span class="p">(</span><span class="k">interact</span><span class="p">.</span><span class="nx">wager</span><span class="p">);</span> <span class="p">});</span>
<span class="mi">44</span>      <span class="nx">A</span><span class="p">.</span><span class="k">publish</span><span class="p">(</span><span class="nx">wager</span><span class="p">)</span>
<span class="mi">45</span>        <span class="p">.</span><span class="k">pay</span><span class="p">(</span><span class="nx">wager</span><span class="p">);</span>
<span class="mi">46</span>      <span class="k">commit</span><span class="p">();</span>
<span class="mi">47</span>    
<span class="mi">48</span>      <span class="nx">B</span><span class="p">.</span><span class="k">only</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div>
</div></p><p>This method would be called on line 47 in a new <code class="highlight-inline"><span class="k">only</span></code> block.</p><p>This complexity is why <code class="highlight-inline"><span class="s1">&#39;firstMsg&#39;</span></code> is not the default, despite being more efficient.</p><p><span style="font-weight: bold">Factory (<code class="highlight-inline"><span class="s1">&#39;factory&#39;</span></code>).</span>
A future version of Reach will support a "factory" deployment mode where the contract is independently deployed into a meta-contract with a single method that creates new instances of its child contract.
This style of deployment has the same restrictions as the (<code class="highlight-inline"><span class="s1">&#39;firstMsg&#39;</span></code>) style, but can be even more efficient if a contract family is used many times.
Furthermore, the contract factory may emit events that can be used to more easily observe the creation of new contract (i.e. application) instances.</p><div class="navsetbottom"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="guide-loop-invs.html" title="backward to &quot;3.4 Finding and using loop invariants&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="guide.html" title="up to &quot;3 Guide&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="guide-timeout.html" title="forward to &quot;3.6 Non-participation: What it is and how to protect against it&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div><script src="reach-post.js"></script></body></html>