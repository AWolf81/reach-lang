<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-149147406-2"></script><script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-149147406-2');</script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script><script src="tooltips.js"></script><script src="reach-pre.js"></script><link rel="stylesheet" href="tooltips.css"><link rel="stylesheet" href="reach.css"><link rel="stylesheet" href="minted.css"><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>2.5&nbsp;Trust and Commitments</title><link rel="stylesheet" type="text/css" href="scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-racket.css" title="default"/><script type="text/javascript" src="scribble-common.js"></script><script type="text/javascript" src="manual-racket.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--></head><body id="scribble-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9658;</a></td><td></td><td><a href="index.html" class="tocviewlink" data-pltdoc="x">Reach:<span class="mywbr"> &nbsp;</span> The Safest and Easiest DApp Programming Language</a></td></tr></table></div><div class="tocviewsublisttop" style="display: none;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="overview.html" class="tocviewlink" data-pltdoc="x">Overview</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="tut.html" class="tocviewselflink" data-pltdoc="x">Tutorial</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="guide.html" class="tocviewlink" data-pltdoc="x">Guide</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="workshop.html" class="tocviewlink" data-pltdoc="x">Workshop</a></td></tr><tr><td align="right">5&nbsp;</td><td><a href="ref.html" class="tocviewlink" data-pltdoc="x">Reference</a></td></tr><tr><td align="right"></td><td><a href="doc-index.html" class="tocviewlink" data-pltdoc="x">Index</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_1&quot;);">&#9660;</a></td><td>2&nbsp;</td><td><a href="tut.html" class="tocviewlink" data-pltdoc="x">Tutorial</a></td></tr></table><div class="tocviewsublistbottom" style="display: block;" id="tocview_1"><table cellspacing="0" cellpadding="0"><tr><td align="right">2.1&nbsp;</td><td><a href="tut-0.html" class="tocviewlink" data-pltdoc="x">Install and Initialize</a></td></tr><tr><td align="right">2.2&nbsp;</td><td><a href="tut-1.html" class="tocviewlink" data-pltdoc="x">Scaffolding and Setup</a></td></tr><tr><td align="right">2.3&nbsp;</td><td><a href="tut-2.html" class="tocviewlink" data-pltdoc="x">Rock, Paper, and Scissors</a></td></tr><tr><td align="right">2.4&nbsp;</td><td><a href="tut-3.html" class="tocviewlink" data-pltdoc="x">Bets and Wagers</a></td></tr><tr><td align="right">2.5&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Trust and Commitments</a></td></tr><tr><td align="right">2.6&nbsp;</td><td><a href="tut-5.html" class="tocviewlink" data-pltdoc="x">Timeouts and Participation</a></td></tr><tr><td align="right">2.7&nbsp;</td><td><a href="tut-6.html" class="tocviewlink" data-pltdoc="x">Play and Play Again</a></td></tr><tr><td align="right">2.8&nbsp;</td><td><a href="tut-7.html" class="tocviewlink" data-pltdoc="x">Interaction and Independence</a></td></tr><tr><td align="right">2.9&nbsp;</td><td><a href="tut-8.html" class="tocviewlink" data-pltdoc="x">Web Interaction</a></td></tr><tr><td align="right">2.10&nbsp;</td><td><a href="tut-9.html" class="tocviewlink" data-pltdoc="x">Onward and Further</a></td></tr></table></div></div></div></div><div class="maincolumn"><div class="main"><div class="navsettop"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="tut-3.html" title="backward to &quot;2.4 Bets and Wagers&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="tut.html" title="up to &quot;2 Tutorial&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="tut-5.html" title="forward to &quot;2.6 Timeouts and Participation&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div><h4>2.5<tt>&nbsp;</tt><a name="(part._tut-4)"></a>Trust and Commitments</h4><p>In the last section, we made it so that Alice and Bob can actually exchange currency when they play <span class="emph">Rock, Paper, Scissors!</span>.
However, the version of the application we wrote has a fundamental flaw: Bob can win every game!</p><p>How is that possible?
We showed executions of the game where Alice won, like the following</p><p><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">$ ./reach run</span></p></td></tr><tr><td><p><span class="stt">Alice played Rock</span></p></td></tr><tr><td><p><span class="stt">Bob accepts the wager of 5.</span></p></td></tr><tr><td><p><span class="stt">Bob played Scissors</span></p></td></tr><tr><td><p><span class="stt">Alice saw outcome Alice wins</span></p></td></tr><tr><td><p><span class="stt">Bob saw outcome Alice wins</span></p></td></tr><tr><td><p><span class="stt">Alice went from 10 to 14.9999.</span></p></td></tr><tr><td><p><span class="stt">Bob went from 10 to 4.9999.</span></p></td></tr></table></p><p>The problem is that this version of the game only executed an <a href="ref-model.html#%28tech._honest%29" class="techoutside" data-pltdoc="x"><span class="techinside">honest</span></a> version of Bob, that is, one that followed the Reach program exactly, including in his private <a href="ref-model.html#%28tech._local._step%29" class="techoutside" data-pltdoc="x"><span class="techinside">local steps</span></a>.
It is possible for a deviant and dis<a href="ref-model.html#%28tech._honest%29" class="techoutside" data-pltdoc="x"><span class="techinside">honest</span></a> version of a Bob <a href="ref-model.html#%28tech._backend%29" class="techoutside" data-pltdoc="x"><span class="techinside">backend</span></a> to execute different code and always win by computing the appropriate guess based on what value Alice provided for <code class="highlight"><font class="badlink"><span class="nx">handA</span></font></code>.</p><p>If we change Bob&rsquo;s code to the following:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4-attack/index.rsh#L25-L29"><span class="stt">tut-4-attack/index.rsh</span></a><button class="btn" data-clipboard-text="      B.only(() =&gt; {
        interact.acceptWager(wager);
        const handB = (handA + 1) % 3; });
      B.publish(handB)
        .pay(wager);"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">25</span>    <font class="badlink"><span class="nx">B</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28only%29%29%29" class="k" data-pltdoc="x">only</a><span class="p">(()</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a> <span class="p">{</span>
<span class="mi">26</span>      <a href="ref-programs-local.html#%28reach._%28%28interact%29%29%29" class="k" data-pltdoc="x">interact</a><span class="p">.</span><font class="badlink"><span class="nx">acceptWager</span></font><span class="p">(</span><font class="badlink"><span class="nx">wager</span></font><span class="p">);</span>
<span class="mi">27</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">handB</span></font> <font class="badlink"><span class="o">=</span></font> <span class="p">(</span><font class="badlink"><span class="nx">handA</span></font> <a href="ref-programs-compute.html#%28reach._%28%28%2B%29%29%29" class="o" data-pltdoc="x">+</a> <span class="mi">1</span><span class="p">)</span> <a href="ref-programs-compute.html#%28reach._%28%28~25%29%29%29" class="o" data-pltdoc="x">%</a> <span class="mi">3</span><span class="p">;</span> <span class="p">});</span>
<span class="mi">28</span>    <font class="badlink"><span class="nx">B</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28publish%29%29%29" class="k" data-pltdoc="x">publish</a><span class="p">(</span><font class="badlink"><span class="nx">handB</span></font><span class="p">)</span>
<span class="mi">29</span>      <span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28pay%29%29%29" class="k" data-pltdoc="x">pay</a><span class="p">(</span><font class="badlink"><span class="nx">wager</span></font><span class="p">);</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div></div></p><p>then he will ignore the <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a> and just compute the correct value.</p><p>If we run this version of the program, we will see output like this:</p><p><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">$ ./reach run</span></p></td></tr><tr><td><p><span class="stt">Alice played Scissors</span></p></td></tr><tr><td><p><span class="stt">Bob accepts the wager of 5.</span></p></td></tr><tr><td><p><span class="stt">Alice saw outcome Bob wins</span></p></td></tr><tr><td><p><span class="stt">Bob saw outcome Bob wins</span></p></td></tr><tr><td><p><span class="stt">Alice went from 10 to 4.9999.</span></p></td></tr><tr><td><p><span class="stt">Bob went from 10 to 14.9999.</span></p></td></tr></table></p><p>In this version, unlike the <a href="ref-model.html#%28tech._honest%29" class="techoutside" data-pltdoc="x"><span class="techinside">honest</span></a> version, Bob never consults the <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a> and so it never prints out the message of what hand Bob played.
No matter what Alice chooses, Bob will always win.</p><p><span style="font-weight: bold">&#8212;<wbr></wbr></span></p><p>Is it just a fluke of the random number generator that we observed Bob always winning?
How would we know?
Reach comes with an    <a href="guide-assert.html" data-pltdoc="x">automatic verification</a> engine that we can use to mathematically prove that this version will always result in the <code class="highlight"><font class="badlink"><span class="nx">outcome</span></font></code> variable equalling <code class="highlight"><span class="mi">0</span></code>, which means Bob wins.
We can instruct Reach to prove this theorem by adding these lines after computing the <code class="highlight"><font class="badlink"><span class="nx">outcome</span></font></code>:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4-attack/index.rsh#L31-L34"><span class="stt">tut-4-attack/index.rsh</span></a><button class="btn" data-clipboard-text="      const outcome = (handA + (4 - handB)) % 3;
      require(handB == (handA + 1) % 3);
      assert(outcome == 0);
      const [forA, forB] ="><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">31</span>    <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">outcome</span></font> <font class="badlink"><span class="o">=</span></font> <span class="p">(</span><font class="badlink"><span class="nx">handA</span></font> <a href="ref-programs-compute.html#%28reach._%28%28%2B%29%29%29" class="o" data-pltdoc="x">+</a> <span class="p">(</span><span class="mi">4</span> <a href="ref-programs-compute.html#%28reach._%28%28-%29%29%29" class="o" data-pltdoc="x">-</a> <font class="badlink"><span class="nx">handB</span></font><span class="p">))</span> <a href="ref-programs-compute.html#%28reach._%28%28~25%29%29%29" class="o" data-pltdoc="x">%</a> <span class="mi">3</span><span class="p">;</span>
<span class="mi">32</span>    <a href="ref-programs-consensus.html#%28reach._%28%28require%29%29%29" class="k" data-pltdoc="x">require</a><span class="p">(</span><font class="badlink"><span class="nx">handB</span></font> <a href="ref-programs-compute.html#%28reach._%28%28~3d~3d%29%29%29" class="o" data-pltdoc="x">==</a> <span class="p">(</span><font class="badlink"><span class="nx">handA</span></font> <a href="ref-programs-compute.html#%28reach._%28%28%2B%29%29%29" class="o" data-pltdoc="x">+</a> <span class="mi">1</span><span class="p">)</span> <a href="ref-programs-compute.html#%28reach._%28%28~25%29%29%29" class="o" data-pltdoc="x">%</a> <span class="mi">3</span><span class="p">);</span>
<span class="mi">33</span>    <a href="ref-programs-compute.html#%28reach._%28%28assert%29%29%29" class="k" data-pltdoc="x">assert</a><span class="p">(</span><font class="badlink"><span class="nx">outcome</span></font> <a href="ref-programs-compute.html#%28reach._%28%28~3d~3d%29%29%29" class="o" data-pltdoc="x">==</a> <span class="mi">0</span><span class="p">);</span>
<span class="mi">34</span>    <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <span class="p">[</span><font class="badlink"><span class="nx">forA</span></font><span class="p">,</span> <font class="badlink"><span class="nx">forB</span></font><span class="p">]</span> <font class="badlink"><span class="o">=</span></font>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div></div></p><ul><li><p>Line 32 requires that the dis<a href="ref-model.html#%28tech._honest%29" class="techoutside" data-pltdoc="x"><span class="techinside">honest</span></a> version of Bob be used for the proof.</p></li><li><p>Line 33 conducts the proof by including an <a href="ref-model.html#%28tech._assert%29" class="techoutside" data-pltdoc="x"><span class="techinside">assert</span></a> statement in the program.</p></li></ul><p>Before we had this line in the file, when we ran <span class="stt">./reach run</span>, it would print out the message:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-3/index.txt#L2-L7"><span class="stt">tut-3/index.txt</span></a><button class="btn" data-clipboard-text="Verifying for generic connector
  Verifying when ALL participants are honest
  Verifying when NO participants are honest
  Verifying when ONLY &quot;Alice&quot; is honest
  Verifying when ONLY &quot;Bob&quot; is honest
Checked 16 theorems; No failures!"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">..</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">// ...</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">2</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Verifying for generic connector</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">3</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Verifying when ALL participants are honest</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">4</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Verifying when NO participants are honest</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">5</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Verifying when ONLY "Alice" is honest</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">6</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Verifying when ONLY "Bob" is honest</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">7</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Checked 16 theorems; No failures!</span></p></td></tr></table></div></p><p>But now, it prints out</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4-attack/index.txt#L2-L7"><span class="stt">tut-4-attack/index.txt</span></a><button class="btn" data-clipboard-text="Verifying for generic connector
  Verifying when ALL participants are honest
  Verifying when NO participants are honest
  Verifying when ONLY &quot;Alice&quot; is honest
  Verifying when ONLY &quot;Bob&quot; is honest
Checked 21 theorems; No failures!"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">..</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">// ...</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">2</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Verifying for generic connector</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">3</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Verifying when ALL participants are honest</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">4</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Verifying when NO participants are honest</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">5</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Verifying when ONLY "Alice" is honest</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">6</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Verifying when ONLY "Bob" is honest</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">7</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Checked 21 theorems; No failures!</span></p></td></tr></table></div></p><ul><li><p>Line 7 is different and shows that more theorems have been proven about our program.
It prints out five more, rather than one more, because the theorem is proved differently in the different verification modes.</p></li></ul><p><span style="font-weight: bold">&#8212;<wbr></wbr></span></p><p>Many programming languages include <a href="https://en.wikipedia.org/wiki/Assertion_(software_development)">assertions</a> like this, but Reach is one of a small category where the compiler doesn&rsquo;t just insert a runtime check for the property, but actually conducts a mathematical proof at compile-time that the expression <span class="emph">always</span> evaluates to <code class="highlight"><a href="ref-programs-compute.html#%28reach._%28%28true%29%29%29" class="kc" data-pltdoc="x">true</a></code>.</p><p>In this case, we used Reach&rsquo;s <a href="guide-assert.html" data-pltdoc="x">automatic verification</a> engine to prove that an attack did what we expected it would.
But, it is better to use verification to show that <span class="emph">no flaw</span> exists and <span class="emph">no attack</span> is possible.</p><p>Reach includes some such assertions automatically in every program.
That&rsquo;s why every version of <span class="emph">Rock, Paper, Scissors!</span> has said that a number of theorems were checked.
We can see what these theorems do by deliberating inserting an error in the program.</p><p>Let&rsquo;s change the computation of the payout and make it so that if Alice wins, then she only gets her wager back, not Bob&rsquo;s.</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4-attack/index-bad.rsh#L34-L41"><span class="stt">tut-4-attack/index-bad.rsh</span></a><button class="btn" data-clipboard-text="      const [forA, forB] =
            // was: outcome == 0 ? [0, 2] :
            outcome == 0 ? [0, 1] : // &lt;-- Oops
            outcome == 1 ? [1, 1] :
            [2, 0];
      transfer(forA * wager).to(A);
      transfer(forB * wager).to(B);
      commit();"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">34</span>    <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <span class="p">[</span><font class="badlink"><span class="nx">forA</span></font><span class="p">,</span> <font class="badlink"><span class="nx">forB</span></font><span class="p">]</span> <font class="badlink"><span class="o">=</span></font>
<span class="mi">35</span>          <span class="c1">// was: outcome == 0 ? [0, 2] :</span>
<span class="mi">36</span>          <font class="badlink"><span class="nx">outcome</span></font> <a href="ref-programs-compute.html#%28reach._%28%28~3d~3d%29%29%29" class="o" data-pltdoc="x">==</a> <span class="mi">0</span> <a href="ref-programs-compute.html#%28reach._%28%28~3f%29%29%29" class="o" data-pltdoc="x">?</a> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <font class="badlink"><span class="o">:</span></font> <span class="c1">// &lt;-- Oops</span>
<span class="mi">37</span>          <font class="badlink"><span class="nx">outcome</span></font> <a href="ref-programs-compute.html#%28reach._%28%28~3d~3d%29%29%29" class="o" data-pltdoc="x">==</a> <span class="mi">1</span> <a href="ref-programs-compute.html#%28reach._%28%28~3f%29%29%29" class="o" data-pltdoc="x">?</a> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <font class="badlink"><span class="o">:</span></font>
<span class="mi">38</span>          <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">];</span>
<span class="mi">39</span>    <a href="ref-programs-consensus.html#%28reach._%28%28transfer%29%29%29" class="k" data-pltdoc="x">transfer</a><span class="p">(</span><font class="badlink"><span class="nx">forA</span></font> <a href="ref-programs-compute.html#%28reach._%28%28%2A%29%29%29" class="o" data-pltdoc="x">*</a> <font class="badlink"><span class="nx">wager</span></font><span class="p">).</span><font class="badlink"><span class="nx">to</span></font><span class="p">(</span><font class="badlink"><span class="nx">A</span></font><span class="p">);</span>
<span class="mi">40</span>    <a href="ref-programs-consensus.html#%28reach._%28%28transfer%29%29%29" class="k" data-pltdoc="x">transfer</a><span class="p">(</span><font class="badlink"><span class="nx">forB</span></font> <a href="ref-programs-compute.html#%28reach._%28%28%2A%29%29%29" class="o" data-pltdoc="x">*</a> <font class="badlink"><span class="nx">wager</span></font><span class="p">).</span><font class="badlink"><span class="nx">to</span></font><span class="p">(</span><font class="badlink"><span class="nx">B</span></font><span class="p">);</span>
<span class="mi">41</span>    <a href="ref-programs-consensus.html#%28reach._%28%28commit%29%29%29" class="k" data-pltdoc="x">commit</a><span class="p">();</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div></div></p><ul><li><p>Line 36 has <code class="highlight"><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span></code>, but should have <code class="highlight"><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span></code>.</p></li></ul><p>When we run <span class="stt">./reach compile </span><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4-attack/index-bad.rsh"><span class="stt">tut-4-attack/index-bad.rsh</span></a>, it gives details about the error:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4-attack/index-bad.txt#L4-L22"><span class="stt">tut-4-attack/index-bad.txt</span></a><button class="btn" data-clipboard-text="Verification failed:
  when ALL participants are honest
  of theorem: assert
  msg: &quot;balance assertion&quot;
  at ./index-bad.rsh:45:11:application

  // Violation witness
  const interact_Alice_wager = 2;
  //    ^ from interaction at ./index-bad.rsh:14:12:application
  const handA/4 = 2;
  //    ^ from evaluating interact(&quot;Alice&quot;).&quot;getHand&quot;() at ./index-bad.rsh:20:50:application

  // Theorem formalization
  const outcome/26 = (handA/4 + (4 - ((handA/4 + 1) % 3))) % 3;
  //    ^ would be 0
  const v37 = (outcome/26 == 0) ? [0, 1] : ((outcome/26 == 1) ? [1, 1] : [2, 0]);
  //    ^ would be [0, 1]
  assert(0 == (((interact_Alice_wager + interact_Alice_wager) - (v37[0] * interact_Alice_wager)) - (v37[1] * interact_Alice_wager)));
"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">...</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt"></span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">4</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Verification failed:</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">5</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">when ALL participants are honest</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">6</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">of theorem: assert</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">7</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">msg: "balance assertion"</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">8</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">at ./index-bad.rsh:45:11:application</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">9</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt"></span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">10</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">// Violation witness</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">11</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">const interact_Alice_wager = 2;</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">12</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">//</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">^ from interaction at ./index-bad.rsh:14:12:application</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">13</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">const handA/4 = 2;</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">14</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">//</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">^ from evaluating interact("Alice")."getHand"() at ./index-bad.rsh:20:50:application</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">15</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt"></span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">16</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">// Theorem formalization</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">17</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">const outcome/26 = (handA/4 + (4 - ((handA/4 + 1) % 3))) % 3;</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">18</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">//</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">^ would be 0</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">19</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">const v37 = (outcome/26 == 0) ? [0, 1] : ((outcome/26 == 1) ? [1, 1] : [2, 0]);</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">20</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">//</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">^ would be [0, 1]</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">21</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">assert(0 == (((interact_Alice_wager + interact_Alice_wager) - (v37[0] * interact_Alice_wager)) - (v37[1] * interact_Alice_wager)));</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">22</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt"></span></p></td></tr><tr><td><p><span class="stt">...</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt"></span></p></td></tr></table></div></p><p>There&rsquo;s a lot of information in the compiler output that can help an experienced programmer track down the problem. But the most important parts are</p><ul><li><p>Line 7 says that this is an attempt to prove the theorem that the balance at the end of the program is zero, which means that no <a href="ref-model.html#%28tech._network._token%29" class="techoutside" data-pltdoc="x"><span class="techinside">network tokens</span></a> are sealed in the <a href="ref-model.html#%28tech._contract%29" class="techoutside" data-pltdoc="x"><span class="techinside">contract</span></a> forever.</p></li><li><p>Line 8 says that this happens when the program exits on line 45, which directs the programmer to that path through the program.</p></li><li><p>Lines 10-14 describe the values that could cause the theorem to fail.</p></li><li><p>Lines 16-21 outline the theorem that failed.</p></li></ul><p>These kinds of <a href="guide-assert.html" data-pltdoc="x">automatic verifications</a> are helpful for Reach programmers, because they don&rsquo;t need to remember to put them in their program, and they will still be protected from entire categories of errors.</p><p><span style="font-weight: bold">&#8212;<wbr></wbr></span></p><p>However, now let&rsquo;s add an <a href="ref-model.html#%28tech._assert%29" class="techoutside" data-pltdoc="x"><span class="techinside">assert</span></a>ion to the program that will ensure that every version of the program that allows Bob to know Alice&rsquo;s hand before he chooses his own will be rejected.</p><p>We&rsquo;ll go back to the version of <a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-3/index.rsh"><span class="stt">tut-3/index.rsh</span></a> from the last section, which has an <a href="ref-model.html#%28tech._honest%29" class="techoutside" data-pltdoc="x"><span class="techinside">honest</span></a> version of Bob.
(Click on the preceeding link if you need to see what it contained.)</p><p>We&rsquo;ll add a single line to the program after Alice publishes, but before Bob takes a <a href="ref-model.html#%28tech._local._step%29" class="techoutside" data-pltdoc="x"><span class="techinside">local step</span></a>:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4-attack/index-fails.rsh#L21-L28"><span class="stt">tut-4-attack/index-fails.rsh</span></a><button class="btn" data-clipboard-text="      A.publish(wager, handA)
        .pay(wager);
      commit();

      unknowable(B, A(handA));
      B.only(() =&gt; {
        interact.acceptWager(wager);
        const handB = declassify(interact.getHand()); });"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">21</span>    <font class="badlink"><span class="nx">A</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28publish%29%29%29" class="k" data-pltdoc="x">publish</a><span class="p">(</span><font class="badlink"><span class="nx">wager</span></font><span class="p">,</span> <font class="badlink"><span class="nx">handA</span></font><span class="p">)</span>
<span class="mi">22</span>      <span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28pay%29%29%29" class="k" data-pltdoc="x">pay</a><span class="p">(</span><font class="badlink"><span class="nx">wager</span></font><span class="p">);</span>
<span class="mi">23</span>    <a href="ref-programs-consensus.html#%28reach._%28%28commit%29%29%29" class="k" data-pltdoc="x">commit</a><span class="p">();</span>
<span class="mi">24</span>    
<span class="mi">25</span>    <a href="ref-programs-step.html#%28reach._%28%28unknowable%29%29%29" class="k" data-pltdoc="x">unknowable</a><span class="p">(</span><font class="badlink"><span class="nx">B</span></font><span class="p">,</span> <font class="badlink"><span class="nx">A</span></font><span class="p">(</span><font class="badlink"><span class="nx">handA</span></font><span class="p">));</span>
<span class="mi">26</span>    <font class="badlink"><span class="nx">B</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28only%29%29%29" class="k" data-pltdoc="x">only</a><span class="p">(()</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a> <span class="p">{</span>
<span class="mi">27</span>      <a href="ref-programs-local.html#%28reach._%28%28interact%29%29%29" class="k" data-pltdoc="x">interact</a><span class="p">.</span><font class="badlink"><span class="nx">acceptWager</span></font><span class="p">(</span><font class="badlink"><span class="nx">wager</span></font><span class="p">);</span>
<span class="mi">28</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">handB</span></font> <font class="badlink"><span class="o">=</span></font> <a href="ref-programs-local.html#%28reach._%28%28declassify%29%29%29" class="k" data-pltdoc="x">declassify</a><span class="p">(</span><a href="ref-programs-local.html#%28reach._%28%28interact%29%29%29" class="k" data-pltdoc="x">interact</a><span class="p">.</span><font class="badlink"><span class="nx">getHand</span></font><span class="p">());</span> <span class="p">});</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div></div></p><ul><li><p>Line 25 contains a <a href="ref-model.html#%28tech._knowledge._assertion%29" class="techoutside" data-pltdoc="x"><span class="techinside">knowledge assertion</span></a> that Bob cannot know Alice&rsquo;s value <code class="highlight"><font class="badlink"><span class="nx">handA</span></font></code> at this point in the program.
In this case, it is obvious that this is not true, because Alice shares <code class="highlight"><font class="badlink"><span class="nx">handA</span></font></code> at line 21.
In many cases, this is not obvious and Reach&rsquo;s <a href="guide-assert.html" data-pltdoc="x">automatic verification</a> engine has to reason about how values that Bob <span class="emph">does know</span> are connected to values that might be related to Alice&rsquo;s secret values.</p></li></ul><p>When we run <span class="stt">./reach run</span>, it reports that this assertion is false:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4-attack/index-fails.txt#L3-L5"><span class="stt">tut-4-attack/index-fails.txt</span></a><button class="btn" data-clipboard-text="  of theorem unknowable(&quot;Bob&quot;, handA/7)
  at ./index-fails.rsh:25:17:application
"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">..</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt"></span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">3</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">of theorem unknowable("Bob", handA/7)</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">4</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">at ./index-fails.rsh:25:17:application</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">5</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt"></span></p></td></tr><tr><td><p><span class="stt">..</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt"></span></p></td></tr></table></div></p><p>It is not enough to correct failures and attacks when you discover them.
You must <span style="font-weight: bold">always</span> add an assertion to your program that would fail to hold if the attack or failure were present.
This ensures that all similar attacks are not present and that they will not accidentally be reintroduced.</p><p><span style="font-weight: bold">&#8212;<wbr></wbr></span></p><p>Let&rsquo;s use these insights into <a href="guide-assert.html" data-pltdoc="x">automatic verification</a> and rewrite our <span class="emph">Rock, Paper, Scissors!</span> so that it is more trustworthy and secure.</p><p>Since we&rsquo;ve been making lots of changes to the code, let&rsquo;s start fresh with a new version and we&rsquo;ll look at every single line again, to make sure that you aren&rsquo;t missing anything.</p><p>First, we&rsquo;ll define the rules of <span class="emph">Rock, Paper, Scissors!</span> a little bit more abstractly, so we can separate the logic of the game from the details of the application:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4/index.rsh#L1-L7"><span class="stt">tut-4/index.rsh</span></a><button class="btn" data-clipboard-text="'reach 0.1';

const [ isHand, ROCK, PAPER, SCISSORS ] = makeEnum(3);
const [ isOutcome, B_WINS, DRAW, A_WINS ] = makeEnum(3);

const winner = (handA, handB) =&gt;
      ((handA + (4 - handB)) % 3);"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span> <span class="mi">1</span>    <span class="s1">&#39;reach 0.1&#39;</span><span class="p">;</span>
 <span class="mi">2</span>    
 <span class="mi">3</span>    <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <span class="p">[</span> <font class="badlink"><span class="nx">isHand</span></font><span class="p">,</span> <font class="badlink"><span class="nx">ROCK</span></font><span class="p">,</span> <font class="badlink"><span class="nx">PAPER</span></font><span class="p">,</span> <font class="badlink"><span class="nx">SCISSORS</span></font> <span class="p">]</span> <font class="badlink"><span class="o">=</span></font> <a href="ref-programs-compute.html#%28reach._%28%28make.Enum%29%29%29" class="nb" data-pltdoc="x">makeEnum</a><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
 <span class="mi">4</span>    <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <span class="p">[</span> <font class="badlink"><span class="nx">isOutcome</span></font><span class="p">,</span> <font class="badlink"><span class="nx">B_WINS</span></font><span class="p">,</span> <font class="badlink"><span class="nx">DRAW</span></font><span class="p">,</span> <font class="badlink"><span class="nx">A_WINS</span></font> <span class="p">]</span> <font class="badlink"><span class="o">=</span></font> <a href="ref-programs-compute.html#%28reach._%28%28make.Enum%29%29%29" class="nb" data-pltdoc="x">makeEnum</a><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
 <span class="mi">5</span>    
 <span class="mi">6</span>    <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">winner</span></font> <font class="badlink"><span class="o">=</span></font> <span class="p">(</span><font class="badlink"><span class="nx">handA</span></font><span class="p">,</span> <font class="badlink"><span class="nx">handB</span></font><span class="p">)</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a>
 <span class="mi">7</span>          <span class="p">((</span><font class="badlink"><span class="nx">handA</span></font> <a href="ref-programs-compute.html#%28reach._%28%28%2B%29%29%29" class="o" data-pltdoc="x">+</a> <span class="p">(</span><span class="mi">4</span> <a href="ref-programs-compute.html#%28reach._%28%28-%29%29%29" class="o" data-pltdoc="x">-</a> <font class="badlink"><span class="nx">handB</span></font><span class="p">))</span> <a href="ref-programs-compute.html#%28reach._%28%28~25%29%29%29" class="o" data-pltdoc="x">%</a> <span class="mi">3</span><span class="p">);</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div></div></p><ul><li><p>Line 1 is the usual Reach version header.</p></li><li><p>Lines 3 and 4 define <a href="ref-programs-compute.html#%28tech._enumeration%29" class="techoutside" data-pltdoc="x"><span class="techinside">enumeration</span></a>s for the hands that may be played, as well as the outcomes of the game.</p></li><li><p>Lines 6 and 7 define the function that computes the winner of the game.</p></li></ul><p>When we first wrote <span class="emph">Rock, Paper, Scissors!</span>, we asked you to trust that this formula for computing the winner is correct, but it is good to actually check.
One way to check would be to implement a JavaScript <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a> that didn&rsquo;t interact with a real user, nor would it randomly generate values, but instead, it would return specific testing scenario values and check that the output is as expected.
That&rsquo;s a typical way to debug and is possible with Reach.
However, Reach allows us to write such test cases directly into the Reach program as verification assertions.</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4/index.rsh#L9-L11"><span class="stt">tut-4/index.rsh</span></a><button class="btn" data-clipboard-text="assert(winner(ROCK, PAPER) == B_WINS);
assert(winner(PAPER, ROCK) == A_WINS);
assert(winner(ROCK, ROCK) == DRAW);"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
 <span class="mi">9</span>    <a href="ref-programs-compute.html#%28reach._%28%28assert%29%29%29" class="k" data-pltdoc="x">assert</a><span class="p">(</span><font class="badlink"><span class="nx">winner</span></font><span class="p">(</span><font class="badlink"><span class="nx">ROCK</span></font><span class="p">,</span> <font class="badlink"><span class="nx">PAPER</span></font><span class="p">)</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d~3d%29%29%29" class="o" data-pltdoc="x">==</a> <font class="badlink"><span class="nx">B_WINS</span></font><span class="p">);</span>
<span class="mi">10</span>    <a href="ref-programs-compute.html#%28reach._%28%28assert%29%29%29" class="k" data-pltdoc="x">assert</a><span class="p">(</span><font class="badlink"><span class="nx">winner</span></font><span class="p">(</span><font class="badlink"><span class="nx">PAPER</span></font><span class="p">,</span> <font class="badlink"><span class="nx">ROCK</span></font><span class="p">)</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d~3d%29%29%29" class="o" data-pltdoc="x">==</a> <font class="badlink"><span class="nx">A_WINS</span></font><span class="p">);</span>
<span class="mi">11</span>    <a href="ref-programs-compute.html#%28reach._%28%28assert%29%29%29" class="k" data-pltdoc="x">assert</a><span class="p">(</span><font class="badlink"><span class="nx">winner</span></font><span class="p">(</span><font class="badlink"><span class="nx">ROCK</span></font><span class="p">,</span> <font class="badlink"><span class="nx">ROCK</span></font><span class="p">)</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d~3d%29%29%29" class="o" data-pltdoc="x">==</a> <font class="badlink"><span class="nx">DRAW</span></font><span class="p">);</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div></div></p><ul><li><p>Line 9 makes an <a href="ref-model.html#%28tech._assert%29" class="techoutside" data-pltdoc="x"><span class="techinside">assert</span></a>ion that when Alice plays Rock and Bob plays Paper, then Bob wins as expected.</p></li></ul><p>But, Reach&rsquo;s <a href="guide-assert.html" data-pltdoc="x">automatic verification</a> allows us to express even more powerful statements about our program&rsquo;s behavior.
For example, we can state that no matter what values are provided for <code class="highlight"><font class="badlink"><span class="nx">handA</span></font></code> and <code class="highlight"><font class="badlink"><span class="nx">handB</span></font></code>, <code class="highlight"><font class="badlink"><span class="nx">winner</span></font></code> will always provide a valid outcome:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4/index.rsh#L13-L15"><span class="stt">tut-4/index.rsh</span></a><button class="btn" data-clipboard-text="forall(UInt, handA =&gt;
  forall(UInt, handB =&gt;
    assert(isOutcome(winner(handA, handB)))));"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">13</span>    <a href="ref-programs-compute.html#%28reach._%28%28forall%29%29%29" class="k" data-pltdoc="x">forall</a><span class="p">(</span><a href="ref-programs-compute.html#%28reach._%28%28.U.Int%29%29%29" class="nb" data-pltdoc="x">UInt</a><span class="p">,</span> <font class="badlink"><span class="nx">handA</span></font> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a>
<span class="mi">14</span>      <a href="ref-programs-compute.html#%28reach._%28%28forall%29%29%29" class="k" data-pltdoc="x">forall</a><span class="p">(</span><a href="ref-programs-compute.html#%28reach._%28%28.U.Int%29%29%29" class="nb" data-pltdoc="x">UInt</a><span class="p">,</span> <font class="badlink"><span class="nx">handB</span></font> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a>
<span class="mi">15</span>        <a href="ref-programs-compute.html#%28reach._%28%28assert%29%29%29" class="k" data-pltdoc="x">assert</a><span class="p">(</span><font class="badlink"><span class="nx">isOutcome</span></font><span class="p">(</span><font class="badlink"><span class="nx">winner</span></font><span class="p">(</span><font class="badlink"><span class="nx">handA</span></font><span class="p">,</span> <font class="badlink"><span class="nx">handB</span></font><span class="p">)))));</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div></div></p><p>And we can specify that whenever the same value is provided for both hands, no matter what it is, <code class="highlight"><font class="badlink"><span class="nx">winner</span></font></code> always returns <code class="highlight"><font class="badlink"><span class="nx">DRAW</span></font></code>:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4/index.rsh#L17-L18"><span class="stt">tut-4/index.rsh</span></a><button class="btn" data-clipboard-text="forall(UInt, (hand) =&gt;
  assert(winner(hand, hand) == DRAW));"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">17</span>    <a href="ref-programs-compute.html#%28reach._%28%28forall%29%29%29" class="k" data-pltdoc="x">forall</a><span class="p">(</span><a href="ref-programs-compute.html#%28reach._%28%28.U.Int%29%29%29" class="nb" data-pltdoc="x">UInt</a><span class="p">,</span> <span class="p">(</span><font class="badlink"><span class="nx">hand</span></font><span class="p">)</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a>
<span class="mi">18</span>      <a href="ref-programs-compute.html#%28reach._%28%28assert%29%29%29" class="k" data-pltdoc="x">assert</a><span class="p">(</span><font class="badlink"><span class="nx">winner</span></font><span class="p">(</span><font class="badlink"><span class="nx">hand</span></font><span class="p">,</span> <font class="badlink"><span class="nx">hand</span></font><span class="p">)</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d~3d%29%29%29" class="o" data-pltdoc="x">==</a> <font class="badlink"><span class="nx">DRAW</span></font><span class="p">));</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div></div></p><p>These examples both use <code class="highlight"><a href="ref-programs-compute.html#%28reach._%28%28forall%29%29%29" class="k" data-pltdoc="x">forall</a></code>, which allows Reach programmers to quantify over all possible values that might be provided to a part of their program.
You might think that these theorems will take a very long time to prove, because they have to loop over all 1,552,518,092,300,708,935,148,...247 digits...,468,750,892,846,853,816,057,856 possibilities (e.g., Ethereum uses 256-bits for its unsigned integers) for the bits of <code class="highlight"><font class="badlink"><span class="nx">handA</span></font></code> (twice!) and <code class="highlight"><font class="badlink"><span class="nx">handB</span></font></code>.
In fact, on the author&rsquo;s MacBook Pro from early 2015, it takes less than half a second.
That&rsquo;s because Reach uses an advanced <a href="guide-reach.html" data-pltdoc="x">symbolic execution engine</a> to reason about this theorem abstractly without considering individual values.</p><p>Let&rsquo;s continue the program by specifying the <a href="ref-programs-module.html#%28tech._participant._interact._interface%29" class="techoutside" data-pltdoc="x"><span class="techinside">participant interact interface</span></a>s for Alice and Bob.
These will be mostly the same as before, except that we will also expect that each <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a> can provide access to random numbers.
We&rsquo;ll use these later on to protect Alice&rsquo;s hand.</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4/index.rsh#L20-L23"><span class="stt">tut-4/index.rsh</span></a><button class="btn" data-clipboard-text="const Player =
      { ...hasRandom, // &lt;--- new!
        getHand: Fun([], UInt),
        seeOutcome: Fun([UInt], Null) };"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">20</span>    <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">Player</span></font> <font class="badlink"><span class="o">=</span></font>
<span class="mi">21</span>          <span class="p">{</span> <span class="p">...</span><a href="ref-programs-compute.html#%28reach._%28%28has.Random%29%29%29" class="nb" data-pltdoc="x">hasRandom</a><span class="p">,</span> <span class="c1">// &lt;--- new!</span>
<span class="mi">22</span>            <font class="badlink"><span class="nx">getHand</span></font><font class="badlink"><span class="o">:</span></font> <a href="ref-programs-compute.html#%28reach._%28%28.Fun%29%29%29" class="nb" data-pltdoc="x">Fun</a><span class="p">([],</span> <a href="ref-programs-compute.html#%28reach._%28%28.U.Int%29%29%29" class="nb" data-pltdoc="x">UInt</a><span class="p">),</span>
<span class="mi">23</span>            <font class="badlink"><span class="nx">seeOutcome</span></font><font class="badlink"><span class="o">:</span></font> <a href="ref-programs-compute.html#%28reach._%28%28.Fun%29%29%29" class="nb" data-pltdoc="x">Fun</a><span class="p">([</span><a href="ref-programs-compute.html#%28reach._%28%28.U.Int%29%29%29" class="nb" data-pltdoc="x">UInt</a><span class="p">],</span> <a href="ref-programs-compute.html#%28reach._%28%28.Null%29%29%29" class="nb" data-pltdoc="x">Null</a><span class="p">)</span> <span class="p">};</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div></div></p><p>The only line that is different is line 21, which includes <code class="highlight"><a href="ref-programs-compute.html#%28reach._%28%28has.Random%29%29%29" class="nb" data-pltdoc="x">hasRandom</a></code>, from the Reach standard library, in the interface.</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4/index.mjs#L20-L30"><span class="stt">tut-4/index.mjs</span></a><button class="btn" data-clipboard-text="  const Player = (Who) =&gt; ({
    ...stdlib.hasRandom, // &lt;--- new!
    getHand: () =&gt; {
      const hand = Math.floor(Math.random() * 3);
      console.log(`${Who} played ${HAND[hand]}`);
      return hand;
    },
    seeOutcome: (outcome) =&gt; {
      console.log(`${Who} saw outcome ${OUTCOME[outcome]}`);
    },
  });"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mf">20</span>    <font class="badlink"><span class="kd">const</span></font> <font class="badlink"><span class="nx">Player</span></font> <font class="badlink"><span class="o">=</span></font> <span class="p">(</span><font class="badlink"><span class="nx">Who</span></font><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">({</span>
<span class="mf">21</span>      <span class="p">...</span><a href="ref-backend-js.html#%28javascript._%28%28stdlib%29%29%29" class="nx" data-pltdoc="x">stdlib</a><span class="p">.</span><font class="badlink"><span class="nx">hasRandom</span></font><span class="p">,</span> <span class="c1">// &lt;--- new!</span>
<span class="mf">22</span>      <font class="badlink"><span class="nx">getHand</span></font><font class="badlink"><span class="o">:</span></font> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="mf">23</span>        <font class="badlink"><span class="kd">const</span></font> <font class="badlink"><span class="nx">hand</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nb">Math</span></font><span class="p">.</span><font class="badlink"><span class="nx">floor</span></font><span class="p">(</span><font class="badlink"><span class="nb">Math</span></font><span class="p">.</span><font class="badlink"><span class="nx">random</span></font><span class="p">()</span> <font class="badlink"><span class="o">*</span></font> <span class="mf">3</span><span class="p">);</span>
<span class="mf">24</span>        <font class="badlink"><span class="nx">console</span></font><span class="p">.</span><font class="badlink"><span class="nx">log</span></font><span class="p">(</span><span class="sb">`</span><span class="si">${</span><font class="badlink"><span class="nx">Who</span></font><span class="si">}</span><span class="sb"> played </span><span class="si">${</span><font class="badlink"><span class="nx">HAND</span></font><span class="p">[</span><font class="badlink"><span class="nx">hand</span></font><span class="p">]</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="mf">25</span>        <font class="badlink"><span class="k">return</span></font> <font class="badlink"><span class="nx">hand</span></font><span class="p">;</span>
<span class="mf">26</span>      <span class="p">},</span>
<span class="mf">27</span>      <font class="badlink"><span class="nx">seeOutcome</span></font><font class="badlink"><span class="o">:</span></font> <span class="p">(</span><font class="badlink"><span class="nx">outcome</span></font><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="mf">28</span>        <font class="badlink"><span class="nx">console</span></font><span class="p">.</span><font class="badlink"><span class="nx">log</span></font><span class="p">(</span><span class="sb">`</span><span class="si">${</span><font class="badlink"><span class="nx">Who</span></font><span class="si">}</span><span class="sb"> saw outcome </span><span class="si">${</span><font class="badlink"><span class="nx">OUTCOME</span></font><span class="p">[</span><font class="badlink"><span class="nx">outcome</span></font><span class="p">]</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="mf">29</span>      <span class="p">},</span>
<span class="mf">30</span>    <span class="p">});</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div></div></p><p>Similarly, we only need to modify one line of our JavaScript <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a>.
Line 21 allows each <a href="ref-model.html#%28tech._participant%29" class="techoutside" data-pltdoc="x"><span class="techinside">participant</span></a>&rsquo;s Reach code to generate random numbers as necessary.</p><p>These two changes might look identical, but they mean very different things.
The first, line 21 in the Reach program, adds <code class="highlight"><a href="ref-programs-compute.html#%28reach._%28%28has.Random%29%29%29" class="nb" data-pltdoc="x">hasRandom</a></code> to the interface that the <a href="ref-model.html#%28tech._backend%29" class="techoutside" data-pltdoc="x"><span class="techinside">backend</span></a> expects the <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a> to provide.
The second, line 21 in the JavaScript, adds <code class="highlight"><a href="ref-programs-compute.html#%28reach._%28%28has.Random%29%29%29" class="nb" data-pltdoc="x">hasRandom</a></code> to the implementation that the <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a> provides to the <a href="ref-model.html#%28tech._backend%29" class="techoutside" data-pltdoc="x"><span class="techinside">backend</span></a>.</p><p>We&rsquo;re now at the crucial juncture where we will implement the actual application and ensure that Alice&rsquo;s hand is protected until after Bob reveals his hand.
The simplest thing would be to have Alice just publish the wager, but this, of course, would just leave Bob vulnerable.
We need Alice to be able to publish her hand, but also keep it secret.
This is a job for a <a href="https://en.wikipedia.org/wiki/Commitment_scheme">cryptographic commitment scheme</a>.
Reach&rsquo;s standard library comes with <code class="highlight"><a href="ref-programs-local.html#%28reach._%28%28make.Commitment%29%29%29" class="nb" data-pltdoc="x">makeCommitment</a></code> to make this easier for you.</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4/index.rsh#L36-L42"><span class="stt">tut-4/index.rsh</span></a><button class="btn" data-clipboard-text="      A.only(() =&gt; {
        const _handA = interact.getHand();
        const [_commitA, _saltA] = makeCommitment(interact, _handA);
        const [wager, commitA] = declassify([interact.wager, _commitA]); });
      A.publish(wager, commitA)
        .pay(wager);
      commit();"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">36</span>    <font class="badlink"><span class="nx">A</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28only%29%29%29" class="k" data-pltdoc="x">only</a><span class="p">(()</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a> <span class="p">{</span>
<span class="mi">37</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">_handA</span></font> <font class="badlink"><span class="o">=</span></font> <a href="ref-programs-local.html#%28reach._%28%28interact%29%29%29" class="k" data-pltdoc="x">interact</a><span class="p">.</span><font class="badlink"><span class="nx">getHand</span></font><span class="p">();</span>
<span class="mi">38</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <span class="p">[</span><font class="badlink"><span class="nx">_commitA</span></font><span class="p">,</span> <font class="badlink"><span class="nx">_saltA</span></font><span class="p">]</span> <font class="badlink"><span class="o">=</span></font> <a href="ref-programs-local.html#%28reach._%28%28make.Commitment%29%29%29" class="nb" data-pltdoc="x">makeCommitment</a><span class="p">(</span><a href="ref-programs-local.html#%28reach._%28%28interact%29%29%29" class="k" data-pltdoc="x">interact</a><span class="p">,</span> <font class="badlink"><span class="nx">_handA</span></font><span class="p">);</span>
<span class="mi">39</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <span class="p">[</span><font class="badlink"><span class="nx">wager</span></font><span class="p">,</span> <font class="badlink"><span class="nx">commitA</span></font><span class="p">]</span> <font class="badlink"><span class="o">=</span></font> <a href="ref-programs-local.html#%28reach._%28%28declassify%29%29%29" class="k" data-pltdoc="x">declassify</a><span class="p">([</span><a href="ref-programs-local.html#%28reach._%28%28interact%29%29%29" class="k" data-pltdoc="x">interact</a><span class="p">.</span><font class="badlink"><span class="nx">wager</span></font><span class="p">,</span> <font class="badlink"><span class="nx">_commitA</span></font><span class="p">]);</span> <span class="p">});</span>
<span class="mi">40</span>    <font class="badlink"><span class="nx">A</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28publish%29%29%29" class="k" data-pltdoc="x">publish</a><span class="p">(</span><font class="badlink"><span class="nx">wager</span></font><span class="p">,</span> <font class="badlink"><span class="nx">commitA</span></font><span class="p">)</span>
<span class="mi">41</span>      <span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28pay%29%29%29" class="k" data-pltdoc="x">pay</a><span class="p">(</span><font class="badlink"><span class="nx">wager</span></font><span class="p">);</span>
<span class="mi">42</span>    <a href="ref-programs-consensus.html#%28reach._%28%28commit%29%29%29" class="k" data-pltdoc="x">commit</a><span class="p">();</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div></div></p><ul><li><p>Line 37 has Alice compute her hand, but <span class="emph">not</span> declassify it.</p></li><li><p>Line 38 has her compute a commitment to the hand.
It comes with a secret "salt" value that must be revealed later.</p></li><li><p>Line 39 has Alice declassify the commitment and her wager.</p></li><li><p>Line 40 has her publish them and with line 41 has her include the wager funds in the publication.</p></li></ul><p>At this point, we can state the <a href="ref-model.html#%28tech._knowledge._assertion%29" class="techoutside" data-pltdoc="x"><span class="techinside">knowledge assertion</span></a> that Bob can&rsquo;t know either the hand or the "salt" and continue with his part of the program.</p><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>It is important to include the salt in the commitment, so that multiple commitments to the same value are not identical.
Similarly, it is important not to share the salt until later, because if an attacker knows the set of possible values, they can enumerate them and compare with the result of the commitment and learn the value.</p></blockquote></blockquote></blockquote><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4/index.rsh#L44-L50"><span class="stt">tut-4/index.rsh</span></a><button class="btn" data-clipboard-text="      unknowable(B, A(_handA, _saltA));
      B.only(() =&gt; {
        interact.acceptWager(wager);
        const handB = declassify(interact.getHand()); });
      B.publish(handB)
        .pay(wager);
      commit();"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">44</span>    <a href="ref-programs-step.html#%28reach._%28%28unknowable%29%29%29" class="k" data-pltdoc="x">unknowable</a><span class="p">(</span><font class="badlink"><span class="nx">B</span></font><span class="p">,</span> <font class="badlink"><span class="nx">A</span></font><span class="p">(</span><font class="badlink"><span class="nx">_handA</span></font><span class="p">,</span> <font class="badlink"><span class="nx">_saltA</span></font><span class="p">));</span>
<span class="mi">45</span>    <font class="badlink"><span class="nx">B</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28only%29%29%29" class="k" data-pltdoc="x">only</a><span class="p">(()</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a> <span class="p">{</span>
<span class="mi">46</span>      <a href="ref-programs-local.html#%28reach._%28%28interact%29%29%29" class="k" data-pltdoc="x">interact</a><span class="p">.</span><font class="badlink"><span class="nx">acceptWager</span></font><span class="p">(</span><font class="badlink"><span class="nx">wager</span></font><span class="p">);</span>
<span class="mi">47</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">handB</span></font> <font class="badlink"><span class="o">=</span></font> <a href="ref-programs-local.html#%28reach._%28%28declassify%29%29%29" class="k" data-pltdoc="x">declassify</a><span class="p">(</span><a href="ref-programs-local.html#%28reach._%28%28interact%29%29%29" class="k" data-pltdoc="x">interact</a><span class="p">.</span><font class="badlink"><span class="nx">getHand</span></font><span class="p">());</span> <span class="p">});</span>
<span class="mi">48</span>    <font class="badlink"><span class="nx">B</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28publish%29%29%29" class="k" data-pltdoc="x">publish</a><span class="p">(</span><font class="badlink"><span class="nx">handB</span></font><span class="p">)</span>
<span class="mi">49</span>      <span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28pay%29%29%29" class="k" data-pltdoc="x">pay</a><span class="p">(</span><font class="badlink"><span class="nx">wager</span></font><span class="p">);</span>
<span class="mi">50</span>    <a href="ref-programs-consensus.html#%28reach._%28%28commit%29%29%29" class="k" data-pltdoc="x">commit</a><span class="p">();</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div></div></p><ul><li><p>Line 44 states the <a href="ref-model.html#%28tech._knowledge._assertion%29" class="techoutside" data-pltdoc="x"><span class="techinside">knowledge assertion</span></a>.</p></li><li><p>Lines 45 through 49 are unchanged from the original version.</p></li><li><p>Line 50 has the transaction commit, without computing the payout, because we can&rsquo;t yet, because Alice&rsquo;s hand is not yet public.</p></li></ul><p>We now return to Alice who can reveal her secrets.</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4/index.rsh#L52-L55"><span class="stt">tut-4/index.rsh</span></a><button class="btn" data-clipboard-text="      A.only(() =&gt; {
        const [saltA, handA] = declassify([_saltA, _handA]); });
      A.publish(saltA, handA);
      checkCommitment(commitA, saltA, handA);"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">52</span>    <font class="badlink"><span class="nx">A</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28only%29%29%29" class="k" data-pltdoc="x">only</a><span class="p">(()</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a> <span class="p">{</span>
<span class="mi">53</span>      <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <span class="p">[</span><font class="badlink"><span class="nx">saltA</span></font><span class="p">,</span> <font class="badlink"><span class="nx">handA</span></font><span class="p">]</span> <font class="badlink"><span class="o">=</span></font> <a href="ref-programs-local.html#%28reach._%28%28declassify%29%29%29" class="k" data-pltdoc="x">declassify</a><span class="p">([</span><font class="badlink"><span class="nx">_saltA</span></font><span class="p">,</span> <font class="badlink"><span class="nx">_handA</span></font><span class="p">]);</span> <span class="p">});</span>
<span class="mi">54</span>    <font class="badlink"><span class="nx">A</span></font><span class="p">.</span><a href="ref-programs-step.html#%28reach._%28%28publish%29%29%29" class="k" data-pltdoc="x">publish</a><span class="p">(</span><font class="badlink"><span class="nx">saltA</span></font><span class="p">,</span> <font class="badlink"><span class="nx">handA</span></font><span class="p">);</span>
<span class="mi">55</span>    <a href="ref-programs-consensus.html#%28reach._%28%28check.Commitment%29%29%29" class="nb" data-pltdoc="x">checkCommitment</a><span class="p">(</span><font class="badlink"><span class="nx">commitA</span></font><span class="p">,</span> <font class="badlink"><span class="nx">saltA</span></font><span class="p">,</span> <font class="badlink"><span class="nx">handA</span></font><span class="p">);</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div></div></p><ul><li><p>Line 53 has Alice declassify the secret information.</p></li><li><p>Line 54 has her publish it.</p></li><li><p>Line 55 checks that the published values match the original values.
This will always be the case with <a href="ref-model.html#%28tech._honest%29" class="techoutside" data-pltdoc="x"><span class="techinside">honest</span></a> participants, but dis<a href="ref-model.html#%28tech._honest%29" class="techoutside" data-pltdoc="x"><span class="techinside">honest</span></a> participants may violate this assumption.</p></li></ul><p>The rest of the program is unchanged from the original version, except that it uses the new names for the outcomes:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4/index.rsh#L57-L68"><span class="stt">tut-4/index.rsh</span></a><button class="btn" data-clipboard-text="      const outcome = winner(handA, handB);
      const [forA, forB] =
            outcome == A_WINS ? [2, 0] :
            outcome == B_WINS ? [0, 2] :
            [1, 1];
      transfer(forA * wager).to(A);
      transfer(forB * wager).to(B);
      commit();

      each([A, B], () =&gt; {
        interact.seeOutcome(outcome); });
      exit(); });"><img class="clippy" width="13" src="clippy.svg" alt="Copy to clipboard"> </img></button>&nbsp;</p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">57</span>    <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <font class="badlink"><span class="nx">outcome</span></font> <font class="badlink"><span class="o">=</span></font> <font class="badlink"><span class="nx">winner</span></font><span class="p">(</span><font class="badlink"><span class="nx">handA</span></font><span class="p">,</span> <font class="badlink"><span class="nx">handB</span></font><span class="p">);</span>
<span class="mi">58</span>    <a href="ref-programs-compute.html#%28reach._%28%28const%29%29%29" class="kd" data-pltdoc="x">const</a> <span class="p">[</span><font class="badlink"><span class="nx">forA</span></font><span class="p">,</span> <font class="badlink"><span class="nx">forB</span></font><span class="p">]</span> <font class="badlink"><span class="o">=</span></font>
<span class="mi">59</span>          <font class="badlink"><span class="nx">outcome</span></font> <a href="ref-programs-compute.html#%28reach._%28%28~3d~3d%29%29%29" class="o" data-pltdoc="x">==</a> <font class="badlink"><span class="nx">A_WINS</span></font> <a href="ref-programs-compute.html#%28reach._%28%28~3f%29%29%29" class="o" data-pltdoc="x">?</a> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <font class="badlink"><span class="o">:</span></font>
<span class="mi">60</span>          <font class="badlink"><span class="nx">outcome</span></font> <a href="ref-programs-compute.html#%28reach._%28%28~3d~3d%29%29%29" class="o" data-pltdoc="x">==</a> <font class="badlink"><span class="nx">B_WINS</span></font> <a href="ref-programs-compute.html#%28reach._%28%28~3f%29%29%29" class="o" data-pltdoc="x">?</a> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <font class="badlink"><span class="o">:</span></font>
<span class="mi">61</span>          <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">];</span>
<span class="mi">62</span>    <a href="ref-programs-consensus.html#%28reach._%28%28transfer%29%29%29" class="k" data-pltdoc="x">transfer</a><span class="p">(</span><font class="badlink"><span class="nx">forA</span></font> <a href="ref-programs-compute.html#%28reach._%28%28%2A%29%29%29" class="o" data-pltdoc="x">*</a> <font class="badlink"><span class="nx">wager</span></font><span class="p">).</span><font class="badlink"><span class="nx">to</span></font><span class="p">(</span><font class="badlink"><span class="nx">A</span></font><span class="p">);</span>
<span class="mi">63</span>    <a href="ref-programs-consensus.html#%28reach._%28%28transfer%29%29%29" class="k" data-pltdoc="x">transfer</a><span class="p">(</span><font class="badlink"><span class="nx">forB</span></font> <a href="ref-programs-compute.html#%28reach._%28%28%2A%29%29%29" class="o" data-pltdoc="x">*</a> <font class="badlink"><span class="nx">wager</span></font><span class="p">).</span><font class="badlink"><span class="nx">to</span></font><span class="p">(</span><font class="badlink"><span class="nx">B</span></font><span class="p">);</span>
<span class="mi">64</span>    <a href="ref-programs-consensus.html#%28reach._%28%28commit%29%29%29" class="k" data-pltdoc="x">commit</a><span class="p">();</span>
<span class="mi">65</span>    
<span class="mi">66</span>    <a href="ref-programs-step.html#%28reach._%28%28each%29%29%29" class="k" data-pltdoc="x">each</a><span class="p">([</span><font class="badlink"><span class="nx">A</span></font><span class="p">,</span> <font class="badlink"><span class="nx">B</span></font><span class="p">],</span> <span class="p">()</span> <a href="ref-programs-compute.html#%28reach._%28%28~3d._~3e%29%29%29" class="o" data-pltdoc="x">=&gt;</a> <span class="p">{</span>
<span class="mi">67</span>      <a href="ref-programs-local.html#%28reach._%28%28interact%29%29%29" class="k" data-pltdoc="x">interact</a><span class="p">.</span><font class="badlink"><span class="nx">seeOutcome</span></font><span class="p">(</span><font class="badlink"><span class="nx">outcome</span></font><span class="p">);</span> <span class="p">});</span>
<span class="mi">68</span>    <a href="ref-programs-step.html#%28reach._%28%28exit%29%29%29" class="k" data-pltdoc="x">exit</a><span class="p">();</span> <span class="p">});</span>
</pre></div></div></p><p>Since we didn&rsquo;t have to change the <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a> in any meaningful way, the output of running <span class="stt">./reach run</span> is still the same as it ever was:</p><p><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">$ ./reach run</span></p></td></tr><tr><td><p><span class="stt">Alice played Scissors</span></p></td></tr><tr><td><p><span class="stt">Bob accepts the wager of 5.</span></p></td></tr><tr><td><p><span class="stt">Bob played Paper</span></p></td></tr><tr><td><p><span class="stt">Bob saw outcome Alice wins</span></p></td></tr><tr><td><p><span class="stt">Alice saw outcome Alice wins</span></p></td></tr><tr><td><p><span class="stt">Alice went from 10 to 14.9999.</span></p></td></tr><tr><td><p><span class="stt">Bob went from 10 to 4.9999.</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">$ ./reach run</span></p></td></tr><tr><td><p><span class="stt">Alice played Paper</span></p></td></tr><tr><td><p><span class="stt">Bob accepts the wager of 5.</span></p></td></tr><tr><td><p><span class="stt">Bob played Scissors</span></p></td></tr><tr><td><p><span class="stt">Bob saw outcome Bob wins</span></p></td></tr><tr><td><p><span class="stt">Alice saw outcome Bob wins</span></p></td></tr><tr><td><p><span class="stt">Alice went from 10 to 4.9999.</span></p></td></tr><tr><td><p><span class="stt">Bob went from 10 to 14.9999.</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">$ ./reach run</span></p></td></tr><tr><td><p><span class="stt">Alice played Scissors</span></p></td></tr><tr><td><p><span class="stt">Bob accepts the wager of 5.</span></p></td></tr><tr><td><p><span class="stt">Bob played Scissors</span></p></td></tr><tr><td><p><span class="stt">Bob saw outcome Draw</span></p></td></tr><tr><td><p><span class="stt">Alice saw outcome Draw</span></p></td></tr><tr><td><p><span class="stt">Alice went from 10 to 9.9999.</span></p></td></tr><tr><td><p><span class="stt">Bob went from 10 to 9.9999.</span></p></td></tr></table></p><p>Except now, behind the scenes, and without any changes to the frontend, Alice now takes two steps in program and Bob only takes one, and she is protected against Bob finding her hand and using it to ensure he wins!</p><p>When we compile this version of the application, Reach&rsquo;s <a href="guide-assert.html" data-pltdoc="x">automatic formal verification</a> engine proves many theorems and protects us against a plethora of mistakes one might make when writing even a simple application like this.
Non-Reach programmers that try to write decentralized applications are on their own trying to ensure that these problems don&rsquo;t exist.</p><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>If your version isn&rsquo;t working, look at the complete versions of <a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4/index.rsh"><span class="stt">tut-4/index.rsh</span></a> and <a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4/index.mjs"><span class="stt">tut-4/index.mjs</span></a> to make sure you copied everything down correctly!</p></blockquote></blockquote></blockquote><p>Now our implementation of <span class="emph">Rock, Paper, Scissors!</span> is secure and doesn&rsquo;t contain any exploits for either Alice or Bob to guarantee a win.
However, it still has a final category of mistake that is common in decentralized applications: <a href="guide-timeout.html" data-pltdoc="x">non-participation</a>.
We&rsquo;ll fix this in <a href="tut-5.html" data-pltdoc="x">the next step</a>; make sure you don&rsquo;t launch with this version, or Alice may decide to back out of the game when she knows she&rsquo;s going to lose!</p><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>Check your understanding: True or false: Since blockchain programs run on a single, global, publicly-checked and certified consensus network, you don&#8217;t need to test them as much as normal software, which run on a wide variety of different platforms and operating systems.</p></blockquote></blockquote></blockquote><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>Check your understanding: True or false: It is easy to write correct programs that handle financial information, and even if you make a mistake, blockchains support an "Undo" operation that allows you to rollback to earlier versions of the ledger to correct mistakes and recover lost funds.</p></blockquote></blockquote></blockquote><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>Check your understanding: True or false: Reach provides automatic verifications to ensure that your program does not lose, lock away, or overspend funds and guarantees that your applications are free from entire categories of errors.</p></blockquote></blockquote></blockquote><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>Check your understanding: True or false: Reach provides tools for you to add custom verifications to your program, like ensuring that information is known only to one party, or that your implementation of a sensitive algorithm is correct.</p></blockquote></blockquote></blockquote><div class="navsetbottom"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="tut-3.html" title="backward to &quot;2.4 Bets and Wagers&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="tut.html" title="up to &quot;2 Tutorial&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="tut-5.html" title="forward to &quot;2.6 Timeouts and Participation&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div><script src="reach-post.js"></script></body></html>