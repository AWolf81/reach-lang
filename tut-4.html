<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>2.5&nbsp;Trust and Commitments</title><link rel="stylesheet" type="text/css" href="scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-racket.css" title="default"/><link rel="stylesheet" type="text/css" href="minted-solarizedlight-style.css" title="default"/><link rel="stylesheet" type="text/css" href="minted.css" title="default"/><script type="text/javascript" src="scribble-common.js"></script><script type="text/javascript" src="manual-racket.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--></head><body id="scribble-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9658;</a></td><td></td><td><a href="index.html" class="tocviewlink" data-pltdoc="x">Reach:<span class="mywbr"> &nbsp;</span> The Safest and Easiest DApp Programming Language</a></td></tr></table></div><div class="tocviewsublisttop" style="display: none;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="overview.html" class="tocviewlink" data-pltdoc="x">Overview</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="tut.html" class="tocviewselflink" data-pltdoc="x">Tutorial</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="guide.html" class="tocviewlink" data-pltdoc="x">Guide</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="workshop.html" class="tocviewlink" data-pltdoc="x">Workshop</a></td></tr><tr><td align="right">5&nbsp;</td><td><a href="ref.html" class="tocviewlink" data-pltdoc="x">Reference</a></td></tr><tr><td align="right"></td><td><a href="doc-index.html" class="tocviewlink" data-pltdoc="x">Index</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_1&quot;);">&#9660;</a></td><td>2&nbsp;</td><td><a href="tut.html" class="tocviewlink" data-pltdoc="x">Tutorial</a></td></tr></table><div class="tocviewsublistbottom" style="display: block;" id="tocview_1"><table cellspacing="0" cellpadding="0"><tr><td align="right">2.1&nbsp;</td><td><a href="tut-0.html" class="tocviewlink" data-pltdoc="x">Install and Initialize</a></td></tr><tr><td align="right">2.2&nbsp;</td><td><a href="tut-1.html" class="tocviewlink" data-pltdoc="x">Scaffolding and Setup</a></td></tr><tr><td align="right">2.3&nbsp;</td><td><a href="tut-2.html" class="tocviewlink" data-pltdoc="x">Rock, Paper, and Scissors</a></td></tr><tr><td align="right">2.4&nbsp;</td><td><a href="tut-3.html" class="tocviewlink" data-pltdoc="x">Bets and Wagers</a></td></tr><tr><td align="right">2.5&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Trust and Commitments</a></td></tr><tr><td align="right">2.6&nbsp;</td><td><a href="tut-5.html" class="tocviewlink" data-pltdoc="x">Timeouts and Participation</a></td></tr><tr><td align="right">2.7&nbsp;</td><td><a href="tut-6.html" class="tocviewlink" data-pltdoc="x">Play and Play Again</a></td></tr><tr><td align="right">2.8&nbsp;</td><td><a href="tut-7.html" class="tocviewlink" data-pltdoc="x">Interaction and Independence</a></td></tr><tr><td align="right">2.9&nbsp;</td><td><a href="tut-8.html" class="tocviewlink" data-pltdoc="x">Onward and Further</a></td></tr></table></div></div></div></div><div class="maincolumn"><div class="main"><div class="navsettop"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="tut-3.html" title="backward to &quot;2.4 Bets and Wagers&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="tut.html" title="up to &quot;2 Tutorial&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="tut-5.html" title="forward to &quot;2.6 Timeouts and Participation&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div><h4>2.5<tt>&nbsp;</tt><a name="(part._tut-4)"></a>Trust and Commitments</h4><p>In the last section, we made it so that Alice and Bob can actually exchange currency when they play <span class="emph">Rock, Paper, Scissors</span>.
However, the version of the application we wrote has a fundamental flaw: Bob can win every game!</p><p>How is that possible?
We showed executions of the game where Alice won, like the following</p><p><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">$ ./reach run</span></p></td></tr><tr><td><p><span class="stt">Alice played Rock</span></p></td></tr><tr><td><p><span class="stt">Bob accepts the wager of 5.0.</span></p></td></tr><tr><td><p><span class="stt">Bob played Scissors</span></p></td></tr><tr><td><p><span class="stt">Alice saw outcome Alice wins</span></p></td></tr><tr><td><p><span class="stt">Bob saw outcome Alice wins</span></p></td></tr><tr><td><p><span class="stt">Alice went from 10.0 to 14.999999999999687175.</span></p></td></tr><tr><td><p><span class="stt">Bob went from 10.0 to 4.999999999999978229.</span></p></td></tr></table></p><p>The problem is that these version of the game only executed an <a href="ref-model.html#%28tech._honest%29" class="techoutside" data-pltdoc="x"><span class="techinside">honest</span></a> version of Bob, that is, one that followed the Reach program exactly, including in his private <a href="ref-model.html#%28tech._local._step%29" class="techoutside" data-pltdoc="x"><span class="techinside">local steps</span></a>.
It is possible for a deviant and dis<a href="ref-model.html#%28tech._honest%29" class="techoutside" data-pltdoc="x"><span class="techinside">honest</span></a> version of a Bob <a href="ref-model.html#%28tech._backend%29" class="techoutside" data-pltdoc="x"><span class="techinside">backend</span></a> to execute different code and always win by computing the appropriate guess based on what value Alice provided for <code class="highlight-inline"><span class="nx">handA</span></code>.</p><p>If we change Bob&rsquo;s code to the following:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4-attack/index.rsh#L25-L29"><span class="stt">tut-4-attack/index.rsh</span></a></p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">25</span>    <span class="nx">B</span><span class="p">.</span><span class="k">only</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="mi">26</span>      <span class="k">interact</span><span class="p">.</span><span class="nx">acceptWager</span><span class="p">(</span><span class="nx">wager</span><span class="p">);</span>
<span class="mi">27</span>      <span class="kd">const</span> <span class="nx">handB</span> <span class="o">=</span> <span class="p">(</span><span class="nx">handA</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span><span class="p">;</span> <span class="p">});</span>
<span class="mi">28</span>    <span class="nx">B</span><span class="p">.</span><span class="k">publish</span><span class="p">(</span><span class="nx">handB</span><span class="p">)</span>
<span class="mi">29</span>      <span class="p">.</span><span class="k">pay</span><span class="p">(</span><span class="nx">wager</span><span class="p">);</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div>
</div></p><p>then he will ignore the <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a> and just compute the correct value.</p><p>If we run this version of the program, we will see output like this:</p><p><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">$ ./reach run</span></p></td></tr><tr><td><p><span class="stt">Alice played Scissors</span></p></td></tr><tr><td><p><span class="stt">Bob accepts the wager of 5.0.</span></p></td></tr><tr><td><p><span class="stt">Alice saw outcome Bob wins</span></p></td></tr><tr><td><p><span class="stt">Bob saw outcome Bob wins</span></p></td></tr><tr><td><p><span class="stt">Alice went from 10.0 to 4.999999999999683071.</span></p></td></tr><tr><td><p><span class="stt">Bob went from 10.0 to 14.999999999999978232.</span></p></td></tr></table></p><p>In this version, unlike the <a href="ref-model.html#%28tech._honest%29" class="techoutside" data-pltdoc="x"><span class="techinside">honest</span></a> version, Bob never consults the <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a> and so it never prints out the message of what hand Bob played.
No matter what Alice chooses, Bob will always win.</p><p><span style="font-weight: bold">&#8212;<wbr></wbr></span></p><p>In fact, Reach comes with an    <a href="guide-assert.html" data-pltdoc="x">automatic verification</a> engine that we can use to mathematically prove that this version will always result in the <code class="highlight-inline"><span class="nx">outcome</span></code> variable equalling <code class="highlight-inline"><span class="mi">0</span></code>, which means Bob wins.
We can instruct Reach to prove this theorem by add these lines after computing the <code class="highlight-inline"><span class="nx">outcome</span></code>:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4-attack/index.rsh#L31-L34"><span class="stt">tut-4-attack/index.rsh</span></a></p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">31</span>    <span class="kd">const</span> <span class="nx">outcome</span> <span class="o">=</span> <span class="p">(</span><span class="nx">handA</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="nx">handB</span><span class="p">))</span> <span class="o">%</span> <span class="mi">3</span><span class="p">;</span>
<span class="mi">32</span>    <span class="k">require</span><span class="p">(</span><span class="nx">handB</span> <span class="o">==</span> <span class="p">(</span><span class="nx">handA</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span><span class="p">);</span>
<span class="mi">33</span>    <span class="k">assert</span><span class="p">(</span><span class="nx">outcome</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="mi">34</span>    <span class="kd">const</span> <span class="p">[</span><span class="nx">forA</span><span class="p">,</span> <span class="nx">forB</span><span class="p">]</span> <span class="o">=</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div>
</div></p><ul><li><p>Line 32 requires that the dis<a href="ref-model.html#%28tech._honest%29" class="techoutside" data-pltdoc="x"><span class="techinside">honest</span></a> version of Bob be used for the proof.</p></li><li><p>Line 33 conducts the proof by including an <a href="ref-model.html#%28tech._assert%29" class="techoutside" data-pltdoc="x"><span class="techinside">assert</span></a> statement in the program.</p></li></ul><p>Before we had this line in the file, when we ran <span class="stt">./reach run</span>, it would print out the message:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-3/index.txt#L2-L7"><span class="stt">tut-3/index.txt</span></a></p></td></tr></table></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">..</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">// ...</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">2</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Verifying knowledge assertions</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">3</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Verifying with mode = VM_Honest</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">4</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Verifying with mode = VM_Dishonest RoleContract</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">5</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Verifying with mode = VM_Dishonest (RolePart "Alice")</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">6</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Verifying with mode = VM_Dishonest (RolePart "Bob")</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">7</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Checked 14 theorems; No failures!</span></p></td></tr><tr><td><p><span class="stt">..</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">// ...</span></p></td></tr></table></div></p><p>But now, it prints out</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4-attack/index.txt#L2-L7"><span class="stt">tut-4-attack/index.txt</span></a></p></td></tr></table></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">..</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">// ...</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">2</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Verifying knowledge assertions</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">3</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Verifying with mode = VM_Honest</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">4</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Verifying with mode = VM_Dishonest RoleContract</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">5</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Verifying with mode = VM_Dishonest (RolePart "Alice")</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">6</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Verifying with mode = VM_Dishonest (RolePart "Bob")</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">7</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Checked 19 theorems; No failures!</span></p></td></tr><tr><td><p><span class="stt">..</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">// ...</span></p></td></tr></table></div></p><ul><li><p>Line 7 is different and shows that more theorems have been proven about our program.
It prints out three more, rather than one more, because the theorem is proved differently in the different verification modes.</p></li></ul><p><span style="font-weight: bold">&#8212;<wbr></wbr></span></p><p>Many programming languages include <a href="https://en.wikipedia.org/wiki/Assertion_(software_development)">assertions</a> like this, but Reach is one of a small category where the compiler doesn&rsquo;t just insert a runtime check for the property, but actually conducts a mathematical proof at compile-time that the expression <span class="emph">always</span> evaluates to <code class="highlight-inline"><span class="kc">true</span></code>.</p><p>In this case, we used Reach&rsquo;s <a href="guide-assert.html" data-pltdoc="x">automatic verification</a> engine to prove that an attack did what we expected it would.
But, it is better to use verification to show that <span class="emph">no flaw</span> exists and <span class="emph">no attack</span> is possible.</p><p>Reach includes some such assertions automatically in every program.
That&rsquo;s why every version of <span class="emph">Rock, Paper, Scissors</span> has said that a number of theorems were checked.
We can see what these theorems do by deliberating inserting an error in the program.</p><p>Let&rsquo;s change the computation of the payout and make it so that if Alice wins, then she only gets her wager back, not Bob&rsquo;s.</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4-attack/index-bad.rsh#L34-L41"><span class="stt">tut-4-attack/index-bad.rsh</span></a></p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">34</span>    <span class="kd">const</span> <span class="p">[</span><span class="nx">forA</span><span class="p">,</span> <span class="nx">forB</span><span class="p">]</span> <span class="o">=</span>
<span class="mi">35</span>          <span class="c1">// was: outcome == 0 ? [0, 2] :</span>
<span class="mi">36</span>          <span class="nx">outcome</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="c1">// &lt;-- Oops</span>
<span class="mi">37</span>          <span class="nx">outcome</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">:</span>
<span class="mi">38</span>          <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">];</span>
<span class="mi">39</span>    <span class="k">transfer</span><span class="p">(</span><span class="nx">forA</span> <span class="o">*</span> <span class="nx">wager</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="nx">A</span><span class="p">);</span>
<span class="mi">40</span>    <span class="k">transfer</span><span class="p">(</span><span class="nx">forB</span> <span class="o">*</span> <span class="nx">wager</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="nx">B</span><span class="p">);</span>
<span class="mi">41</span>    <span class="k">commit</span><span class="p">();</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div>
</div></p><ul><li><p>Line 36 has <code class="highlight-inline"><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span></code>, but should have <code class="highlight-inline"><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span></code>.</p></li></ul><p>When we run <span class="stt">./reach compile </span><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4-attack/index-bad.rsh"><span class="stt">tut-4-attack/index-bad.rsh</span></a>, it gives details about the error:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4-attack/index-bad.txt#L4-L12"><span class="stt">tut-4-attack/index-bad.txt</span></a></p></td></tr></table></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">..</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt"></span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">4</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Verification failed:</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">5</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">in VM_Honest mode</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">6</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">of theorem TBalanceZero</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">7</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">at ./tut-4-attack/index-bad.rsh:45:11:application</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">8</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt"></span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">9</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Theorem formalization:</span></p></td></tr><tr><td><p><span class="stt">10</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">(= ctc_balance4 0 )</span></p></td></tr><tr><td><p><span class="stt">11</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt"></span></p></td></tr><tr><td><p><span class="stt">12</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">This could be violated if...</span></p></td></tr><tr><td><p><span class="stt">..</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt"></span></p></td></tr></table></div></p><p>There&rsquo;s a lot of information in the compiler output that can help an experienced programmer track down the problem. But the most important parts are</p><ul><li><p>Line 6 says that this is an attempt to prove the theorem that the balance at the end of the program is zero, which means that no <a href="ref-model.html#%28tech._network._token%29" class="techoutside" data-pltdoc="x"><span class="techinside">network tokens</span></a> are sealed in the <a href="ref-model.html#%28tech._contract%29" class="techoutside" data-pltdoc="x"><span class="techinside">contract</span></a> forever.</p></li><li><p>Line 7 says that this happens when the program exits on line 45, which directs the programmer to that path through the program.</p></li></ul><p>These kinds of <a href="guide-assert.html" data-pltdoc="x">automatic verifications</a> are helpful for Reach programmers, because they don&rsquo;t need to remember to put them in their program, and they will still be protected from entire categories of errors.</p><p><span style="font-weight: bold">&#8212;<wbr></wbr></span></p><p>However, now let&rsquo;s add an <a href="ref-model.html#%28tech._assert%29" class="techoutside" data-pltdoc="x"><span class="techinside">assert</span></a>ion to the program that will ensure that every version of the program that allows Bob to know Alice&rsquo;s hand before he chooses his own will be rejected.</p><p>We&rsquo;ll go back to the version of <a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-3/index.rsh"><span class="stt">tut-3/index.rsh</span></a> from the last section, which has an <a href="ref-model.html#%28tech._honest%29" class="techoutside" data-pltdoc="x"><span class="techinside">honest</span></a> version of Bob.
(Click on the preceeding link if you need to see what it contained.)</p><p>We&rsquo;ll add a single line to the program after Alice publishes, but before Bob takes a <a href="ref-model.html#%28tech._local._step%29" class="techoutside" data-pltdoc="x"><span class="techinside">local step</span></a>:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4-attack/index-fails.rsh#L21-L28"><span class="stt">tut-4-attack/index-fails.rsh</span></a></p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">21</span>    <span class="nx">A</span><span class="p">.</span><span class="k">publish</span><span class="p">(</span><span class="nx">wager</span><span class="p">,</span> <span class="nx">handA</span><span class="p">)</span>
<span class="mi">22</span>      <span class="p">.</span><span class="k">pay</span><span class="p">(</span><span class="nx">wager</span><span class="p">);</span>
<span class="mi">23</span>    <span class="k">commit</span><span class="p">();</span>
<span class="mi">24</span>    
<span class="mi">25</span>    <span class="k">unknowable</span><span class="p">(</span><span class="nx">B</span><span class="p">,</span> <span class="nx">A</span><span class="p">(</span><span class="nx">handA</span><span class="p">));</span>
<span class="mi">26</span>    <span class="nx">B</span><span class="p">.</span><span class="k">only</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="mi">27</span>      <span class="k">interact</span><span class="p">.</span><span class="nx">acceptWager</span><span class="p">(</span><span class="nx">wager</span><span class="p">);</span>
<span class="mi">28</span>      <span class="kd">const</span> <span class="nx">handB</span> <span class="o">=</span> <span class="k">declassify</span><span class="p">(</span><span class="k">interact</span><span class="p">.</span><span class="nx">getHand</span><span class="p">());</span> <span class="p">});</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div>
</div></p><ul><li><p>Line 25 contains a <a href="ref-model.html#%28tech._knowledge._assertion%29" class="techoutside" data-pltdoc="x"><span class="techinside">knowledge assertion</span></a> that Bob cannot know Alice&rsquo;s value <code class="highlight-inline"><span class="nx">handA</span></code> at this point in the program.
In this case, it is obvious that this is not true, because Alice shares <code class="highlight-inline"><span class="nx">handA</span></code> at line 21.
In many cases, this is not obvious and Reach&rsquo;s <a href="guide-assert.html" data-pltdoc="x">automatic verification</a> engine has to reason about how values that Bob <span class="emph">does know</span> are connected to values that might be related to Alice&rsquo;s secret values.</p></li></ul><p>When we run <span class="stt">./reach run</span>, it reports that this assertion is false:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4-attack/index-fails.txt#L3-L5"><span class="stt">tut-4-attack/index-fails.txt</span></a></p></td></tr></table></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">..</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt"></span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">3</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">Verification failed:</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">4</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">of theorem unknowable("Bob", v1)</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span><span class="stt">5</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">at ./tut-4-attack/index-fails.rsh:25:17:application</span></p></td></tr><tr><td><p><span class="stt">..</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt"></span></p></td></tr></table></div></p><p>It is not enough to correct failures and attacks when you discover them.
You must <span style="font-weight: bold">always</span> add an assertion to your program that would fail to hold if the attack or failure were present.
This ensures that all similar attacks are not present and that they will not accidentally be reintroduced.</p><p><span style="font-weight: bold">&#8212;<wbr></wbr></span></p><p>Let&rsquo;s use these insights into <a href="guide-assert.html" data-pltdoc="x">automatic verification</a> and rewrite our <span class="emph">Rock, Paper, Scissors</span> so that it is more trustworthy and secure.</p><p>Since we&rsquo;ve been making lots of changes to the code, let&rsquo;s start fresh with a new version and we&rsquo;ll look at every single line again, to make sure that you aren&rsquo;t missing anything.</p><p>First, we&rsquo;ll define the rules of <span class="emph">Rock, Paper, Scissors</span> a little bit more abstractly, so we can separate the logic of the game from the details of the application:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4/index.rsh#L1-L7"><span class="stt">tut-4/index.rsh</span></a></p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span> <span class="mi">1</span>    <span class="s1">&#39;reach 0.1&#39;</span><span class="p">;</span>
 <span class="mi">2</span>    
 <span class="mi">3</span>    <span class="kd">const</span> <span class="p">[</span> <span class="nx">isHand</span><span class="p">,</span> <span class="nx">ROCK</span><span class="p">,</span> <span class="nx">PAPER</span><span class="p">,</span> <span class="nx">SCISSORS</span> <span class="p">]</span> <span class="o">=</span> <span class="nb">makeEnum</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
 <span class="mi">4</span>    <span class="kd">const</span> <span class="p">[</span> <span class="nx">isOutcome</span><span class="p">,</span> <span class="nx">B_WINS</span><span class="p">,</span> <span class="nx">DRAW</span><span class="p">,</span> <span class="nx">A_WINS</span> <span class="p">]</span> <span class="o">=</span> <span class="nb">makeEnum</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
 <span class="mi">5</span>    
 <span class="mi">6</span>    <span class="kd">const</span> <span class="nx">winner</span> <span class="o">=</span> <span class="p">(</span><span class="nx">handA</span><span class="p">,</span> <span class="nx">handB</span><span class="p">)</span> <span class="p">=&gt;</span>
 <span class="mi">7</span>          <span class="p">((</span><span class="nx">handA</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="nx">handB</span><span class="p">))</span> <span class="o">%</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div>
</div></p><ul><li><p>Line 1 is the usual Reach version header.</p></li><li><p>Lines 3 and 4 define <a href="ref-programs-compute.html#%28tech._enumeration%29" class="techoutside" data-pltdoc="x"><span class="techinside">enumeration</span></a>s for the hands that may be played, as well as the outcomes of the game.</p></li><li><p>Lines 6 and 7 define the function that computes the winner of the game.</p></li></ul><p>When we first wrote <span class="emph">Rock, Paper, Scissors</span>, we asked you to trust that this formula for computing the winner is correct, but is good to actually check.
One way to check would be to implement a JavaScript <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a> that didn&rsquo;t interact with a real user, nor would it randomly generate values, but instead, it would return specific testing scenario values and check that the output is as expected.
That&rsquo;s a typical way to debug and is possible with Reach.
However, Reach allows us to write such test cases directly into the Reach program as verification assertions.</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4/index.rsh#L9-L11"><span class="stt">tut-4/index.rsh</span></a></p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
 <span class="mi">9</span>    <span class="k">assert</span><span class="p">(</span><span class="nx">winner</span><span class="p">(</span><span class="nx">ROCK</span><span class="p">,</span> <span class="nx">PAPER</span><span class="p">)</span> <span class="o">==</span> <span class="nx">B_WINS</span><span class="p">);</span>
<span class="mi">10</span>    <span class="k">assert</span><span class="p">(</span><span class="nx">winner</span><span class="p">(</span><span class="nx">PAPER</span><span class="p">,</span> <span class="nx">ROCK</span><span class="p">)</span> <span class="o">==</span> <span class="nx">A_WINS</span><span class="p">);</span>
<span class="mi">11</span>    <span class="k">assert</span><span class="p">(</span><span class="nx">winner</span><span class="p">(</span><span class="nx">ROCK</span><span class="p">,</span> <span class="nx">ROCK</span><span class="p">)</span> <span class="o">==</span> <span class="nx">DRAW</span><span class="p">);</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div>
</div></p><ul><li><p>Line 9 makes an <a href="ref-model.html#%28tech._assert%29" class="techoutside" data-pltdoc="x"><span class="techinside">assert</span></a>ion that when Alice plays Rock and Bob plays Paper, then Bob wins as expected.</p></li></ul><p>But, Reach&rsquo;s <a href="guide-assert.html" data-pltdoc="x">automatic verification</a> allows us to express even more powerful statements about our program&rsquo;s behavior.
For example, we can state that no matter what values are provided for <code class="highlight-inline"><span class="nx">handA</span></code> and <code class="highlight-inline"><span class="nx">handB</span></code>, <code class="highlight-inline"><span class="nx">winner</span></code> will always provide a valid outcome:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4/index.rsh#L13-L15"><span class="stt">tut-4/index.rsh</span></a></p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">13</span>    <span class="k">forall</span><span class="p">(</span><span class="nb">UInt256</span><span class="p">,</span> <span class="nx">handA</span> <span class="p">=&gt;</span>
<span class="mi">14</span>      <span class="k">forall</span><span class="p">(</span><span class="nb">UInt256</span><span class="p">,</span> <span class="nx">handB</span> <span class="p">=&gt;</span>
<span class="mi">15</span>        <span class="k">assert</span><span class="p">(</span><span class="nx">isOutcome</span><span class="p">(</span><span class="nx">winner</span><span class="p">(</span><span class="nx">handA</span><span class="p">,</span> <span class="nx">handB</span><span class="p">)))));</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div>
</div></p><p>And we can specify that whenever the same value is provided for both hands, no matter what it is, <code class="highlight-inline"><span class="nx">winner</span></code> always returns <code class="highlight-inline"><span class="nx">DRAW</span></code>:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4/index.rsh#L17-L18"><span class="stt">tut-4/index.rsh</span></a></p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">17</span>    <span class="k">forall</span><span class="p">(</span><span class="nb">UInt256</span><span class="p">,</span> <span class="p">(</span><span class="nx">hand</span><span class="p">)</span> <span class="p">=&gt;</span>
<span class="mi">18</span>      <span class="k">assert</span><span class="p">(</span><span class="nx">winner</span><span class="p">(</span><span class="nx">hand</span><span class="p">,</span> <span class="nx">hand</span><span class="p">)</span> <span class="o">==</span> <span class="nx">DRAW</span><span class="p">));</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div>
</div></p><p>These examples both use <code class="highlight-inline"><span class="k">forall</span></code>, which allows Reach programmers to quantify over all possible values that might be provided to a part of their program.</p><p>Let&rsquo;s continue the program by specifying the <a href="ref-programs-module.html#%28tech._participant._interact._interface%29" class="techoutside" data-pltdoc="x"><span class="techinside">participant interact interface</span></a>s for Alice and Bob.
These will be mostly the same as before, except that we will also expect that each <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a> can provide access to random numbers.
We&rsquo;ll use these later on to protect Alice&rsquo;s hand.</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4/index.rsh#L20-L35"><span class="stt">tut-4/index.rsh</span></a></p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">20</span>    <span class="kd">const</span> <span class="nx">Player</span> <span class="o">=</span>
<span class="mi">21</span>          <span class="p">{</span> <span class="p">...</span><span class="nb">hasRandom</span><span class="p">,</span>
<span class="mi">22</span>            <span class="nx">getHand</span><span class="o">:</span> <span class="nb">Fun</span><span class="p">([],</span> <span class="nb">UInt256</span><span class="p">),</span>
<span class="mi">23</span>            <span class="nx">seeOutcome</span><span class="o">:</span> <span class="nb">Fun</span><span class="p">([</span><span class="nb">UInt256</span><span class="p">],</span> <span class="nb">Null</span><span class="p">)</span> <span class="p">};</span>
<span class="mi">24</span>    <span class="kd">const</span> <span class="nx">Alice</span> <span class="o">=</span>
<span class="mi">25</span>          <span class="p">{</span> <span class="p">...</span><span class="nx">Player</span><span class="p">,</span>
<span class="mi">26</span>            <span class="nx">wager</span><span class="o">:</span> <span class="nb">UInt256</span> <span class="p">};</span>
<span class="mi">27</span>    <span class="kd">const</span> <span class="nx">Bob</span> <span class="o">=</span>
<span class="mi">28</span>          <span class="p">{</span> <span class="p">...</span><span class="nx">Player</span><span class="p">,</span>
<span class="mi">29</span>            <span class="nx">acceptWager</span><span class="o">:</span> <span class="nb">Fun</span><span class="p">([</span><span class="nb">UInt256</span><span class="p">],</span> <span class="nb">Null</span><span class="p">)</span> <span class="p">};</span>
<span class="mi">30</span>    
<span class="mi">31</span>    <span class="kd">export</span> <span class="kd">const</span> <span class="nx">main</span> <span class="o">=</span>
<span class="mi">32</span>      <span class="nb">Reach</span><span class="p">.</span><span class="nb">App</span><span class="p">(</span>
<span class="mi">33</span>        <span class="p">{},</span>
<span class="mi">34</span>        <span class="p">[[</span><span class="s1">&#39;Alice&#39;</span><span class="p">,</span> <span class="nx">Alice</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Bob&#39;</span><span class="p">,</span> <span class="nx">Bob</span><span class="p">]],</span>
<span class="mi">35</span>        <span class="p">(</span><span class="nx">A</span><span class="p">,</span> <span class="nx">B</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div>
</div></p><p>The only line that is different is line 21, which includes <code class="highlight-inline"><span class="nb">hasRandom</span></code>, from the Reach standard library, in the interface.</p><p>This is the source of the only line that needs to change in our JavaScript <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a> as well:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4/index.mjs#L18-L24"><span class="stt">tut-4/index.mjs</span></a></p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">18</span>    <span class="kr">const</span> <span class="nx">Player</span> <span class="o">=</span> <span class="p">(</span><span class="nx">Who</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">({</span>
<span class="mi">19</span>      <span class="p">...</span><span class="nx">stdlib</span><span class="p">.</span><span class="nx">hasRandom</span><span class="p">,</span>
<span class="mi">20</span>      <span class="nx">getHand</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="kr">const</span> <span class="nx">hand</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">3</span><span class="p">);</span>
<span class="mi">21</span>                       <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">Who</span><span class="si">}</span><span class="sb"> played </span><span class="si">${</span><span class="nx">HAND</span><span class="p">[</span><span class="nx">hand</span><span class="p">]</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="mi">22</span>                       <span class="k">return</span> <span class="nx">hand</span><span class="p">;</span> <span class="p">},</span>
<span class="mi">23</span>      <span class="nx">seeOutcome</span><span class="o">:</span> <span class="p">(</span><span class="nx">outcome</span><span class="p">)</span> <span class="p">=&gt;</span>
<span class="mi">24</span>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">Who</span><span class="si">}</span><span class="sb"> saw outcome </span><span class="si">${</span><span class="nx">OUTCOME</span><span class="p">[</span><span class="nx">outcome</span><span class="p">]</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span> <span class="p">});</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div>
</div></p><p>This line of JavaScript allows each <a href="ref-model.html#%28tech._participant%29" class="techoutside" data-pltdoc="x"><span class="techinside">participant</span></a>&rsquo;s Reach code to generate random numbers as necessary.</p><p>We&rsquo;re now at the crucial juncture where we will implement the actual application and ensure that Alice&rsquo;s hand is protected until after Bob reveals his hand.
The simplest thing would be to have Alice just publish the wager, but this, of course, would just leave Bob vulnerable.
We need to Alice to be able to publish her hand, but also keep it secret.
This is a job for a <a href="https://en.wikipedia.org/wiki/Commitment_scheme">cryptographic commitment scheme</a>.
Reach&rsquo;s standard library comes with <code class="highlight-inline"><span class="nb">makeCommitment</span></code> to make this easier for you.</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4/index.rsh#L36-L42"><span class="stt">tut-4/index.rsh</span></a></p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">36</span>    <span class="nx">A</span><span class="p">.</span><span class="k">only</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="mi">37</span>      <span class="kd">const</span> <span class="nx">_handA</span> <span class="o">=</span> <span class="k">interact</span><span class="p">.</span><span class="nx">getHand</span><span class="p">();</span>
<span class="mi">38</span>      <span class="kd">const</span> <span class="p">[</span><span class="nx">_commitA</span><span class="p">,</span> <span class="nx">_saltA</span><span class="p">]</span> <span class="o">=</span> <span class="nb">makeCommitment</span><span class="p">(</span><span class="k">interact</span><span class="p">,</span> <span class="nx">_handA</span><span class="p">);</span>
<span class="mi">39</span>      <span class="kd">const</span> <span class="p">[</span><span class="nx">wager</span><span class="p">,</span> <span class="nx">commitA</span><span class="p">]</span> <span class="o">=</span> <span class="k">declassify</span><span class="p">([</span><span class="k">interact</span><span class="p">.</span><span class="nx">wager</span><span class="p">,</span> <span class="nx">_commitA</span><span class="p">]);</span> <span class="p">});</span>
<span class="mi">40</span>    <span class="nx">A</span><span class="p">.</span><span class="k">publish</span><span class="p">(</span><span class="nx">wager</span><span class="p">,</span> <span class="nx">commitA</span><span class="p">)</span>
<span class="mi">41</span>      <span class="p">.</span><span class="k">pay</span><span class="p">(</span><span class="nx">wager</span><span class="p">);</span>
<span class="mi">42</span>    <span class="k">commit</span><span class="p">();</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div>
</div></p><ul><li><p>Line 37 has Alice compute her hand, but <span class="emph">not</span> declassify it.</p></li><li><p>Line 38 has her compute a commitment to the hand.
It comes with a secret "salt" value that must be revealed later.</p></li><li><p>Line 39 has Alice declassify the commitment and her wager.</p></li><li><p>Line 40 has her publish them and with line 41 has her include the wager funds in the publication.</p></li></ul><p>At this point, we can state the <a href="ref-model.html#%28tech._knowledge._assertion%29" class="techoutside" data-pltdoc="x"><span class="techinside">knowledge assertion</span></a> that Bob can&rsquo;t know either the hand or the "salt" and continue with his part of the program.</p><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>It is important to include the salt in the commitment, so that multiple commitments to the same value are not identical.
Similarly, it is important not to share the salt until later, because if an attacker knows the set of possible values, they can enumerate them and compare with the result of the commitment and learn the value.</p></blockquote></blockquote></blockquote><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4/index.rsh#L44-L50"><span class="stt">tut-4/index.rsh</span></a></p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">44</span>    <span class="k">unknowable</span><span class="p">(</span><span class="nx">B</span><span class="p">,</span> <span class="nx">A</span><span class="p">(</span><span class="nx">_handA</span><span class="p">,</span> <span class="nx">_saltA</span><span class="p">));</span>
<span class="mi">45</span>    <span class="nx">B</span><span class="p">.</span><span class="k">only</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="mi">46</span>      <span class="k">interact</span><span class="p">.</span><span class="nx">acceptWager</span><span class="p">(</span><span class="nx">wager</span><span class="p">);</span>
<span class="mi">47</span>      <span class="kd">const</span> <span class="nx">handB</span> <span class="o">=</span> <span class="k">declassify</span><span class="p">(</span><span class="k">interact</span><span class="p">.</span><span class="nx">getHand</span><span class="p">());</span> <span class="p">});</span>
<span class="mi">48</span>    <span class="nx">B</span><span class="p">.</span><span class="k">publish</span><span class="p">(</span><span class="nx">handB</span><span class="p">)</span>
<span class="mi">49</span>      <span class="p">.</span><span class="k">pay</span><span class="p">(</span><span class="nx">wager</span><span class="p">);</span>
<span class="mi">50</span>    <span class="k">commit</span><span class="p">();</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div>
</div></p><ul><li><p>Line 44 states the <a href="ref-model.html#%28tech._knowledge._assertion%29" class="techoutside" data-pltdoc="x"><span class="techinside">knowledge assertion</span></a>.</p></li><li><p>Lines 45 through 49 are unchanged from the original version.</p></li><li><p>Line 50 has the transaction commit, without computing the payout, because we can&rsquo;t yet, because Alice&rsquo;s hand is not yet public.</p></li></ul><p>We now return to Alice who can reveal her secrets.</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4/index.rsh#L52-L55"><span class="stt">tut-4/index.rsh</span></a></p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">52</span>    <span class="nx">A</span><span class="p">.</span><span class="k">only</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="mi">53</span>      <span class="kd">const</span> <span class="p">[</span><span class="nx">saltA</span><span class="p">,</span> <span class="nx">handA</span><span class="p">]</span> <span class="o">=</span> <span class="k">declassify</span><span class="p">([</span><span class="nx">_saltA</span><span class="p">,</span> <span class="nx">_handA</span><span class="p">]);</span> <span class="p">});</span>
<span class="mi">54</span>    <span class="nx">A</span><span class="p">.</span><span class="k">publish</span><span class="p">(</span><span class="nx">saltA</span><span class="p">,</span> <span class="nx">handA</span><span class="p">);</span>
<span class="mi">55</span>    <span class="nb">checkCommitment</span><span class="p">(</span><span class="nx">commitA</span><span class="p">,</span> <span class="nx">saltA</span><span class="p">,</span> <span class="nx">handA</span><span class="p">);</span>
<span class="p">..</span>    <span class="c1">// ...</span>
</pre></div>
</div></p><ul><li><p>Line 53 has Alice declassify the secret information.</p></li><li><p>Line 54 has her publish it.</p></li><li><p>Line 55 checks that the published values match the original values.
This will always be the case with <a href="ref-model.html#%28tech._honest%29" class="techoutside" data-pltdoc="x"><span class="techinside">honest</span></a> participants, but dis<a href="ref-model.html#%28tech._honest%29" class="techoutside" data-pltdoc="x"><span class="techinside">honest</span></a> participants may violate this assumption.</p></li></ul><p>The rest of the program is unchanged from the original version, except that it uses the new names for the outcomes:</p><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4/index.rsh#L57-L68"><span class="stt">tut-4/index.rsh</span></a></p></td></tr></table></div><div class="SIntrapara"><div class="highlight"><pre><span></span><span class="p">..</span>    <span class="c1">// ...</span>
<span class="mi">57</span>    <span class="kd">const</span> <span class="nx">outcome</span> <span class="o">=</span> <span class="nx">winner</span><span class="p">(</span><span class="nx">handA</span><span class="p">,</span> <span class="nx">handB</span><span class="p">);</span>
<span class="mi">58</span>    <span class="kd">const</span> <span class="p">[</span><span class="nx">forA</span><span class="p">,</span> <span class="nx">forB</span><span class="p">]</span> <span class="o">=</span>
<span class="mi">59</span>          <span class="nx">outcome</span> <span class="o">==</span> <span class="nx">A_WINS</span> <span class="o">?</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">:</span>
<span class="mi">60</span>          <span class="nx">outcome</span> <span class="o">==</span> <span class="nx">B_WINS</span> <span class="o">?</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">:</span>
<span class="mi">61</span>          <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">];</span>
<span class="mi">62</span>    <span class="k">transfer</span><span class="p">(</span><span class="nx">forA</span> <span class="o">*</span> <span class="nx">wager</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="nx">A</span><span class="p">);</span>
<span class="mi">63</span>    <span class="k">transfer</span><span class="p">(</span><span class="nx">forB</span> <span class="o">*</span> <span class="nx">wager</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="nx">B</span><span class="p">);</span>
<span class="mi">64</span>    <span class="k">commit</span><span class="p">();</span>
<span class="mi">65</span>    
<span class="mi">66</span>    <span class="nx">each</span><span class="p">([</span><span class="nx">A</span><span class="p">,</span> <span class="nx">B</span><span class="p">],</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="mi">67</span>      <span class="k">interact</span><span class="p">.</span><span class="nx">seeOutcome</span><span class="p">(</span><span class="nx">outcome</span><span class="p">);</span> <span class="p">});</span>
<span class="mi">68</span>    <span class="k">exit</span><span class="p">();</span> <span class="p">});</span>
</pre></div>
</div></p><p>Since we didn&rsquo;t have to change the <a href="ref-model.html#%28tech._frontend%29" class="techoutside" data-pltdoc="x"><span class="techinside">frontend</span></a> in any meaningful way, the output of running <span class="stt">./reach run</span> is still the same as it ever was:</p><p><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">$ ./reach run</span></p></td></tr><tr><td><p><span class="stt">Alice played Scissors</span></p></td></tr><tr><td><p><span class="stt">Bob accepts the wager of 5.0.</span></p></td></tr><tr><td><p><span class="stt">Bob played Paper</span></p></td></tr><tr><td><p><span class="stt">Bob saw outcome Alice wins</span></p></td></tr><tr><td><p><span class="stt">Alice saw outcome Alice wins</span></p></td></tr><tr><td><p><span class="stt">Alice went from 10.0 to 14.999999999999553643.</span></p></td></tr><tr><td><p><span class="stt">Bob went from 10.0 to 4.999999999999969352.</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">$ ./reach run</span></p></td></tr><tr><td><p><span class="stt">Alice played Paper</span></p></td></tr><tr><td><p><span class="stt">Bob accepts the wager of 5.0.</span></p></td></tr><tr><td><p><span class="stt">Bob played Scissors</span></p></td></tr><tr><td><p><span class="stt">Bob saw outcome Bob wins</span></p></td></tr><tr><td><p><span class="stt">Alice saw outcome Bob wins</span></p></td></tr><tr><td><p><span class="stt">Alice went from 10.0 to 4.999999999999553626.</span></p></td></tr><tr><td><p><span class="stt">Bob went from 10.0 to 14.999999999999969352.</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;</span></p></td></tr><tr><td><p><span class="stt">$ ./reach run</span></p></td></tr><tr><td><p><span class="stt">Alice played Scissors</span></p></td></tr><tr><td><p><span class="stt">Bob accepts the wager of 5.0.</span></p></td></tr><tr><td><p><span class="stt">Bob played Scissors</span></p></td></tr><tr><td><p><span class="stt">Bob saw outcome Draw</span></p></td></tr><tr><td><p><span class="stt">Alice saw outcome Draw</span></p></td></tr><tr><td><p><span class="stt">Alice went from 10.0 to 9.999999999999550271.</span></p></td></tr><tr><td><p><span class="stt">Bob went from 10.0 to 9.999999999999969352.</span></p></td></tr></table></p><p>Except now, behind the scenes, and without any changes to the frontend, Alice now takes two steps in program and Bob only takes one, and she is protected against Bob finding her hand and using it to ensure he wins!</p><p>When we compile this version of the application, Reach&rsquo;s <a href="guide-assert.html" data-pltdoc="x">automatic formal verification</a> engine proves many theorems and protects us against a plethora of mistakes one might make when writing even a simple application like this.
Non-Reach programmers that try to write decentralized applications are on their own trying to ensure that these problems don&rsquo;t exist.</p><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>If your version isn&rsquo;t working, look at the complete versions of <a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4/index.rsh"><span class="stt">tut-4/index.rsh</span></a> and <a href="https://github.com/reach-sh/reach-lang/blob/master/examples/tut-4/index.mjs"><span class="stt">tut-4/index.mjs</span></a> to make sure you copied everything down correctly!</p></blockquote></blockquote></blockquote><p>Now our implementation of <span class="emph">Rock, Paper, Scissors</span> is secure and doesn&rsquo;t contain any exploits for either Alice or Bob to guarantee a win.
However, it still has a final category of mistake that is common in decentralized applications: <a href="guide-timeout.html" data-pltdoc="x">non-participation</a>.
We&rsquo;ll fix this in <a href="tut-5.html" data-pltdoc="x">the next step</a>; make sure you don&rsquo;t launch with this version, or Alice may decide to back out of the game when she knows she&rsquo;s going to lose!</p><div class="navsetbottom"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="tut-3.html" title="backward to &quot;2.4 Bets and Wagers&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="tut.html" title="up to &quot;2 Tutorial&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="tut-5.html" title="forward to &quot;2.6 Timeouts and Participation&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div></body></html>